!function(e){!function(e,t,n){function i(e){if("string"==typeof e)return e;var t=[];for(var n in e)t.push(encodeURIComponent(n)+"="+encodeURIComponent(e[n]));return t.join("&").replace(/\+/g,"%20")}function o(e,t){return t?d.hasCapabilities("classList")?e.classList.contains(t):e.className.indexOf(t)>-1:!1}function r(e,t){if(t&&0!==t.length&&1===e.nodeType){var n=t.length,i=0;if(d.hasCapabilities("classList"))for(;n>i;++i)e.classList.toggle(t[i]);else{for(var r=(" "+e.className+" ").replace(/[\s+]/," ");n>i;++i)o(e,t[i])?r=r.replace(" "+t[i]+" "," "):r+=t[i]+" ";e.className=d.trim(r)}}}function s(e,t){if(t&&0!==t.length&&1===e.nodeType){var n=t.length,i=0;if(d.hasCapabilities("classList"))for(;n>i;++i)e.classList.add(t[i]);else if(e.className||1!==t.length){for(var o=" "+e.className+" ";n>i;++i)~o.indexOf(" "+t[i]+" ")||(o+=t[i]+" ");e.className=d.trim(o)}else e.className=t.join(" ")}}function a(e,t){if(t&&0!==t.length&&1===e.nodeType){var n=t.length,i=0;if(d.hasCapabilities("classList"))for(;n>i;++i)e.classList.remove(t[i]);else{for(var o=(" "+e.className+" ").replace(/[\s+]/," ");n>i;++i)o=o.replace(" "+t[i]+" "," ");e.className=d.trim(o)}}}var c=Array.prototype.slice,u=/^#([\w-]*)$/,t=function(n,i){var o=[];if("string"==typeof n){var r=u.exec(n);if(i=i||document,r&&r[1]){var s=i.getElementById(r[1]);s&&o.push(s)}else o=i.querySelectorAll(n)}else n.nodeType||e.XMLHttpRequest&&n instanceof XMLHttpRequest?(o=[n],i=n):t.isArray(n)&&(o=n.slice(),i=null);return new h(o,i)},d=t,l=function(e){if("IE"!==d.env.name||d.env.version>9)return c.call(e);for(var t=[],n=0,i=e.length;i>n;++n)t.push(e[n]);return t},h=function(e,t){var n=l(e);this.context=t,this.toArray=function(){return n},this.length=n.length,this.first=n[0],this.last=n[n.length-1],this.get=function(e){return void 0===e?n:n[e]}};h.prototype.some=function(e,t){return d.some(this.get(),e,t)},h.prototype.forEach=function(e,t){return d.forEach(this.get(),e,t),this},h.prototype.map=function(e,t){return new h(d.map(this.get(),e,t),this.context)},h.prototype.filter=function(e,t){return new h(d.filter(this.get(),e,t),this.context)},h.prototype.find=function(e){return d(e,this.first)};var f=e.OTHelpers;e.OTHelpers=t,e.___othelpers=!0,t.keys=Object.keys||function(e){var t=[],n=Object.prototype.hasOwnProperty;for(var i in e)n.call(e,i)&&t.push(i);return t};var p=Array.prototype.forEach||function(e,t){for(var n=0,i=this.length||0;i>n;++n)n in this&&e.call(t,this[n],n)};t.forEach=function(e,t,n){return p.call(e,t,n)};var m=Array.prototype.map||function(e,t){var n=[];return p.call(this,function(i,o){n.push(e.call(t,i,o))}),n};t.map=function(e,t){return m.call(e,t)};var g=Array.prototype.filter||function(e,t){var n=[];return p.call(this,function(i,o){e.call(t,i,o)&&n.push(i)}),n};t.filter=function(e,t,n){return g.call(e,t,n)};var v=Array.prototype.some||function(e,t){for(var n=!1,i=0,o=this.length||0;o>i;++i)if(i in this&&e.call(t,this[i],i)){n=!0;break}return n};t.find=function(e,t,n){if(!d.isFunction(t))throw new TypeError("iter must be a function");for(var i=void 0,o=0,r=e.length||0;r>o;++o)if(o in e&&t.call(n,e[o],o)){i=e[o];break}return i},t.findIndex=function(e,t,n){if(!d.isFunction(t))throw new TypeError("iter must be a function");for(var i=0,o=e.length||0;o>i;++i)if(i in e&&t.call(n,e[i],i,e))return i;return-1},t.some=function(e,t,n){return v.call(e,t,n)};var b=Array.prototype.indexOf||function(e,t){var n,i,o=t?t:0;if(!this)throw new TypeError;if(i=this.length,0===i||o>=i)return-1;for(0>o&&(o=i-Math.abs(o)),n=o;i>n;n++)if(this[n]===e)return n;return-1};t.arrayIndexOf=function(e,t,n){return b.call(e,t,n)};var y=Function.prototype.bind||function(){var e=c.call(arguments),t=e.shift(),n=this;return function(){return n.apply(t,e.concat(c.call(arguments)))}};t.bind=function(){var e=c.call(arguments),t=e.shift();return y.apply(t,e)};var E=String.prototype.trim||function(){return this.replace(/^\s+|\s+$/g,"")};t.trim=function(e){return E.call(e)},t.noConflict=function(){return t.noConflict=function(){return t},e.OTHelpers=f,t},t.isNone=function(e){return void 0===e||null===e},t.isObject=function(e){return e===Object(e)},t.isFunction=function(e){return!!e&&(-1!==e.toString().indexOf("()")||"[object Function]"===Object.prototype.toString.call(e))},t.isArray=t.isFunction(Array.isArray)&&Array.isArray||function(e){return"[object Array]"===Object.prototype.toString.call(e)},t.isEmpty=function(e){if(null===e||void 0===e)return!0;if(t.isArray(e)||"string"==typeof e)return 0===e.length;for(var n in e)if(e.hasOwnProperty(n))return!1;return!0},t.extend=function(){var e=c.call(arguments),n=e.shift();return t.forEach(e,function(e){for(var t in e)n[t]=e[t]}),n},t.defaults=function(){var e=c.call(arguments),n=e.shift();return t.forEach(e,function(e){for(var t in e)void 0===n[t]&&(n[t]=e[t])}),n},t.clone=function(e){return t.isObject(e)?t.isArray(e)?e.slice():t.extend({},e):e},t.noop=function(){},t.now=function(){var n,i=e.performance||{},o=i.now||i.mozNow||i.msNow||i.oNow||i.webkitNow;return o?(o=t.bind(o,i),n=i.timing.navigationStart,function(){return n+o()}):function(){return(new Date).getTime()}}(),t.canDefineProperty=!0;try{Object.defineProperty({},"x",{})}catch(S){t.canDefineProperty=!1}t.defineGetters=function(e,n,i){var o={};void 0===i&&(i=!1);for(var r in n)o[r]={get:n[r],enumerable:i};t.defineProperties(e,o)};var T=function(e,t,n){return t&&!n?function(){return t.call(e)}:t&&n?function(i){return void 0!==i&&n.call(e,i),t.call(e)}:function(t){void 0!==t&&n.call(e,t)}};t.defineProperties=function(e,t){for(var n in t)e[n]=T(e,t[n].get,t[n].set)},Object.create||(Object.create=function(e){function t(){}if(arguments.length>1)throw new Error("Object.create implementation only accepts the first parameter.");return t.prototype=e,new t}),t.invert=function(e){var t={};for(var n in e)e.hasOwnProperty(n)&&(t[e[n]]=n);return t},t.statable=function(e,n,i,o,r){var s,a=e.currentState=i,c=function(i){if(a!==i){if(-1===t.arrayIndexOf(n,i))return void(r&&t.isFunction(r)&&r("invalidState",i));e.previousState=s=a,e.currentState=a=i,o&&t.isFunction(o)&&o(i,s)}};return e.is=function(){return-1!==t.arrayIndexOf(arguments,a)},e.isNot=function(){return-1===t.arrayIndexOf(arguments,a)},c},function(){function n(e,t,n){var i=t&&n||0,o=0;for(t=t||[],e.toLowerCase().replace(/[0-9a-f]{2}/g,function(e){16>o&&(t[i+o++]=h[e])});16>o;)t[i+o++]=0;return t}function i(e,t){var n=t||0,i=l;return i[e[n++]]+i[e[n++]]+i[e[n++]]+i[e[n++]]+"-"+i[e[n++]]+i[e[n++]]+"-"+i[e[n++]]+i[e[n++]]+"-"+i[e[n++]]+i[e[n++]]+"-"+i[e[n++]]+i[e[n++]]+i[e[n++]]+i[e[n++]]+i[e[n++]]+i[e[n++]]}function o(e,t,n){var o=t&&n||0;"string"==typeof e&&(t="binary"===e?new d(16):null,e=null),e=e||{};var r=e.random||(e.rng||u)();if(r[6]=15&r[6]|64,r[8]=63&r[8]|128,t)for(var s=0;16>s;s++)t[o+s]=r[s];return t||i(r)}var r,s,a=new Array(16);if(r=function(){var e,t=a,n=0;for(n=0;16>n;n++)0===(3&n)&&(e=4294967296*Math.random()),t[n]=e>>>((3&n)<<3)&255;return t},e.crypto&&crypto.getRandomValues){var c=new Uint32Array(4);s=function(){crypto.getRandomValues(c);for(var e=0;16>e;e++)a[e]=c[e>>2]>>>8*(3&e)&255;return a}}for(var u=s||r,d="function"==typeof Buffer?Buffer:Array,l=[],h={},f=0;256>f;f++)l[f]=(f+256).toString(16).substr(1),h[l[f]]=f;var p=o;p.v4=o,p.parse=n,p.unparse=i,p.BufferClass=d,p.mathRNG=r,p.whatwgRNG=s,t.uuid=p}();var w,C=["description","fileName","lineNumber","message","name","number","stack"];t.Error=function(e,t,n){switch(arguments.length){case 1:d.isObject(e)&&(n=e,t=void 0,e=void 0);break;case 2:d.isObject(t)&&(n=t,t=void 0)}if(n instanceof Error)for(var i=0,o=C.length;o>i;++i)this[C[i]]=n[C[i]];else if(d.isObject(n))for(var r in n)n.hasOwnProperty(r)&&(this[r]=n[r]);if(!(this.fileName&&this.lineNumber&&this.columnNumber&&this.stack)){var s=w();!this.fileName&&s.fileName&&(this.fileName=s.fileName),!this.lineNumber&&s.lineNumber&&(this.lineNumber=s.lineNumber),!this.columnNumber&&s.columnNumber&&(this.columnNumber=s.columnNumber),!this.stack&&s.stack&&(this.stack=s.stack)}!this.message&&e&&(this.message=e),!this.name&&t&&(this.name=t)},t.Error.prototype.toString=t.Error.prototype.valueOf=function(){var e="";return this.fileName&&(e+=" "+this.fileName),this.lineNumber&&(e+=" "+this.lineNumber,this.columnNumber&&(e+=":"+this.columnNumber)),"<"+(this.name?this.name+" ":"")+this.message+e+">"};var O=function(e,t){return d.map(t.slice(2),function(e){var t={fileName:e.getFileName(),linenumber:e.getLineNumber(),columnNumber:e.getColumnNumber()};return e.getFunctionName()&&(t.functionName=e.getFunctionName()),e.getMethodName()&&(t.methodName=e.getMethodName()),e.getThis()&&(t.self=e.getThis()),t})};if(w=function(){var t,n,i,o={};switch(d.env.name){case"Firefox":case"Safari":case"IE":if("IE"===d.env.name)i=new Error;else try{e.call.js.is.explody}catch(r){i=r}t=i.stack.split("\n"),t.shift(),t.shift(),o.stack=t,"IE"===d.env.name&&(o.stack.shift(),o.stack=d.map(t,function(e){return e.replace(/^\s+at\s+/g,"")})),n=/@(.+?):([0-9]+)(:([0-9]+))?$/.exec(t[0]),n&&(o.fileName=n[1],o.lineNumber=parseInt(n[2],10),n.length>3&&(o.columnNumber=parseInt(n[4],10)));break;case"Chrome":case"Node":case"Opera":var s=Error.prepareStackTrace;Error.prepareStackTrace=O,i=new Error,o.stack=i.stack,Error.prepareStackTrace=s;var a=o.stack[0];o.lineNumber=a.lineNumber,o.columnNumber=a.columnNumber,o.fileName=a.fileName,a.functionName&&(o.functionName=a.functionName),a.methodName&&(o.methodName=a.methodName),a.self&&(o.self=a.self);break;default:i=new Error,i.stack&&(o.stack=i.stack.split("\n"))}return i.message&&(o.message=i.message),o},function(){var n=-1,i=function(e){if(e===n)return!0;if("number"==typeof e&&"number"==typeof n)return e>n;for(var t=e.split("."),i=n.split("."),o=(t.length>i.length?i:t).length,r=0;o>r;++r)if(parseInt(t[r],10)>parseInt(i[r],10))return!0;return r<t.length?!0:!1},o=function(){if("undefined"!=typeof process&&"undefined"!=typeof process.versions&&"string"==typeof process.versions.node)return n=process.versions.node,"v"===n.substr(1)&&(n=n.substr(1)),{name:"Node",version:n,userAgent:"Node "+n,iframeNeedsLoad:!1,versionGreaterThan:i};var t,o=e.navigator.userAgent.toLowerCase(),r=e.navigator.appName,s="unknown";return o.indexOf("opera")>-1||o.indexOf("opr")>-1?(s="Opera",null!==/opr\/([0-9]{1,}[\.0-9]{0,})/.exec(o)&&(n=parseFloat(RegExp.$1))):o.indexOf("firefox")>-1?(s="Firefox",null!==/firefox\/([0-9]{1,}[\.0-9]{0,})/.exec(o)&&(n=parseFloat(RegExp.$1))):"Microsoft Internet Explorer"===r?(s="IE",null!==/msie ([0-9]{1,}[\.0-9]{0,})/.exec(o)&&(n=parseFloat(RegExp.$1))):"Netscape"===r&&o.indexOf("trident")>-1?(s="IE",null!==/trident\/.*rv:([0-9]{1,}[\.0-9]{0,})/.exec(o)&&(n=parseFloat(RegExp.$1))):o.indexOf("chrome")>-1?(s="Chrome",null!==/chrome\/([0-9]{1,}[\.0-9]{0,})/.exec(o)&&(n=parseFloat(RegExp.$1))):(t=e.navigator.vendor)&&t.toLowerCase().indexOf("apple")>-1&&(s="Safari",null!==/version\/([0-9]{1,}[\.0-9]{0,})/.exec(o)&&(n=parseFloat(RegExp.$1))),{name:s,version:n,userAgent:e.navigator.userAgent,iframeNeedsLoad:o.indexOf("webkit")<0,versionGreaterThan:i}}();t.env=o,t.browser=function(){return t.env.name},t.browserVersion=function(){return t.env}}(),"Node"===e.OTHelpers.env.name){var R=require("request");t.request=function(e,t,n){var i=function(e,t,i){var o={response:t,body:i};!e&&t.statusCode>=200&&(t.statusCode<300||304===t.statusCode)?n(null,o):n(e,o)};"get"===t.method.toLowerCase()?R.get(e,i):R.post(e,t.body,i)},t.getJSON=function(e,t,n){var i=require("underscore").extend({Accept:"application/json"},t.headers||{});R.get({url:e,headers:i,json:!0},function(e,t){n(e,t&&t.body)})}}"Node"!==e.OTHelpers.env.name&&(t.xdomainRequest=function(e,t,n){function o(e,t){r.onload=r.onerror=r.ontimeout=function(){},r=void 0,n(e,t)}var r=new XDomainRequest,s=t||{},a=s.method.toLowerCase();return a?(a=a.toUpperCase(),"GET"!==a&&"POST"!==a?void n(new Error("HTTP method can only be ")):(r.onload=function(){o(null,{target:{responseText:r.responseText,headers:{"content-type":r.contentType}}})},r.onerror=function(){o(new Error("XDomainRequest of "+e+" failed"))},r.ontimeout=function(){o(new Error("XDomainRequest of "+e+" timed out"))},r.open(a,e),void r.send(t.body&&i(t.body)))):void n(new Error("No HTTP method specified in options"))},t.request=function(e,n,o){var r=new XMLHttpRequest,s=n||{},a=s.method;if(!a)return void o(new Error("No HTTP method specified in options"));o&&(t.on(r,"load",function(e){var t=e.target.status;t>=200&&(300>t||304===t)?o(null,e):o(e)}),t.on(r,"error",o)),r.open(n.method,e,!0),s.headers||(s.headers={});for(var c in s.headers)r.setRequestHeader(c,s.headers[c]);r.send(n.body&&i(n.body))},t.getJSON=function(e,n,i){n=n||{};var o=function(e,t){if(e)i(e,t&&t.target&&t.target.responseText);else{var n;try{n=JSON.parse(t.target.responseText)}catch(o){return void i(o,t&&t.target&&t.target.responseText)}i(null,n,t)}};if(n.xdomainrequest)t.xdomainRequest(e,{method:"GET"},o);else{var r=t.extend({Accept:"application/json"},n.headers||{});t.get(e,t.extend(n||{},{headers:r}),o)}}),t.useLogHelpers=function(n){function i(t,i,o){return function(){if(n.shouldLog(i)){var r=e.console,s=f(arguments);if(r&&r[t])r[t].apply||l?(r[t].apply||(r[t]=Function.prototype.bind.call(r[t],r)),r[t].apply(r,s)):r[t](s);else if(o)return void o.apply(n,s);a(t,f(arguments))}}}function o(){var e=new Date;return e.toLocaleTimeString()+e.getMilliseconds()}function r(e){try{return JSON.stringify(e)}catch(t){return e.toString()}}function s(e){var n=[];if("undefined"==typeof e);else if(null===e)n.push("NULL");else if(t.isArray(e))for(var i=0;i<e.length;++i)n.push(r(e[i]));else if(t.isObject(e))for(var o in e){var s;t.isFunction(e[o])?e.hasOwnProperty(o)&&(s="function "+o+"()"):s=r(e[o]),n.push(o+": "+s)}else if(t.isFunction(e))try{n.push(e.toString())}catch(a){n.push("function()")}else n.push(e.toString());return n.join(", ")}function a(e,t){if(t){var n=s(t);n.length<=2||d.push([e,o(),n])}}n.DEBUG=5,n.LOG=4,n.INFO=3,n.WARN=2,n.ERROR=1,n.NONE=0;var u=n.NONE,d=[],l=!0;try{Function.prototype.bind.call(e.console.log,e.console)}catch(h){l=!1}var f=function(e){return e};"IE"===t.env.name&&(f=function(e){return[s(c.apply(e))]}),n.log=i("log",n.LOG),n.debug=i("debug",n.DEBUG,n.log),n.info=i("info",n.INFO,n.log),n.warn=i("warn",n.WARN,n.log),n.error=i("error",n.ERROR,n.log),n.setLogLevel=function(e){return u="number"==typeof e?e:0,n.debug("TB.setLogLevel("+u+")"),u},n.getLogs=function(){return d},n.shouldLog=function(e){return u>=e}},t.useLogHelpers(t),t.setLogLevel(t.ERROR),h.prototype.on=function(e,t){return this.forEach(function(n){if(n.addEventListener)n.addEventListener(e,t,!1);else if(n.attachEvent)n.attachEvent("on"+e,t);else{var i=n["on"+e];n["on"+e]=function(){t.apply(this,arguments),i&&i.apply(this,arguments)}}})},h.prototype.off=function(e,t){return this.forEach(function(n){n.removeEventListener?n.removeEventListener(e,t,!1):n.detachEvent&&n.detachEvent("on"+e,t)})},h.prototype.once=function(e,t){var n=d.bind(function(){this.off(e,n),t.apply(null,arguments)},this);return this.on(e,n)},t.on=function(e,t,n){return d(e).on(t,n)},t.off=function(e,t,n){return d(e).off(t,n)},t.once=function(e,t,n){return d(e).once(t,n)},function(){var n="undefined"==typeof document||"complete"===document.readyState||"interactive"===document.readyState&&document.body,i=[],o=[],r=!1,s=function(){n=!0,"undefined"!=typeof document&&(document.addEventListener?(document.removeEventListener("DOMContentLoaded",s,!1),e.removeEventListener("load",s,!1)):(document.detachEvent("onreadystatechange",s),e.detachEvent("onload",s))),t.on(e,"unload",a),t.forEach(i,function(e){e[0].call(e[1])}),i=[]},a=function(){r=!0,t.forEach(o,function(e){e[0].call(e[1])}),o=[]};t.onDOMLoad=function(e,n){return t.isReady()?void e.call(n):void i.push([e,n])},t.onDOMUnload=function(e,t){return this.isDOMUnloaded()?void e.call(t):void o.push([e,t])},t.isReady=function(){return!r&&n},t.isDOMUnloaded=function(){return r},n?s():"undefined"!=typeof document&&(document.addEventListener?(document.addEventListener("DOMContentLoaded",s,!1),e.addEventListener("load",s,!1)):document.attachEvent&&(document.attachEvent("onreadystatechange",function(){"complete"===document.readyState&&s()}),e.attachEvent("onload",s)))}(),t.setCookie=function(e,t){try{localStorage.setItem(e,t)}catch(n){var i=new Date;i.setTime(i.getTime()+31536e6);var o="; expires="+i.toGMTString();document.cookie=e+"="+t+o+"; path=/"}},t.getCookie=function(e){var t;try{return t=localStorage.getItem(e)}catch(n){for(var i=e+"=",o=document.cookie.split(";"),r=0;r<o.length;r++){for(var s=o[r];" "===s.charAt(0);)s=s.substring(1,s.length);0===s.indexOf(i)&&(t=s.substring(i.length,s.length))}if(t)return t}return null},t.Collection=function(e){var n=[],i={},o=e||"id";t.eventing(this,!0);var r=function(e,n){return t.isFunction(e[n])?e[n]():e[n]},s=t.bind(function(e){this.trigger("update",e),this.trigger("update:"+e.target.id,e)},this),a=t.bind(function(e){this.remove(e.target,e.reason)},this);this.reset=function(){t.forEach(n,function(e){e.off("updated",s,this),e.off("destroyed",a,this)},this),n=[],i={}},this.destroy=function(e){t.forEach(n,function(t){t&&"function"==typeof t.destroy&&t.destroy(e,!0)}),this.reset(),this.off()},this.get=function(e){return e&&void 0!==i[e]?n[i[e]]:void 0},this.has=function(e){return e&&void 0!==i[e]},this.toString=function(){return n.toString()},this.where=function(e,i){return t.isFunction(e)?t.filter(n,e,i):t.filter(n,function(t){for(var n in e)if(e.hasOwnProperty(n)&&r(t,n)!==e[n])return!1;return!0})},this.find=function(e,i){var o;o=t.isFunction(e)?e:function(t){for(var n in e)if(e.hasOwnProperty(n)&&r(t,n)!==e[n])return!1;return!0},o=t.bind(o,i);for(var s=0;s<n.length;++s)if(o(n[s])===!0)return n[s];return null},this.add=function(e){var c=r(e,o);return this.has(c)?(t.warn("Model "+c+" is already in the collection",n),this):(i[c]=n.push(e)-1,e.on("updated",s,this),e.on("destroyed",a,this),this.trigger("add",e),this.trigger("add:"+c,e),this)},this.remove=function(e,t){var c=r(e,o);n.splice(i[c],1);for(var u=i[c];u<n.length;++u)i[n[u][o]]=u;return delete i[c],e.off("updated",s,this),e.off("destroyed",a,this),this.trigger("remove",e,t),this.trigger("remove:"+c,e,t),this},this._triggerAddEvents=function(){var e=this.where.apply(this,arguments);t.forEach(e,function(e){this.trigger("add",e),this.trigger("add:"+r(e,o),e)},this)},this.length=function(){return n.length}},t.castToBoolean=function(e,t){return e===n?t:"true"===e||e===!0},t.roundFloat=function(e,t){return Number(e.toFixed(t))},function(){var e={};t.registerCapability=function(i,o){var r=i.toLowerCase();return e.hasOwnProperty(r)?void t.error("Attempted to register",i,"capability more than once"):t.isFunction(o)?void n(r,o):void t.error("Attempted to register",i,"capability with a callback that isn' a function")};var n=function(t,n){e[t]=function(){var i=n();return e[t]=function(){return i},i}},i=function(t){return e[t]()};t.hasCapabilities=function(){for(var n,o=c.call(arguments),r=0;r<o.length;++r){if(n=o[r].toLowerCase(),!e.hasOwnProperty(n))return t.error("hasCapabilities was called with an unknown capability: "+n),!1;if(i(n)===!1)return!1}return!0}}(),t.registerCapability("websockets",function(){return"WebSocket"in e&&void 0!==e.WebSocket}),function(){var n,i=function(){if(e.postMessage){var t=!0,n=e.onmessage;return e.onmessage=function(){t=!1},e.postMessage("","*"),e.onmessage=n,t}}();if(i){var o=[],r="OTHelpers."+t.uuid.v4()+".zero-timeout",s=function(){o=[],e.removeEventListener?e.removeEventListener("message",a):e.detachEvent&&e.detachEvent("onmessage",a)},a=function(n){if(n.source===e&&n.data===r){if(t.isFunction(n.stopPropagation)&&n.stopPropagation(),n.cancelBubble=!0,!e.___othelpers)return void s();if(o.length>0){var i=o.shift(),a=i.shift();a.apply(null,i)}}};t.on(e,"unload",s),e.addEventListener?e.addEventListener("message",a,!0):e.attachEvent&&e.attachEvent("onmessage",a),n=function(){o.push(c.call(arguments)),e.postMessage(r,"*")}}else n=function(){var e=c.call(arguments),t=e.shift();setTimeout(function(){t.apply(null,e)},0)};t.callAsync=n,t.createAsyncHandler=function(e){return function(){var n=c.call(arguments);t.callAsync(function(){e.apply(null,n)})}}}(),t.eventing=function(e,n){function i(e,t){e&&e.apply(null,t.slice())}function o(e,n,o){var r=s[e];if(r&&0!==r.length){var a=r.length;t.forEach(r,function(r){function c(e){return e.context===r.context&&e.handler===r.handler}t.callAsync(function(){try{s[e]&&t.some(s[e],c)&&(r.closure||r.handler).apply(r.context||null,n)}finally{a--,0===a&&i(o,n)}})})}}function r(e,n){var i=s[e];i&&0!==i.length&&t.forEach(i,function(e){(e.closure||e.handler).apply(e.context||null,n)})}var s={},a=n===!0?r:o,u=function(e,n){s[e]&&(n?s[e]=t.filter(s[e],function(e){return e.context!==n}):delete s[e])},d=t.bind(function(e,n,i,o){var r={handler:n};i&&(r.context=i),o&&(r.closure=o),t.forEach(e,function(e){s[e]||(s[e]=[]),s[e].push(r);var t=e+":added";s[t]&&a(t,[s[e].length])})},e),l=function(n,i,o){function r(e){return!(e.handler===i&&e.context===o)}t.forEach(n,t.bind(function(e){if(s[e]){s[e]=t.filter(s[e],r),0===s[e].length&&delete s[e];var n=e+":removed";s[n]&&a(n,[s[e]?s[e].length:0])}},e))};return e.dispatchEvent=function(e,n){if(!e.type)throw t.error("OTHelpers.Eventing.dispatchEvent: Event has no type"),t.error(e),new Error("OTHelpers.Eventing.dispatchEvent: Event has no type");return e.target||(e.target=this),s[e.type]&&0!==s[e.type].length?(a(e.type,[e],n),this):void i(n,[e])},e.trigger=function(e){if(s[e]&&0!==s[e].length){var t=c.call(arguments);return t.shift(),a(e,t),this}},e.on=function(e,t,n){if("string"==typeof e&&t)d(e.split(" "),t,n);else for(var i in e)e.hasOwnProperty(i)&&d([i],e[i],t);return this},e.off=function(e,n,i){if("string"==typeof e)n&&t.isFunction(n)?l(e.split(" "),n,i):t.forEach(e.split(" "),function(e){u(e,n)},this);else if(e)for(var o in e)e.hasOwnProperty(o)&&l([o],e[o],n);else s={};return this},e.once=function(e,n,i){var o=e.split(" "),r=t.bind(function(){var e=n.apply(i||null,arguments);return l(o,n,i),e},this);return d(o,n,i,r),this},e.addEventListener=function(e,n,i){t.warn("The addEventListener() method is deprecated. Use on() or once() instead."),d([e],n,i)},e.removeEventListener=function(e,n,i){t.warn("The removeEventListener() method is deprecated. Use off() instead."),l([e],n,i)},e},t.eventing.Event=function(){return function(e,i){this.type=e,this.cancelable=i!==n?i:!0;var o=!1;this.preventDefault=function(){this.cancelable?o=!0:t.warn("Event.preventDefault :: Trying to preventDefault on an Event that isn't cancelable")},this.isDefaultPrevented=function(){return o}}},t.createElement=function(e,t,n,i){var o=(i||document).createElement(e);if(t)for(var r in t)if("object"==typeof t[r]){o[r]||(o[r]={});var s=t[r];for(var a in s)o[r][a]=s[a]}else"className"===r?o.className=t[r]:o.setAttribute(r,t[r]);var c=function(e){"string"==typeof e?o.innerHTML=o.innerHTML+e:o.appendChild(e)};return d.isArray(n)?d.forEach(n,c):n&&c(n),o},t.createButton=function(e,t,n){var i=d.createElement("button",t,e);if(n){for(var o in n)n.hasOwnProperty(o)&&d.on(i,o,n[o]);i._boundEvents=n}return i},h.prototype.appendTo=function(e){if(!e)throw new Error("appendTo requires a DOMElement to append to.");return this.forEach(e.appendChild.bind(e))},h.prototype.after=function(e){if(!e)throw new Error("after requires a DOMElement to insert after");return this.forEach(function(t){t.parentElement&&(e!==t.parentNode.lastChild?t.parentElement.before(t,e):t.parentElement.appendChild(t))})},h.prototype.before=function(e){if(!e)throw new Error("before requires a DOMElement to insert before");return this.forEach(function(t){t.parentElement&&t.parentElement.before(t,e)})},h.prototype.remove=function(){return this.forEach(function(e){e.parentNode&&e.parentNode.removeChild(e)})},h.prototype.empty=function(){return this.forEach(function(e){for(;e.firstChild;)e.removeChild(e.firstChild)})},h.prototype.isDisplayNone=function(){return this.some(function(e){return 0!==e.offsetWidth&&0!==e.offsetHeight||"none"!==d(e).css("display")?e.parentNode&&e.parentNode.style?d(e.parentNode).isDisplayNone():void 0:!0})},h.prototype.findElementWithDisplayNone=function(e){return d.findElementWithDisplayNone(e)},t.isElementNode=function(e){return e&&"object"==typeof e&&1===e.nodeType},t.removeElement=function(e){d(e).remove()},t.removeElementById=function(e){return d("#"+e).remove()},t.removeElementsByType=function(e,t){return d(t,e).remove()},t.emptyElement=function(e){return d(e).empty()},t.isDisplayNone=function(e){return d(e).isDisplayNone()},t.findElementWithDisplayNone=function(e){return 0!==e.offsetWidth&&0!==e.offsetHeight||"none"!==d.css(e,"display")?e.parentNode&&e.parentNode.style?d.findElementWithDisplayNone(e.parentNode):null:e},t.Modal=function(e){t.eventing(this,!0);var n=arguments[arguments.length-1];if(!t.isFunction(n))throw new Error("OTHelpers.Modal2 must be given a callback");arguments.length<2&&(e={});var i=document.createElement("iframe");i.id=e.id||t.uuid(),i.style.position="absolute",i.style.position="fixed",i.style.height="100%",i.style.width="100%",i.style.top="0px",i.style.left="0px",i.style.right="0px",i.style.bottom="0px",i.style.zIndex=1e3,i.style.border="0";try{i.style.backgroundColor="rgba(0,0,0,0.2)"}catch(o){i.style.backgroundColor="transparent",i.setAttribute("allowTransparency","true")}i.scrolling="no",i.setAttribute("scrolling","no");var r='<!DOCTYPE html><html><head><meta http-equiv="x-ua-compatible" content="IE=Edge"><meta http-equiv="Content-type" content="text/html; charset=utf-8"><title></title></head><body></body></html>',s=function(){var e=i.contentDocument||i.contentWindow.document;t.env.iframeNeedsLoad&&(e.body.style.backgroundColor="transparent",e.body.style.border="none","IE"!==t.env.name&&(e.open(),e.write(r),e.close())),n(i.contentWindow,e)};document.body.appendChild(i),t.env.iframeNeedsLoad?("IE"===t.env.name&&(i.contentWindow.contents=r,i.src='javascript:window["contents"]'),t.on(i,"load",s)):setTimeout(s,0),this.close=function(){return t.removeElement(i),this.trigger("closed"),this.element=i=null,this},this.element=i},function(){function e(t,n,i,o){var r,s=n[i],a=parseFloat(s),c=s.split(/\d/)[0];return o=null!=o?o:/%|em/.test(c)&&t.parentElement?e(t.parentElement,t.parentElement.currentStyle,"fontSize",null):16,r="fontSize"===i?o:/width/i.test(i)?t.clientWidth:t.clientHeight,"em"===c?a*o:"in"===c?96*a:"pt"===c?96*a/72:"%"===c?a/100*r:a}function n(e,t){var n="border"===t?"Width":"",i=t+"Top"+n,o=t+"Right"+n,r=t+"Bottom"+n,s=t+"Left"+n;e[t]=(e[i]===e[o]===e[r]===e[s]?[e[i]]:e[i]===e[r]&&e[s]===e[o]?[e[i],e[o]]:e[s]===e[o]?[e[i],e[o],e[r]]:[e[i],e[o],e[r],e[s]]).join(" ")}function i(t){var i,o=t.currentStyle,r=this,s=e(t,o,"fontSize",null);for(i in o)/width|height|margin.|padding.|border.+W/.test(i)&&"auto"!==r[i]?r[i]=e(t,o,i,s)+"px":"styleFloat"===i?r["float"]=o[i]:r[i]=o[i];return n(r,"margin"),n(r,"padding"),n(r,"border"),r.fontSize=s+"px",r}function o(e){return new i(e)}i.prototype={constructor:i,getPropertyPriority:function(){},getPropertyValue:function(e){return this[e]||""},item:function(){},removeProperty:function(){},setProperty:function(){},getPropertyCSSValue:function(){}},t.getComputedStyle=function(e){return e&&e.ownerDocument&&e.ownerDocument.defaultView&&e.ownerDocument.defaultView.getComputedStyle?e.ownerDocument.defaultView.getComputedStyle(e):o(e)}}();var I=function(e,t,n){var i={},o=function(t){switch(t){case"width":return d(e).width();case"height":return d(e).height();default:return d(e).css(t)}};d.forEach(t,function(e){i[e]=o(e)});var r=new MutationObserver(function(r){var s={};d.forEach(r,function(n){if("style"===n.attributeName){var r=d.isDisplayNone(e);d.forEach(t,function(e){if(!r||"width"!==e&&"height"!==e){var t=o(e);t!==i[e]&&(s[e]=[i[e],t],i[e]=t)}})}}),d.isEmpty(s)||d.callAsync(function(){n.call(null,s)})});return r.observe(e,{attributes:!0,attributeFilter:["style"],childList:!1,characterData:!1,subtree:!1}),r},A=function(e,t){var n=new MutationObserver(function(e){var n=[];d.forEach(e,function(e){e.removedNodes.length&&(n=n.concat(c.call(e.removedNodes)))}),n.length&&d.callAsync(function(){t(d(n))})});return n.observe(e,{attributes:!1,childList:!0,characterData:!1,subtree:!0}),n},P=function(e,t){var n={width:0,height:0},i=setInterval(function(){var i=e.getBoundingClientRect();(n.width!==i.width||n.height!==i.height)&&(t(i,n),n={width:i.width,height:i.height})},200);return{disconnect:function(){clearInterval(i)}}};h.prototype.observeStyleChanges=function(e,t){var n=[];return this.forEach(function(i){n.push(I(i,e,t))}),n},h.prototype.observeNodeOrChildNodeRemoval=function(e){var t=[];return this.forEach(function(n){t.push(A(n,e))}),t},h.prototype.observeSize=function(e){var t=[];return this.forEach(function(n){t.push(P(n,e))}),t},t.observeStyleChanges=function(e,t,n){return d(e).observeStyleChanges(t,n)[0]},t.observeNodeOrChildNodeRemoval=function(e,t){return d(e).observeNodeOrChildNodeRemoval(t)[0]},t.registerCapability("classList",function(){return"undefined"!=typeof document&&"classList"in document.createElement("a")}),h.prototype.addClass=function(e){if(e){var t=d.trim(e).split(/\s+/);this.forEach(function(e){s(e,t)})}return this},h.prototype.removeClass=function(e){if(e){var t=d.trim(e).split(/\s+/);this.forEach(function(e){a(e,t)})}return this},h.prototype.toggleClass=function(e){if(e){var t=d.trim(e).split(/\s+/);this.forEach(function(e){r(e,t)})}return this},h.prototype.hasClass=function(e){return this.some(function(t){return o(t,e)})},t.addClass=function(e,t){return d(e).addClass(t)},t.removeClass=function(e,t){return d(e).removeClass(t)},h.prototype.attr=function(e,n){if(t.isObject(e))for(var i in e)this.first.setAttribute(i,e[i]);else{if(void 0===n)return this.first.getAttribute(e);this.first.setAttribute(e,n)}return this},h.prototype.html=function(e){return void 0!==e&&(this.first.innerHTML=e),this.first.innerHTML},h.prototype.center=function(e,t){var n;return this.forEach(function(i){n=d(i),e||(e=parseInt(n.width(),10)),t||(t=parseInt(n.height(),10));var o=-.5*e+"px",r=-.5*t+"px";n.css("margin",r+" 0 0 "+o).addClass("OT_centered")}),this},t.centerElement=function(e,t,n){return d(e).center(t,n)},function(){var e=function(e){return e.offsetWidth>0?e.offsetWidth+"px":d(e).css("width")},n=function(e){return e.offsetHeight>0?e.offsetHeight+"px":d(e).css("height")};h.prototype.width=function(t){return t?(this.css("width",t),this):this.isDisplayNone()?this.makeVisibleAndYield(function(t){return e(t)})[0]:e(this.get(0))},h.prototype.height=function(e){return e?(this.css("height",e),this):this.isDisplayNone()?this.makeVisibleAndYield(function(e){return n(e)})[0]:n(this.get(0))},t.width=function(e,n){var i=d(e).width(n);return n?t:i},t.height=function(e,n){var i=d(e).height(n);return n?t:i}}(),function(){var e={},i={},o=function(e){if(i[e.ownerDocument]&&i[e.ownerDocument][e.nodeName])return i[e.ownerDocument][e.nodeName];i[e.ownerDocument]||(i[e.ownerDocument]={});var t,n=e.ownerDocument.createElement(e.nodeName);return e.ownerDocument.body.appendChild(n),t=i[e.ownerDocument][e.nodeName]=d(n).css("display"),d(n).remove(),n=null,t},r=function(e){var t=d.getComputedStyle(e);return"none"===t.getPropertyValue("display")},s=function(e,t){var n=e.style;for(var i in t)t.hasOwnProperty(i)&&(n[i]=t[i])},a=function(e,t,n){e.style[t]=n},c=function(e,t){var n=t.replace(/([A-Z]|^ms)/g,"-$1").toLowerCase(),i=d.getComputedStyle(e),o=i.getPropertyValue(n);return""===o&&(o=e.style[n]),o},u=function(e,t,n){var i,o,r={};for(i in t)t.hasOwnProperty(i)&&(r[i]=e.style[i],d(e).css(i,t[i]));o=n(e);for(i in t)t.hasOwnProperty(i)&&d(e).css(i,r[i]||"");return o};h.prototype.show=function(){return this.forEach(function(t){var n=t.style.display;(""===n||"none"===n)&&(t.style.display=e[t]||"",delete e[t]),r(t)&&(e[t]="none",t.style.display=o(t))})},h.prototype.hide=function(){return this.forEach(function(t){"none"!==t.style.display&&(e[t]=t.style.display,t.style.display="none")})},h.prototype.css=function(e,t){return 0!==this.length?"string"!=typeof e?this.forEach(function(t){s(t,e)
}):t!==n?this.forEach(function(n){a(n,e,t)}):c(this.first,e,t):void 0},h.prototype.applyCSS=function(e,t){var n=[];return this.forEach(function(i){n.push(u(i,e,t))}),n},h.prototype.makeVisibleAndYield=function(e){var t={display:"block",visibility:"hidden"},n=[];return this.forEach(function(i){var o=d.findElementWithDisplayNone(i);n.push(o?u(o,t,e):void 0)}),n},t.show=function(e){return d(e).show()},t.hide=function(e){return d(e).hide()},t.css=function(e,t,n){return d(e).css(t,n)},t.applyCSS=function(e,t,n){return d(e).applyCSS(t,n)},t.makeVisibleAndYield=function(e,t){return d(e).makeVisibleAndYield(t)}}(),function(){t.setImmediate=function(){return"undefined"!=typeof process&&process.nextTick?"undefined"!=typeof setImmediate?setImmediate:process.nextTick:"function"==typeof setImmediate?function(e){setImmediate(e)}:function(e){setTimeout(e,0)}}(),t.iterator=function(e){var t=function(n){var i=function(){return e.length&&e[n].apply(null,arguments),i.next()};return i.next=function(){return n<e.length-1?t(n+1):null},i};return t(0)},t.waterfall=function(e,n){if(n=n||function(){},e.constructor!==Array)return n(new Error("First argument to waterfall must be an array of functions"));if(!e.length)return n();var i=function(e){return function(o){if(o)n.apply(null,arguments),n=function(){};else{var r=c.call(arguments,1),s=e.next();r.push(s?i(s):n),t.setImmediate(function(){e.apply(null,r)})}}};i(t.iterator(e))()}}(),function(){var n=e.requestAnimationFrame||e.mozRequestAnimationFrame||e.webkitRequestAnimationFrame||e.msRequestAnimationFrame;if(n)n=t.bind(n,e);else{var i=0,o=t.now();n=function(n){var r=t.now(),s=Math.max(0,16-(r-i)),a=e.setTimeout(function(){n(r-o)},s);return i=r+s,a}}t.requestAnimationFrame=n}(),function(){var e=[],i=!1;t.Analytics=function(o,r){var s=o+"/logging/ClientEvent",a=o+"/logging/ClientQos",c={},u=function(e,n,i){t.post((n?a:s)+"?_="+t.uuid.v4(),{body:e,xdomainrequest:"IE"===d.env.name&&d.env.version<10,headers:{"Content-Type":"application/json"}},i)},l=function(){if(!i&&e.length>0){i=!0;var t=e[0],n=function(){e.shift(),i=!1,l()};t&&u(t.data,t.isQos,function(e){if(e){var i="Failed to send ClientEvent, moving on to the next item.";r?r(i):console.log(i)}else t.onComplete();setTimeout(n,50)})}},h=function(t,n,i){e.push({data:t,onComplete:n,isQos:i}),l()},f=function(e,t,i){if(!i)return!1;var o=[i,t,e].join("_"),r=100;return null===r||r===n?!1:(c[o]||0)<=r};this.logError=function(e,n,i,o,r){r||(r={});var s=r.partnerId;if(!f(e,n,s)){var a=[s,n,e].join("_"),u=o?o:null;c[a]="undefined"!=typeof c[a]?c[a]+1:1,this.logEvent(t.extend(r,{action:n+"."+e,payload:u}),!1)}},this.logEvent=function(e,t,n){if(t||(t=!1),!(n&&!isNaN(n)&&Math.random()>n)){for(var i in e)e.hasOwnProperty(i)&&null===e[i]&&delete e[i];e=JSON.stringify(e);var o=function(){};h(e,o,t)}},this.logQOS=function(e){this.logEvent(e,!0)}}}(),t.get=function(e,n,i){var o=t.extend(n||{},{method:"GET"});t.request(e,o,i)},t.post=function(e,n,i){var o=t.extend(n||{},{method:"POST"});o.xdomainrequest?t.xdomainRequest(e,o,i):t.request(e,o,i)}}(e,e.OTHelpers),function(t){if(void 0===t.OTPlugin){var n="IE"===OTHelpers.env.name&&OTHelpers.env.version>=8&&-1===OTHelpers.env.userAgent.indexOf("x64"),i=!1,o={isSupported:function(){return n},isReady:function(){return i},meta:{mimeType:"application/x-opentokie,version=0.4.0.9",activeXName:"TokBox.OpenTokIE.0.4.0.9",version:"0.4.0.9"}};if(OTHelpers.useLogHelpers(o),t.OTPlugin=o,!o.isSupported())return void(o.isInstalled=function(){return!1});var r,s=function(){Function.prototype.bind||(Function.prototype.bind=function(e){if("function"!=typeof this)throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable");var t=Array.prototype.slice.call(arguments,1),n=this,i=function(){},o=function(){return n.apply(this instanceof i&&e?this:e,t.concat(Array.prototype.slice.call(arguments)))};return i.prototype=this.prototype,o.prototype=new i,o}),Array.isArray||(Array.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)}),Array.prototype.indexOf||(Array.prototype.indexOf=function(e,t){var n,i,o=t?t:0;if(!this)throw new TypeError;if(i=this.length,0===i||o>=i)return-1;for(0>o&&(o=i-Math.abs(o)),n=o;i>n;n++)if(this[n]===e)return n;return-1}),Array.prototype.map||(Array.prototype.map=function(e){"use strict";if(void 0===this||null===this)throw new TypeError;var t=Object(this),n=t.length>>>0;if("function"!=typeof e)throw new TypeError;for(var i=new Array(n),o=arguments.length>=2?arguments[1]:void 0,r=0;n>r;r++)r in t&&(i[r]=e.call(o,t[r],r,t));return i})},a=function(e,t){var n,i,r,s=!1;try{n=e._.RumorInit(t,"")}catch(a){o.error("Error creating the Rumor Socket: ",a.message)}if(!n)throw new Error("Could not initialise OTPlugin rumor connection");e._.SetOnRumorOpen(n,function(){i&&OTHelpers.isFunction(i)&&i.call(null)}),e._.SetOnRumorClose(n,function(t){r(t),e.removeRef(this)});var c={open:function(){s=!0,e._.RumorOpen(n)},close:function(t,i){s&&(s=!1,e._.RumorClose(n,t,i))},destroy:function(){this.close()},send:function(t){e._.RumorSend(n,t.type,t.toAddress,JSON.parse(JSON.stringify(t.headers)),t.data)},onOpen:function(e){i=e},onClose:function(e){r=e},onError:function(t){e._.SetOnRumorError(n,t)},onMessage:function(t){e._.SetOnRumorMessage(n,t)}};return e.addRef(c),c},c={},u={},d=function(e){return function(){var t=Array.prototype.slice.call(arguments);t.unshift(e),OTHelpers.callAsync.apply(OTHelpers,t)}},l=function(e){if(e&&(c[e]&&(clearTimeout(c[e]),delete c[e]),t[e]))try{delete t[e]}catch(n){t[e]=void 0}},h=function(e){l(e.getAttribute("tbCallbackId")),r&&r.id===e.id?r=null:u.hasOwnProperty(e.id)&&delete u[e.id],OTHelpers.removeElement(e)},f=function(){r&&r.destroy();for(var e in u)u.hasOwnProperty(e)&&u[e].destroy()},p=function(e){var t=e,n=[];this._=t,this.addRef=function(e){return n.push(e),this},this.removeRef=function(e){if(0!==n.length){var t=n.indexOf(e);return-1!==t&&n.splice(t,1),0===n.length&&this.destroy(),this}},this.isValid=function(){return t.valid};var i={},o=OTHelpers.bind(d(function(){var e=Array.prototype.slice.call(arguments),t=e.shift();(i.hasOwnProperty(t)||!i[t].length)&&OTHelpers.forEach(i[t],function(t){t[0].apply(t[1],e)})}),this);this.on=function(e,t,n){return i.hasOwnProperty(e)||(i[e]=[]),i[e].push([t,n]),this},this.off=function(e,t,n){return i.hasOwnProperty(e)&&0!==i[e].length?(OTHelpers.filter(i[e],function(e){return e[0]===t&&e[1]===n}),this):void 0},this.once=function(e,t,n){var i=function(){return this.off(e,i,this),t.apply(n,arguments)};return this.on(e,i,this),this},this.onReady=function(e){t.on&&t.on(-1,{customEvent:d(o,this)}),t.initialise?(this.on("ready",OTHelpers.bind(d(e),this)),t.initialise()):e.call(null)},this.destroy=function(){for(;n.length;)n.shift().destroy();t&&h(t),t=null},this.setStream=function(e,n){if(n)if(e.hasVideo()){var i=function(){t&&(t.videoWidth>0?setTimeout(n,200):setTimeout(i,500))};setTimeout(i,500)}else n();t.setStream(e)}},m=function(e,t){this.domElement=e._,this.parentElement=e._.parentNode,e.addRef(this),this.appendTo=function(t){t&&e._.parentNode!==t&&(o.debug("VideoContainer appendTo",t),t.appendChild(e._),this.parentElement=t)},this.show=function(n){o.debug("VideoContainer show"),e._.removeAttribute("width"),e._.removeAttribute("height"),e.setStream(t,n),OTHelpers.show(e._)},this.setWidth=function(t){o.debug("VideoContainer setWidth to "+t),e._.setAttribute("width",t)},this.setHeight=function(t){o.debug("VideoContainer setHeight to "+t),e._.setAttribute("height",t)},this.setVolume=function(e){o.debug("VideoContainer setVolume not implemented: called with "+e)},this.getVolume=function(){return o.debug("VideoContainer getVolume not implemented"),.5},this.getImgData=function(){return e._.getImgData("image/png")},this.getVideoWidth=function(){return e._.videoWidth},this.getVideoHeight=function(){return e._.videoHeight},this.destroy=function(){e._.setStream(null),e.removeRef(this)}},g=function(e){this.forEach=function(t,n){for(var i in e)t.call(n,e[i])}},v=function(e,t,n,i){var r,s=OTHelpers.uuid(),a=!1,c=!1,u=[],d=!1,l=[],h=this;n.addRef(this),r={addstream:[],removestream:[],icecandidate:[],signalingstatechange:[],iceconnectionstatechange:[]};var f=function(){},p=function(e){o.error("Failed to process candidate"),o.error(e)},m=function(){for(var e=0;e<u.length;++e)n._.addIceCandidate(s,u[e],f,p)},v=function(e){return function(){return d===!0?e.apply(h,arguments):void l.push([e,arguments])}},b=function(){for(var e;e=l.shift();)e[0].apply(h,e[1])},E=function(){var e=Array.prototype.slice.call(arguments),t=e.shift();return r.hasOwnProperty(t)?void OTHelpers.forEach(r[t],function(t){t.apply(null,e)}):void o.error("PeerConnection does not have an event called: "+t)},S=function(){n._.on(s,{addStream:function(e){setTimeout(function(){var t=y.fromJson(e,n),i={stream:t,target:h};h.onaddstream&&OTHelpers.isFunction(h.onaddstream)&&OTHelpers.callAsync(h.onaddstream,i),E("addstream",i)},3e3)},removeStream:function(e){var t=y.fromJson(e,n),i={stream:t,target:h};h.onremovestream&&OTHelpers.isFunction(h.onremovestream)&&OTHelpers.callAsync(h.onremovestream,i),E("removestream",i)},iceCandidate:function(e,t,n){var i=new o.RTCIceCandidate({candidate:e,sdpMid:t,sdpMLineIndex:n}),r={candidate:i,target:h};h.onicecandidate&&OTHelpers.isFunction(h.onicecandidate)&&OTHelpers.callAsync(h.onicecandidate,r),E("icecandidate",r)},signalingStateChange:function(e){h.signalingState=e;var t={state:e,target:h};h.onsignalingstatechange&&OTHelpers.isFunction(h.onsignalingstatechange)&&OTHelpers.callAsync(h.onsignalingstatechange,t),E("signalingstate",t)},iceConnectionChange:function(e){h.iceConnectionState=e;var t={state:e,target:h};h.oniceconnectionstatechange&&OTHelpers.isFunction(h.oniceconnectionstatechange)&&OTHelpers.callAsync(h.oniceconnectionstatechange,t),E("iceconnectionstatechange",t)}})};return this.createOffer=v(function(e,t,i){o.debug("createOffer",i),n._.createOffer(s,function(t,n){e(new o.RTCSessionDescription({type:t,sdp:n}))},t,i||{})}),this.createAnswer=v(function(e,t,i){o.debug("createAnswer",i),n._.createAnswer(s,function(t,n){e(new o.RTCSessionDescription({type:t,sdp:n}))},t,i||{})}),this.setLocalDescription=v(function(e,t,i){o.debug("setLocalDescription"),n._.setLocalDescription(s,e,function(){a=!0,c&&m(),t&&t.call(null)},i)}),this.setRemoteDescription=v(function(e,t,i){o.debug("setRemoteDescription"),n._.setRemoteDescription(s,e,function(){c=!0,a&&m(),t&&t.call(null)},i)}),this.addIceCandidate=v(function(e){o.debug("addIceCandidate"),a&&c?n._.addIceCandidate(s,e,f,p):u.push(e)}),this.addStream=v(function(e){var t={};n._.addStream(s,e,t)}),this.removeStream=v(function(e){n._.removeStream(s,e)}),this.getRemoteStreams=function(){return OTHelpers.map(n._.getRemoteStreams(s),function(e){return y.fromJson(e,n)})},this.getLocalStreams=function(){return OTHelpers.map(n._.getLocalStreams(s),function(e){return y.fromJson(e,n)})},this.getStreamById=function(e){return y.fromJson(n._.getStreamById(s,e),n)},this.getStats=v(function(e,t,i){n._.getStats(s,e||null,function(e){var n=new g(JSON.parse(e));OTHelpers.callAsync(t,n)},i)}),this.close=function(){n._.destroyPeerConnection(s),n.removeRef(this)},this.destroy=function(){this.close()},this.addEventListener=function(e,t){return void 0===r[e]?(o.error('Could not bind invalid event "'+e+'" to PeerConnection. The valid event types are:'),void o.error("	"+OTHelpers.keys(r).join(", "))):void r[e].push(t)},this.removeEventListener=function(e,t){return void 0===r[e]?(o.error('Could not unbind invalid event "'+e+'" to PeerConnection. The valid event types are:'),void o.error("	"+OTHelpers.keys(r).join(", "))):void(r[e]=OTHelpers.filter(r[e],t))},this.onaddstream=null,this.onremovestream=null,this.onicecandidate=null,this.onsignalingstatechange=null,this.oniceconnectionstatechange=null,OTHelpers.forEach(e.iceServers,function(e){e.username||(e.username=""),e.credential||(e.credential="")}),n._.initPeerConnection(s,e,t)?(d=!0,S(),b(),void i(void 0,this)):(o.error("Failed to initialise PeerConnection"),void i(new OTHelpers.error("Failed to initialise PeerConnection")))};v.create=function(e,t,n,i){new v(e,t,n,i)};var b=function(e,t,n){this.id=t.id,this.kind=t.kind,this.label=t.label,this.enabled=OTHelpers.castToBoolean(t.enabled),this.streamId=e,this.setEnabled=function(t){this.enabled=OTHelpers.castToBoolean(t),this.enabled?n._.enableMediaStreamTrack(e,this.id):n._.disableMediaStreamTrack(e,this.id)}},y=function(e,t){var n=[],i=[];this.id=e.id,t.addRef(this),e.videoTracks&&e.videoTracks.map(function(n){i.push(new b(e.id,n,t))}),e.audioTracks&&e.audioTracks.map(function(i){n.push(new b(e.id,i,t))});var o=function(e){var t="video"===e?i:n;return OTHelpers.some(t,function(e){return e.enabled})};this.getVideoTracks=function(){return i},this.getAudioTracks=function(){return n},this.getTrackById=function(e){return i.concat(n).forEach(function(t){return t.id===e?t:void 0}),null},this.hasVideo=function(){return o("video")},this.hasAudio=function(){return o("audio")},this.addTrack=function(){},this.removeTrack=function(){},this.stop=function(){t._.stopMediaStream(this.id),t.removeRef(this)},this.destroy=function(){this.stop()},this._={plugin:t,render:OTHelpers.bind(function(){return new m(t,this)},this)}};y.fromJson=function(e,t){return e?new y(JSON.parse(e),t):null};var r,E,S=function(e){var t=OTHelpers.clone(e);this.hasVideo=void 0!==t.video&&t.video!==!1,this.hasAudio=void 0!==t.audio&&t.audio!==!1,t.video===!0&&(t.video={}),t.audio===!0&&(t.audio={}),this.hasVideo&&!t.video.mandatory&&(t.video.mandatory={}),this.hasAudio&&!t.audio.mandatory&&(t.audio.mandatory={}),this.screenSharing=this.hasVideo&&("screen"===t.video.mandatory.chromeMediaSource||"window"===t.video.mandatory.chromeMediaSource),this.audio=t.audio,this.video=t.video,this.setVideoSource=function(e){void 0!==e?t.video.mandatory.sourceId=e:delete t.video},this.setAudioSource=function(e){void 0!==e?t.audio.mandatory.sourceId=e:delete t.audio},this.toHash=function(){return t}},c={},T=function(e){for(var t=e.lastChild;t&&1!==t.nodeType;)t=t.previousSibling;return t},w=function(){return"OTPlugin_loaded_"+OTHelpers.uuid().replace(/\-+/g,"")},l=function(e){if(e&&(c[e]&&(clearTimeout(c[e]),delete c[e]),t[e]))try{delete t[e]}catch(n){t[e]=void 0}},C=function(e,n,i,o){var r,s=[],a=['width="0" height="0"'];o!==!0&&a.push('visibility="hidden"'),s.push('<object type="'+n+'" '+a.join(" ")+">");for(var c in i)i.hasOwnProperty(c)&&s.push('<param name="'+c+'" value="'+i[c]+'" />');return s.push("</object>"),t.document.body.insertAdjacentHTML("beforeend",s.join("")),r=new p(T(t.document.body)),r._.setAttribute("tbCallbackId",e),r},O=function(e,n,i,r){var s,a=w();return i.onload=a,i.userAgent=OTHelpers.env.userAgent.toLowerCase(),t[a]=function(){l(a),s._.setAttribute("id","tb_plugin_"+s._.uuid),void 0!==s._.removeAttribute?s._.removeAttribute("tbCallbackId"):s._.tbCallbackId=null,s.uuid=s._.uuid,s.id=s._.id,s.onReady(function(e){return e?void o.error("Error while starting up plugin "+s.uuid+": "+e):(o.debug("Plugin "+s.id+" is loaded"),void(r&&OTHelpers.isFunction(r)&&r.call(o,null,s)))})},s=C(a,e,i,n),c[a]=setTimeout(function(){l(a),r.call(o,"The object with the mimeType of "+e+" timed out while loading."),t.document.body.removeChild(s._)},3e3),s},c={},u={},f=function(){r&&r.destroy();for(var e in u)u.hasOwnProperty(e)&&u[e].destroy()},R=function(e){if(r)throw new Error("OTPlugin.createMediaCaptureController called multiple times!");return r=O(o.meta.mimeType,!1,{windowless:!1},e),r.selectSources=function(){return this._.selectSources.apply(this._,arguments)},r},I=function(e){var t=O(o.meta.mimeType,!0,{windowless:!0},function(t,n){return t?void e.call(o,t):(u[n.id]=n,void e.call(o,null,n))});return t};!function(){var t,n,i=-1,r=function(e,t){if(e===t)return!1;if(-1===e)return t;if(-1===t)return e;if(-1===e.indexOf(".")&&-1===t.indexOf("."))return e>t;for(var n=e.split("."),i=t.split("."),o=(n.length>i.length?i:n).length,r=0;o>r;++r)if(parseInt(n[r],10)>parseInt(i[r],10))return!0;return r<n.length?!0:!1},s=function(){if(void 0!==n)return n;var e="TokBox.otiePluginInstaller",t="otiePluginInstaller",o="application/x-otieplugininstaller",s=navigator.plugins[e]||navigator.plugins[t];if(i=-1,s)for(var a,c,u=s.length,d=new RegExp(o.replace("-","\\-")+",version=([0-9a-zA-Z-_.]+)","i"),l=0;u>l;++l)a=s[l],a&&a.enabledPlugin&&a.enabledPlugin.name===s.name&&-1!==a.type.indexOf(o)&&(c=d.exec(a.type),null!==c&&r(c[1],i)&&(i=c[1]));else if("IE"===OTHelpers.env.name)try{s=new ActiveXObject(e),i=s.getMasterVersion()}catch(h){}n=-1!==i?o+",version="+i:null},a=function(){return void 0===n&&s(),n},c=function(){return void 0===i&&s(),i},u=function(){var e=!r(c(),"0.4.0.4");return u=function(){return e},e};E=function(){var t,n=function(e){return function(){return t?e(void 0,arguments):void O(a(),!1,{windowless:!1},function(n,i){return t=i,n?void o.error("Error while loading the AutoUpdater: "+n):e.apply(void 0,arguments)})}};this.isOutOfDate=function(){return r(o.meta.version,c())},this.autoUpdate=n(function(){var n=OT.Dialogs.Plugin.updateInProgress(),i=new OT.Analytics,r={ieVersion:OTHelpers.env.version,pluginOldVersion:o.installedVersion(),pluginNewVersion:o.version()},s=d(function(){i.logEvent({action:"OTPluginAutoUpdate",variation:"Success",partnerId:OT.APIKEY,payload:JSON.stringify(r)}),t.destroy(),n.close(),OT.Dialogs.Plugin.updateComplete().on({reload:function(){e.location.reload()}})}),a=d(function(e,s,a){r.errorCode=e,r.systemErrorCode=a,i.logEvent({action:"OTPluginAutoUpdate",variation:"Failure",partnerId:OT.APIKEY,payload:JSON.stringify(r)}),t.destroy(),n.close();var c=s+" ("+e+"). Please restart your browser and try again.";n=OT.Dialogs.Plugin.updateComplete(c).on({reload:function(){n.close()}}),o.error("autoUpdate failed: "+s+" ("+e+"). Please restart your browser and try again.")}),c=d(function(e){n.setUpdateProgress(e.toFixed())});t._.updatePlugin(o.pathToInstaller(),s,a,c)}),this.destroy=function(){t&&t.destroy()},navigator.plugins&&navigator.plugins.refresh(!1)},E.get=function(e){if(!t){if(!this.isinstalled())return void e.call(null,"Plugin was not installed");t=new E}e.call(null,void 0,t)},E.isinstalled=function(){return null!==a()&&!u()},E.installedVersion=function(){return c()}}();var A=[],P=function(){f()},D=function(e){A.push(e)},N=function(e){for(var t;(t=A.pop())&&OTHelpers.isFunction(t);)t.call(o,e)},_=function(){E.get(function(e,t){return e?(o.error("Error while loading the AutoUpdater: "+e),void N("Error while loading the AutoUpdater: "+e)):t.isOutOfDate()?void t.autoUpdate():void R(function(e){e||!r||r.isValid()||(e="The TB Plugin failed to load properly"),i=!0,N(e),OTHelpers.onDOMUnload(P)})})};o.isInstalled=function(){return this.isSupported()?E.isinstalled():!1},o.version=function(){return o.meta.version},o.installedVersion=function(){return E.installedVersion()},o.pathToInstaller=function(){return"https://s3.amazonaws.com/otplugin.tokbox.com/v"+o.meta.version+"/otiePluginMain.msi"},o.ready=function(e){if(o.isReady()){var t;r&&r.isValid()||(t="The TB Plugin failed to load properly"),e.call(o,t)}else D(e)};var $=function(e,t,n){I(function(i,r){return i?void n.call(o,i):void r._.getUserMedia(e.toHash(),function(e){t.call(o,y.fromJson(e,r))},n)})};o.getUserMedia=function(e,t,n){var i=new S(e);if(i.screenSharing)$(i,t,n);else{var s=[];i.hasVideo&&s.push("video"),i.hasAudio&&s.push("audio"),r.selectSources(s,function(e){for(var r in e)e.hasOwnProperty(r)&&o.debug(r+" Capture Device: "+e[r]);i.setVideoSource(e.video),i.setAudioSource(e.audio),$(i,t,n)},n)}},o.initRumorSocket=function(e,t){o.ready(function(n){n?t(n):t(null,new a(r,e))})},o.initPeerConnection=function(e,t,n,i){var r=function(n,r){return n?void i.call(o,n):(o.debug("Got PeerConnection for "+r.id),void v.create(e,t,r,function(e,t){return e?void i.call(o,e):void i.call(o,null,t)}))};n&&n._.plugin?r(null,n._.plugin):I(r)},o.RTCSessionDescription=function(e){this.type=e.type,this.sdp=e.sdp},o.RTCIceCandidate=function(e){this.sdpMid=e.sdpMid,this.sdpMLineIndex=parseInt(e.sdpMLineIndex,10),this.candidate=e.candidate},s(),OTHelpers.onDOMLoad(_)}}(this),!function(e,t){function n(e){for(var t=new ArrayBuffer(e.length),n=new Uint8Array(t),i=0;i<e.length;++i)n[i]=e[i];return t}function i(e){function n(e,n,i){var o=new XMLHttpRequest,r=n||{},s=r.method;if(!s)return void i(new t.$.Error("No HTTP method specified in options"));i&&(OTHelpers.on(o,"load",function(e){var t=e.target.status;t>=200&&(300>t||304===t)?i(null,e):i(e)}),OTHelpers.on(o,"error",i)),o.open(n.method,e,!0),r.headers||(r.headers={});for(var a in r.headers)o.setRequestHeader(a,r.headers[a]);return o}function i(e){return new Promise(function(t){setTimeout(function(){t()},e)})}function o(){var e=1e9,t=9999999999;return e+Math.floor(Math.random()*(t-e))}function r(){var e,r,s=0,c=new Promise(function(i,c){e=n([a.downloadUrl,"?x=",o()].join(""),{method:"get"},function(e){e?c(new t.$.Error("Connection to the HTTP server failed ("+e.target.status+")",1006)):i()}),e.addEventListener("loadstart",function(){r=t.$.now()}),e.addEventListener("progress",function(e){s=e.loaded}),e.send()});return Promise.race([c,i(1e3*a.duration)]).then(function(){return e.abort(),{byteDownloaded:s,duration:t.$.now()-r}})}function s(){var e,o,r=new Array(a.uploadSize*a.uploadCount).join("a"),s=0,c=new Promise(function(i,c){e=n(a.uploadUrl,{method:"post"},function(e){e?c(new t.$.Error("Connection to the HTTP server failed ("+e.target.status+")",1006)):i()}),e.upload.addEventListener("loadstart",function(){o=t.$.now()}),e.upload.addEventListener("progress",function(e){s=e.loaded}),e.send(r)});return Promise.race([c,i(1e3*a.duration)]).then(function(){return e.abort(),{byteUploaded:s,duration:t.$.now()-o}})}var a=e.httpConfig;return Promise.all([r(),s()]).then(function(e){var t=e[0],n=e[1];return{downloadBandwidth:8e3*t.byteDownloaded/t.duration,uploadBandwidth:8e3*n.byteUploaded/n.duration}})}function o(e){return e.hasOwnProperty("googFrameWidthReceived")||e.hasOwnProperty("googFrameWidthInput")||"video"===e.mediaType}function r(e){return e.hasOwnProperty("audioInputLevel")||e.hasOwnProperty("audioOutputLevel")||"audio"===e.mediaType}function s(e){return e.hasOwnProperty("bytesReceived")}function a(e){var t={packetsLost:0,packetsReceived:0,bytesReceived:0};return e.hasOwnProperty("packetsReceived")&&(t.packetsReceived=parseInt(e.packetsReceived,10)),e.hasOwnProperty("packetsLost")&&(t.packetsLost=parseInt(e.packetsLost,10)),e.hasOwnProperty("bytesReceived")&&(t.bytesReceived+=parseInt(e.bytesReceived,10)),t}function c(e){return t.$.isObject(e)&&"getTime"in e?e.getTime():e}function u(){function e(e,t){e.getStats(function(e){var n=[];e.result().forEach(function(e){var t={};e.names().forEach(function(n){t[n]=e.stat(n)}),t.id=e.id,t.type=e.type,t.timestamp=e.timestamp,n.push(t)}),t(null,n)})}function n(e,t){e.getStats(null,function(e){var n=[];e.forEach(function(e){n.push(e)}),t(null,n)},t)}return"Firefox"===t.$.browserVersion().name||OTPlugin.isInstalled()?n:e}function d(n){function i(e){return-1!==e.candidate.indexOf("relay")}function o(){var e=new t.VideoElement({attributes:{muted:!0}});return e.domElement().style.position="absolute",e.domElement().style.top="-9999%",e.appendTo(document.body),e}function r(){return new Promise(function(e,n){t.$.createPeerConnection({iceServers:b.iceServers},{},null,function(i,o){i?n(new t.$.Error("createPeerConnection failed",1600,i)):e(o)})})}function s(e){return new Promise(function(t,n){e.createOffer(t,n)})}function a(e,n){return new Promise(function(i,o){e.bindToStream(n,function(e){e?o(new t.$.Error("bindToStream failed",1600,e)):i()})})}function c(e,t){return new Promise(function(n,i){e.addIceCandidate(new g({sdpMLineIndex:t.sdpMLineIndex,candidate:t.candidate}),n,i)})}function u(e,n){return new Promise(function(i,o){e.setLocalDescription(n,i,function(e){o(new t.$.Error("setLocalDescription failed",1600,e))})})}function d(e,n){return new Promise(function(i,o){e.setRemoteDescription(n,i,function(e){o(new t.$.Error("setRemoteDescription failed",1600,e))})})}function l(e){return new Promise(function(n,i){e.createAnswer(n,function(e){i(new t.$.Error("createAnswer failed",1600,e))})})}function h(e){return new Promise(function(n,i){v(e,function(e,o){e?i(new t.$.Error("geStats failed",1600,e)):n(o)})})}function f(e){return function(n){n.candidate&&i(n.candidate)&&c(e,n.candidate)["catch"](function(){t.warn("An error occurred while adding a ICE candidate during webrtc test")})}}function p(e,n){var i=1e3;return new Promise(function(o){function r(){return 1e3*u.bytesReceived*8/(t.$.now()-u.startTs)}function s(){Promise.all([h(e).then(function(e){t.$.forEach(e,function(e){if(t.getStatsHelpers.isVideoStat(e)){var n=null;e.hasOwnProperty("googRtt")?n=parseInt(e.googRtt,10):e.hasOwnProperty("mozRtt")&&(n=e.mozRtt),null!==n&&n>-1&&(u.roundTripTimeSamplesCount++,u.roundTripTime+=n)}})}),h(n).then(function(e){t.$.forEach(e,function(e){if(t.getStatsHelpers.isVideoStat(e)){if(e.hasOwnProperty("packetsReceived")&&e.hasOwnProperty("packetsLost")){var n=parseInt(e.packetsLost,10),i=parseInt(e.packetsReceived,10);n>=0&&i>0&&(u.packetLostRatioSamplesCount++,u.packetLostRatio+=100*n/i)}e.hasOwnProperty("bytesReceived")&&(u.bytesReceived+=parseInt(e.bytesReceived,10))}})})]).then(function(){setTimeout(function(){c&&s()},i)})}function a(){c=!1;var e={packetLostRatio:u.packetLostRatioSamplesCount>0?u.packetLostRatio/=100*u.packetLostRatioSamplesCount:null,roundTripTime:u.roundTripTimeSamplesCount>0?u.roundTripTime/=u.roundTripTimeSamplesCount:null,bandwidth:r()};o(e)}var c=!0,u={startTs:t.$.now(),packetLostRatioSamplesCount:0,packetLostRatio:0,roundTripTimeSamplesCount:0,roundTripTime:0,bytesReceived:0};s(),setTimeout(function(){r()<b.thresholdBitsPerSecond?setTimeout(a,1e3*b.extendedDuration):a()},1e3*b.duration)})}var m,g,v=t.getStatsAdpater(),b=n.mediaConfig,y=n.localStream;return OTPlugin.isInstalled()?(m=OTPlugin.RTCSessionDescription,g=OTPlugin.RTCIceCandidate):(m=e.mozRTCSessionDescription||e.RTCSessionDescription,g=e.mozRTCIceCandidate||e.RTCIceCandidate),Promise.all([r(),r()]).then(function(e){function t(){r.destroy(),c.destroy(),n.close(),i.close()}var n=e[0],i=e[1],r=o(),c=o();a(r,y),n.addStream(y);var h;return i.onaddstream=function(e){h=e.stream,a(c,h)},n.onicecandidate=f(i),i.onicecandidate=f(n),s(n).then(function(e){return Promise.all([u(n,e),d(i,e)])}).then(function(){return l(i)}).then(function(e){return Promise.all([u(i,e),d(n,e)])}).then(function(){return p(n,i)}).then(function(e){return t(),e},function(e){throw t(),e})})}function l(e,t){this.code=e,this.message=t,this.reason=t}var t=e.OT||{};t.APIKEY=function(){var e=function(){var e=document.getElementsByTagName("script");return e=e[e.length-1],e=e.getAttribute("src")||e.src}(),t=e.match(/[\?\&]apikey=([^&]+)/i);return t?t[1]:""}(),e.OT||(e.OT=t),e.TB||(e.TB=t),t.properties={version:"v2.4.1",build:"835a972",debug:"false",websiteURL:"http://www.tokbox.com",cdnURL:"http://static.opentok.com",loggingURL:"http://hlg.tokbox.com/prod",apiURL:"http://anvil.opentok.com",messagingProtocol:"wss",messagingPort:443,supportSSL:"true",cdnURLSSL:"https://static.opentok.com",loggingURLSSL:"https://hlg.tokbox.com/prod",apiURLSSL:"https://anvil.opentok.com",minimumVersion:{firefox:parseFloat("29"),chrome:parseFloat("34")}},t.$=e.OTHelpers,t.$.eventing(t),t.$.defineGetters=function(e,t,n){var i={};void 0===n&&(n=!1);for(var o in t)t.hasOwnProperty(o)&&(i[o]={get:t[o],enumerable:n});Object.defineProperties(e,i)},t.Modal=t.$.Modal,t.$.useLogHelpers(t);var h=!1,f=t.setLogLevel;t.setLogLevel=function(e){t.$.setLogLevel(e);var n=f.call(t,e);return t.shouldLog(t.DEBUG)&&!h&&(t.debug("OpenTok JavaScript library "+t.properties.version),t.debug("Release notes: "+t.properties.websiteURL+"/opentok/webrtc/docs/js/release-notes.html"),t.debug("Known issues: "+t.properties.websiteURL+"/opentok/webrtc/docs/js/release-notes.html#knownIssues"),h=!0),t.debug("OT.setLogLevel("+n+")"),n};var p="true"===t.properties.debug||t.properties.debug===!0;t.setLogLevel(p?t.DEBUG:t.ERROR),OTPlugin&&OTPlugin.isInstalled()&&(t.$.env.userAgent+="; OTPlugin "+OTPlugin.version()),t.$.userAgent=function(){return t.$.env.userAgent},t.Rumor={MessageType:{SUBSCRIBE:0,UNSUBSCRIBE:1,MESSAGE:2,CONNECT:3,DISCONNECT:4,PING:7,PONG:8,STATUS:9}},!function(){t.Rumor.PluginSocket=function(e,n){var i,o="initializing";OTPlugin.initRumorSocket(e,t.$.bind(function(e,r){e?(o="closed",n.onClose({code:4999})):"initializing"===o?(i=r,i.onOpen(function(){o="open",n.onOpen()}),i.onClose(function(e){o="closed",n.onClose({code:e})}),i.onError(function(e){o="closed",n.onError(e),n.onClose({code:e})}),i.onMessage(function(e,i,o,r){var s=new t.Rumor.Message(e,i,o,r);n.onMessage(s)}),i.open()):this.close()},this)),this.close=function(){return"initializing"===o||"closed"===o?void(o="closed"):void i.close(1e3,"")},this.send=function(e){"open"===o&&i.send(e)},this.isClosed=function(){return"closed"===o}}}(this),function(e){"use strict";function n(e,t,n){return e>=t&&n>=e}function i(e,t){return Math.floor(e/t)}function o(e){var t=0;this.get=function(){return t>=e.length?v:Number(e[t])},this.offset=function(n){if(t+=n,0>t)throw new Error("Seeking past start of the buffer");if(t>e.length)throw new Error("Seeking past EOF")},this.match=function(n){if(n.length>t+e.length)return!1;var i;for(i=0;i<n.length;i+=1)if(Number(e[t+i])!==n[i])return!1;return!0}}function r(e){var t=0;this.emit=function(){var n,i=v;for(n=0;n<arguments.length;++n)i=Number(arguments[n]),e[t++]=i;return i}}function s(e){function t(e){for(var t=[],i=0,o=e.length;i<e.length;){var r=e.charCodeAt(i);if(n(r,55296,57343))if(n(r,56320,57343))t.push(65533);else if(i===o-1)t.push(65533);else{var s=e.charCodeAt(i+1);if(n(s,56320,57343)){var a=1023&r,c=1023&s;i+=1,t.push(65536+(a<<10)+c)}else t.push(65533)}else t.push(r);i+=1}return t}var i=0,o=t(e);this.offset=function(e){if(i+=e,0>i)throw new Error("Seeking past start of the buffer");if(i>o.length)throw new Error("Seeking past EOF")},this.get=function(){return i>=o.length?b:o[i]}}function a(){var e="";this.string=function(){return e},this.emit=function(t){65535>=t?e+=String.fromCharCode(t):(t-=65536,e+=String.fromCharCode(55296+(t>>10&1023)),e+=String.fromCharCode(56320+(1023&t)))}}function c(e){this.name="EncodingError",this.message=e,this.code=0}function u(e,t){if(e)throw new c("Decoder error");return t||65533}function d(e){throw new c("The code point "+e+" could not be encoded.")}function l(e){return e=String(e).trim().toLowerCase(),Object.prototype.hasOwnProperty.call(S,e)?S[e]:null}function h(e){var t=e.fatal,i=0,o=0,r=0,s=0;this.decode=function(e){var a=e.get();if(a===v)return 0!==o?u(t):b;if(e.offset(1),0===o){if(n(a,0,127))return a;if(n(a,194,223))o=1,s=128,i=a-192;else if(n(a,224,239))o=2,s=2048,i=a-224;else{if(!n(a,240,244))return u(t);o=3,s=65536,i=a-240}return i*=Math.pow(64,o),null}if(!n(a,128,191))return i=0,o=0,r=0,s=0,e.offset(-1),u(t);if(r+=1,i+=(a-128)*Math.pow(64,o-r),r!==o)return null;var c=i,d=s;return i=0,o=0,r=0,s=0,n(c,d,1114111)&&!n(c,55296,57343)?c:u(t)}}function f(e){e.fatal,this.encode=function(e,t){var o=t.get();if(o===b)return v;if(t.offset(1),n(o,55296,57343))return d(o);if(n(o,0,127))return e.emit(o);var r,s;n(o,128,2047)?(r=1,s=192):n(o,2048,65535)?(r=2,s=224):n(o,65536,1114111)&&(r=3,s=240);for(var a=e.emit(i(o,Math.pow(64,r))+s);r>0;){var c=i(o,Math.pow(64,r-1));a=e.emit(128+c%64),r-=1}return a}}function p(e,t){return t.match([255,254])&&"utf-16"===e?void t.offset(2):t.match([254,255])&&"utf-16be"==e?void t.offset(2):t.match([239,187,191])&&"utf-8"==e?void t.offset(3):void 0}function m(t,n){if(!this||this===e)return new m(t,n);if(t=t?String(t):T,n=Object(n),this._encoding=l(t),null===this._encoding||"utf-8"!==this._encoding.name&&"utf-16"!==this._encoding.name&&"utf-16be"!==this._encoding.name)throw new TypeError("Unknown encoding: "+t);return this._streaming=!1,this._encoder=null,this._options={fatal:Boolean(n.fatal)},Object.defineProperty?Object.defineProperty(this,"encoding",{get:function(){return this._encoding.name
}}):this.encoding=this._encoding.name,this}function g(t,n){if(!this||this===e)return new g(t,n);if(t=t?String(t):T,n=Object(n),this._encoding=l(t),null===this._encoding)throw new TypeError("Unknown encoding: "+t);return this._streaming=!1,this._decoder=null,this._options={fatal:Boolean(n.fatal)},Object.defineProperty?Object.defineProperty(this,"encoding",{get:function(){return this._encoding.name}}):this.encoding=this._encoding.name,this}if(!(t.$.env&&"IE"===t.$.env.name&&t.$.env.version<10||void 0!==e.TextEncoder&&void 0!==e.TextDecoder)){var v=-1,b=-1;c.prototype=Error.prototype;var y=[{encodings:[{labels:["unicode-1-1-utf-8","utf-8","utf8"],name:"utf-8"}],heading:"The Encoding"},{encodings:[{labels:["cp864","ibm864"],name:"ibm864"},{labels:["cp866","ibm866"],name:"ibm866"},{labels:["csisolatin2","iso-8859-2","iso-ir-101","iso8859-2","iso_8859-2","l2","latin2"],name:"iso-8859-2"},{labels:["csisolatin3","iso-8859-3","iso_8859-3","iso-ir-109","l3","latin3"],name:"iso-8859-3"},{labels:["csisolatin4","iso-8859-4","iso_8859-4","iso-ir-110","l4","latin4"],name:"iso-8859-4"},{labels:["csisolatincyrillic","cyrillic","iso-8859-5","iso_8859-5","iso-ir-144"],name:"iso-8859-5"},{labels:["arabic","csisolatinarabic","ecma-114","iso-8859-6","iso_8859-6","iso-ir-127"],name:"iso-8859-6"},{labels:["csisolatingreek","ecma-118","elot_928","greek","greek8","iso-8859-7","iso_8859-7","iso-ir-126"],name:"iso-8859-7"},{labels:["csisolatinhebrew","hebrew","iso-8859-8","iso-8859-8-i","iso-ir-138","iso_8859-8","visual"],name:"iso-8859-8"},{labels:["csisolatin6","iso-8859-10","iso-ir-157","iso8859-10","l6","latin6"],name:"iso-8859-10"},{labels:["iso-8859-13"],name:"iso-8859-13"},{labels:["iso-8859-14","iso8859-14"],name:"iso-8859-14"},{labels:["iso-8859-15","iso_8859-15"],name:"iso-8859-15"},{labels:["iso-8859-16"],name:"iso-8859-16"},{labels:["koi8-r","koi8_r"],name:"koi8-r"},{labels:["koi8-u"],name:"koi8-u"},{labels:["csmacintosh","mac","macintosh","x-mac-roman"],name:"macintosh"},{labels:["iso-8859-11","tis-620","windows-874"],name:"windows-874"},{labels:["windows-1250","x-cp1250"],name:"windows-1250"},{labels:["windows-1251","x-cp1251"],name:"windows-1251"},{labels:["ascii","ansi_x3.4-1968","csisolatin1","iso-8859-1","iso8859-1","iso_8859-1","l1","latin1","us-ascii","windows-1252"],name:"windows-1252"},{labels:["cp1253","windows-1253"],name:"windows-1253"},{labels:["csisolatin5","iso-8859-9","iso-ir-148","l5","latin5","windows-1254"],name:"windows-1254"},{labels:["cp1255","windows-1255"],name:"windows-1255"},{labels:["cp1256","windows-1256"],name:"windows-1256"},{labels:["windows-1257"],name:"windows-1257"},{labels:["cp1258","windows-1258"],name:"windows-1258"},{labels:["x-mac-cyrillic","x-mac-ukrainian"],name:"x-mac-cyrillic"}],heading:"Legacy single-byte encodings"},{encodings:[{labels:["chinese","csgb2312","csiso58gb231280","gb2312","gbk","gb_2312","gb_2312-80","iso-ir-58","x-gbk"],name:"gbk"},{labels:["gb18030"],name:"gb18030"},{labels:["hz-gb-2312"],name:"hz-gb-2312"}],heading:"Legacy multi-byte Chinese (simplified) encodings"},{encodings:[{labels:["big5","big5-hkscs","cn-big5","csbig5","x-x-big5"],name:"big5"}],heading:"Legacy multi-byte Chinese (traditional) encodings"},{encodings:[{labels:["cseucpkdfmtjapanese","euc-jp","x-euc-jp"],name:"euc-jp"},{labels:["csiso2022jp","iso-2022-jp"],name:"iso-2022-jp"},{labels:["csshiftjis","ms_kanji","shift-jis","shift_jis","sjis","windows-31j","x-sjis"],name:"shift_jis"}],heading:"Legacy multi-byte Japanese encodings"},{encodings:[{labels:["cseuckr","csksc56011987","euc-kr","iso-ir-149","korean","ks_c_5601-1987","ks_c_5601-1989","ksc5601","ksc_5601","windows-949"],name:"euc-kr"},{labels:["csiso2022kr","iso-2022-kr"],name:"iso-2022-kr"}],heading:"Legacy multi-byte Korean encodings"},{encodings:[{labels:["utf-16","utf-16le"],name:"utf-16"},{labels:["utf-16be"],name:"utf-16be"}],heading:"Legacy utf-16 encodings"}],E={},S={};y.forEach(function(e){e.encodings.forEach(function(e){E[e.name]=e,e.labels.forEach(function(t){S[t]=e})})}),e["encoding-indexes"]||{},E["utf-8"].getEncoder=function(e){return new f(e)},E["utf-8"].getDecoder=function(e){return new h(e)};var T="utf-8";m.prototype={encode:function(e,t){e=e?String(e):"",t=Object(t),this._streaming||(this._encoder=this._encoding.getEncoder(this._options)),this._streaming=Boolean(t.stream);for(var n=[],i=new r(n),o=new s(e);o.get()!==b;)this._encoder.encode(i,o);if(!this._streaming){var a;do a=this._encoder.encode(i,o);while(a!==v);this._encoder=null}return new Uint8Array(n)}},g.prototype={decode:function(e,t){if(e&&!("buffer"in e&&"byteOffset"in e&&"byteLength"in e))throw new TypeError("Expected ArrayBufferView");e||(e=new Uint8Array(0)),t=Object(t),this._streaming||(this._decoder=this._encoding.getDecoder(this._options)),this._streaming=Boolean(t.stream);var n=new Uint8Array(e.buffer,e.byteOffset,e.byteLength),i=new o(n);this._BOMseen||(this._BOMseen=!0,p(this._encoding.name,i));for(var r,s=new a;i.get()!==v;)r=this._decoder.decode(i),null!==r&&r!==b&&s.emit(r);if(!this._streaming){do r=this._decoder.decode(i),null!==r&&r!==b&&s.emit(r);while(r!==b&&i.get()!=v);this._decoder=null}return s.string()}},e.TextEncoder=e.TextEncoder||m,e.TextDecoder=e.TextDecoder||g}}(this),t.Rumor.Message=function(e,t,n,i){this.type=e,this.toAddress=t,this.headers=n,this.data=i,this.transactionId=this.headers["TRANSACTION-ID"],this.status=this.headers.STATUS,this.isError=!(this.status&&"2"===this.status[0])},t.Rumor.Message.prototype.serialize=function(){var e,t,n,i,o=8,r=7,s=[],a=[],c=[];for(r++,n=0;n<this.toAddress.length;n++)s.push(new TextEncoder("utf-8").encode(this.toAddress[n])),r+=2,r+=s[n].length;r++,n=0;for(var u in this.headers)this.headers.hasOwnProperty(u)&&(a.push(new TextEncoder("utf-8").encode(u)),c.push(new TextEncoder("utf-8").encode(this.headers[u])),r+=4,r+=a[n].length,r+=c[n].length,n++);t=new TextEncoder("utf-8").encode(this.data),r+=t.length;var d=new ArrayBuffer(r),l=new Uint8Array(d,0,r);for(r-=4,l[0]=(4278190080&r)>>>24,l[1]=(16711680&r)>>>16,l[2]=(65280&r)>>>8,l[3]=(255&r)>>>0,l[4]=0,l[5]=0,l[6]=this.type,l[7]=this.toAddress.length,n=0;n<s.length;n++)for(e=s[n],l[o++]=e.length>>8&255,l[o++]=e.length>>0&255,i=0;i<e.length;i++)l[o++]=e[i];for(l[o++]=a.length,n=0;n<a.length;n++){for(e=a[n],l[o++]=e.length>>8&255,l[o++]=e.length>>0&255,i=0;i<e.length;i++)l[o++]=e[i];for(e=c[n],l[o++]=e.length>>8&255,l[o++]=e.length>>0&255,i=0;i<e.length;i++)l[o++]=e[i]}for(n=0;n<t.length;n++)l[o++]=t[n];return d},t.Rumor.Message.deserialize=function(e){"undefined"!=typeof Buffer&&Buffer.isBuffer(e)&&(e=n(e));var i,o,r,s,a,c,u,d,l=0,h=8,f=new Uint8Array(e);l+=f[0]<<24,l+=f[1]<<16,l+=f[2]<<8,l+=f[3]<<0,i=f[6];var p=[];for(d=0;d<f[7];d++)u=f[h++]<<8,u+=f[h++],o=new Uint8Array(e,h,u),p[d]=new TextDecoder("utf-8").decode(o),h+=u;for(r=f[h++],s={},d=0;r>d;d++)u=f[h++]<<8,u+=f[h++],o=new Uint8Array(e,h,u),a=new TextDecoder("utf-8").decode(o),h+=u,u=f[h++]<<8,u+=f[h++],o=new Uint8Array(e,h,u),c=new TextDecoder("utf-8").decode(o),s[a]=c,h+=u;var m=new Uint8Array(e,h),g=new TextDecoder("utf-8").decode(m);return new t.Rumor.Message(i,p,s,g)},t.Rumor.Message.Connect=function(e,n){var i={uniqueId:e,notifyDisconnectAddress:n};return new t.Rumor.Message(t.Rumor.MessageType.CONNECT,[],i,"")},t.Rumor.Message.Disconnect=function(){return new t.Rumor.Message(t.Rumor.MessageType.DISCONNECT,[],{},"")},t.Rumor.Message.Subscribe=function(e){return new t.Rumor.Message(t.Rumor.MessageType.SUBSCRIBE,e,{},"")},t.Rumor.Message.Unsubscribe=function(e){return new t.Rumor.Message(t.Rumor.MessageType.UNSUBSCRIBE,e,{},"")},t.Rumor.Message.Publish=function(e,n,i){return new t.Rumor.Message(t.Rumor.MessageType.MESSAGE,e,i||{},n||"")},t.Rumor.Message.Ping=function(){return new t.Rumor.Message(t.Rumor.MessageType.PING,[],{},"")},!function(){var e=100,n=10;t.Rumor.NativeSocket=function(i,o,r){var s,a,c,u;s=new i(o),s.binaryType="arraybuffer",s.onopen=r.onOpen,s.onclose=r.onClose,s.onerror=r.onError,s.onmessage=function(e){if(t){var n=t.Rumor.Message.deserialize(e.data);r.onMessage(n)}},a=function d(t){s&&(void 0===t&&(t=0),c&&clearTimeout(c),s.bufferedAmount>0&&n>=t+1?c=setTimeout(d,e,t+1):u())},u=function(){s.close()},this.close=function(e){e?a():u()},this.send=function(e){s.send(e.serialize())},this.isClosed=function(){return 3===s.readyState}}}(this);var m,g=9e3,v=5*g-100;m={1002:"The endpoint is terminating the connection due to a protocol error. (CLOSE_PROTOCOL_ERROR)",1003:"The connection is being terminated because the endpoint received data of a type it cannot accept (for example, a text-only endpoint received binary data). (CLOSE_UNSUPPORTED)",1004:"The endpoint is terminating the connection because a data frame was received that is too large. (CLOSE_TOO_LARGE)",1005:"Indicates that no status code was provided even though one was expected. (CLOSE_NO_STATUS)",1006:"Used to indicate that a connection was closed abnormally (that is, with no close frame being sent) when a status code is expected. (CLOSE_ABNORMAL)",1007:"Indicates that an endpoint is terminating the connection because it has received data within a message that was not consistent with the type of the message (e.g., non-UTF-8 [RFC3629] data within a text message)",1008:"Indicates that an endpoint is terminating the connection because it has received a message that violates its policy.  This is a generic status code that can be returned when there is no other more suitable status code (e.g., 1003 or 1009) or if there is a need to hide specific details about the policy",1009:"Indicates that an endpoint is terminating the connection because it has received a message that is too big for it to process",1011:"Indicates that a server is terminating the connection because it encountered an unexpected condition that prevented it from fulfilling the request",4001:"Connectivity loss was detected as it was too long since the socket received the last PONG message"},t.Rumor.SocketError=function(e,t){this.code=e,this.message=t},t.Rumor.Socket=function(n,i,o){var r,s,a,c,u,d,l,h,f,p,b=["disconnected","error","connected","connecting","disconnecting"],y=function(e){switch(e){case"disconnected":case"error":if(r=null,u){var t;w()&&(t=new Error(m[4001]),t.code=4001),u(t)}}},E=t.$.statable(this,b,"disconnected",y),S=function(e,n){if(null===n||!t.$.isFunction(n))throw new Error("The Rumor.Socket "+e+" callback must be a valid function or null")},T=t.$.bind(function(e){t.error("Rumor.Socket: "+e);var n=new t.Rumor.SocketError(null,e||"Unknown Socket Error");h&&clearTimeout(h),E("error"),"connecting"===this.previousState&&l&&(l(n,void 0),l=null),c&&c(n)},this),w=function(){return f?t.$.now()-f>=v:!1},C=t.$.bind(function(){this.is("connected")&&(w()?P({code:4001}):(r.send(t.Rumor.Message.Ping()),p=setTimeout(C,g)))},this),O=function(){return!e.OT},R=t.$.bind(function(){return h&&clearTimeout(h),this.isNot("connecting")?void t.debug("webSocketConnected reached in state other than connecting"):(r.send(t.Rumor.Message.Connect(s,i)),E("connected"),l&&(l(void 0,s),l=null),a&&a(s),void(p=setTimeout(function(){f=t.$.now(),C()},g)))},this),I=function(){var e=r;T("Timed out while waiting for the Rumor socket to connect.");try{e.close()}catch(t){}},A=function(){},P=t.$.bind(function(e){if(h&&clearTimeout(h),p&&clearTimeout(p),!O()){if(1e3!==e.code&&1001!==e.code){var t=e.reason||e.message;!t&&m.hasOwnProperty(e.code)&&(t=m[e.code]),T("Rumor Socket Disconnected: "+t)}this.isNot("error")&&E("disconnected")}},this),D=function(e){f=t.$.now(),d&&e.type!==t.Rumor.MessageType.PONG&&d(e)};this.publish=function(e,n,i){r.send(t.Rumor.Message.Publish(e,n,i))},this.subscribe=function(e){r.send(t.Rumor.Message.Subscribe(e))},this.unsubscribe=function(e){r.send(t.Rumor.Message.Unsubscribe(e))},this.connect=function(i,a){if(this.is("connecting","connected"))return void a(new t.Rumor.SocketError(null,"Rumor.Socket cannot connect when it is already connecting or connected."));s=i,l=a,E("connecting");var c=o||e.WebSocket,u={onOpen:R,onClose:P,onError:A,onMessage:D};try{r="undefined"!=typeof c?new t.Rumor.NativeSocket(c,n,u):new t.Rumor.PluginSocket(n,u),h=setTimeout(I,t.Rumor.Socket.CONNECT_TIMEOUT)}catch(d){t.error(d),T("Could not connect to the Rumor socket, possibly because of a blocked port.")}},this.disconnect=function(e){return h&&clearTimeout(h),p&&clearTimeout(p),r?void(r.isClosed()?this.isNot("error")&&E("disconnected"):(this.is("connected")&&r.send(t.Rumor.Message.Disconnect()),r.close(e))):void(this.isNot("error")&&E("disconnected"))},t.$.defineProperties(this,{id:{get:function(){return s}},onOpen:{set:function(e){S("onOpen",e),a=e},get:function(){return a}},onError:{set:function(e){S("onError",e),c=e},get:function(){return c}},onClose:{set:function(e){S("onClose",e),u=e},get:function(){return u}},onMessage:{set:function(e){S("onMessage",e),d=e},get:function(){return d}}})},t.Rumor.Socket.CONNECT_TIMEOUT=15e3,t.Raptor={Actions:{CONNECT:100,CREATE:101,UPDATE:102,DELETE:103,STATE:104,FORCE_DISCONNECT:105,FORCE_UNPUBLISH:106,SIGNAL:107,CREATE_ARCHIVE:108,CLOSE_ARCHIVE:109,START_RECORDING_SESSION:110,STOP_RECORDING_SESSION:111,START_RECORDING_STREAM:112,STOP_RECORDING_STREAM:113,LOAD_ARCHIVE:114,START_PLAYBACK:115,STOP_PLAYBACK:116,APPSTATE_PUT:117,APPSTATE_DELETE:118,OFFER:119,ANSWER:120,PRANSWER:121,CANDIDATE:122,SUBSCRIBE:123,UNSUBSCRIBE:124,QUERY:125,SDP_ANSWER:126,PONG:127,REGISTER:128,QUALITY_CHANGED:129},Types:{RPC_REQUEST:100,RPC_RESPONSE:101,STREAM:102,ARCHIVE:103,CONNECTION:104,APPSTATE:105,CONNECTIONCOUNT:106,MODERATION:107,SIGNAL:108,SUBSCRIBER:110,JSEP:109}},t.Raptor.serializeMessage=function(e){return JSON.stringify(e)},t.Raptor.deserializeMessage=function(e){if(0===e.length)return{};var t=JSON.parse(e),n=t.uri.substr(1).split("/");n.shift(),""===n[n.length-1]&&n.pop(),t.params={};for(var i=0,o=n.length;o-1>i;i+=2)t.params[n[i]]=n[i+1];return t.resource=n.length%2===0?"channel"===n[n.length-2]&&n.length>6?n[n.length-4]+"_"+n[n.length-2]:n[n.length-2]:"channel"===n[n.length-1]&&n.length>5?n[n.length-3]+"_"+n[n.length-1]:n[n.length-1],t.signature=t.resource+"#"+t.method,t},t.Raptor.unboxFromRumorMessage=function(e){var n=t.Raptor.deserializeMessage(e.data);return n.transactionId=e.transactionId,n.fromAddress=e.headers["X-TB-FROM-ADDRESS"],n},t.Raptor.parseIceServers=function(e){try{return JSON.parse(e.data).content.iceServers}catch(t){return[]}},t.Raptor.Message={},t.Raptor.Message.offer=function(e,n){return t.Raptor.serializeMessage({method:"offer",uri:e,content:{sdp:n}})},t.Raptor.Message.connections={},t.Raptor.Message.connections.create=function(e,n,i){return t.Raptor.serializeMessage({method:"create",uri:"/v2/partner/"+e+"/session/"+n+"/connection/"+i,content:{userAgent:t.$.env.userAgent}})},t.Raptor.Message.connections.destroy=function(e,n,i){return t.Raptor.serializeMessage({method:"delete",uri:"/v2/partner/"+e+"/session/"+n+"/connection/"+i,content:{}})},t.Raptor.Message.sessions={},t.Raptor.Message.sessions.get=function(e,n){return t.Raptor.serializeMessage({method:"read",uri:"/v2/partner/"+e+"/session/"+n,content:{}})},t.Raptor.Message.streams={},t.Raptor.Message.streams.get=function(e,n,i){return t.Raptor.serializeMessage({method:"read",uri:"/v2/partner/"+e+"/session/"+n+"/stream/"+i,content:{}})},t.Raptor.Message.streams.channelFromOTChannel=function(e){var t={id:e.id,type:e.type,active:e.active};return"video"===e.type&&(t.width=e.width,t.height=e.height,t.orientation=e.orientation,t.frameRate=e.frameRate,"default"!==e.source&&(t.source=e.source),t.fitMode=e.fitMode),t},t.Raptor.Message.streams.create=function(e,n,i,o,r,s,a,c){var u={id:i,name:o,audioFallbackEnabled:r,channel:t.$.map(s,function(e){return t.Raptor.Message.streams.channelFromOTChannel(e)})};return a&&(u.minBitrate=a),c&&(u.maxBitrate=c),t.Raptor.serializeMessage({method:"create",uri:"/v2/partner/"+e+"/session/"+n+"/stream/"+i,content:u})},t.Raptor.Message.streams.destroy=function(e,n,i){return t.Raptor.serializeMessage({method:"delete",uri:"/v2/partner/"+e+"/session/"+n+"/stream/"+i,content:{}})},t.Raptor.Message.streams.answer=function(e,n,i,o){return t.Raptor.serializeMessage({method:"answer",uri:"/v2/partner/"+e+"/session/"+n+"/stream/"+i,content:{sdp:o}})},t.Raptor.Message.streams.candidate=function(e,n,i,o){return t.Raptor.serializeMessage({method:"candidate",uri:"/v2/partner/"+e+"/session/"+n+"/stream/"+i,content:o})},t.Raptor.Message.streamChannels={},t.Raptor.Message.streamChannels.update=function(e,n,i,o,r){return t.Raptor.serializeMessage({method:"update",uri:"/v2/partner/"+e+"/session/"+n+"/stream/"+i+"/channel/"+o,content:r})},t.Raptor.Message.subscribers={},t.Raptor.Message.subscribers.create=function(e,n,i,o,r,s){var a={id:o,connection:r,keyManagementMethod:t.$.supportedCryptoScheme(),bundleSupport:t.$.hasCapabilities("bundle"),rtcpMuxSupport:t.$.hasCapabilities("RTCPMux")};return s&&(a.channel=s),t.Raptor.serializeMessage({method:"create",uri:"/v2/partner/"+e+"/session/"+n+"/stream/"+i+"/subscriber/"+o,content:a})},t.Raptor.Message.subscribers.destroy=function(e,n,i,o){return t.Raptor.serializeMessage({method:"delete",uri:"/v2/partner/"+e+"/session/"+n+"/stream/"+i+"/subscriber/"+o,content:{}})},t.Raptor.Message.subscribers.update=function(e,n,i,o,r){return t.Raptor.serializeMessage({method:"update",uri:"/v2/partner/"+e+"/session/"+n+"/stream/"+i+"/subscriber/"+o,content:r})},t.Raptor.Message.subscribers.candidate=function(e,n,i,o,r){return t.Raptor.serializeMessage({method:"candidate",uri:"/v2/partner/"+e+"/session/"+n+"/stream/"+i+"/subscriber/"+o,content:r})},t.Raptor.Message.subscribers.answer=function(e,n,i,o,r){return t.Raptor.serializeMessage({method:"answer",uri:"/v2/partner/"+e+"/session/"+n+"/stream/"+i+"/subscriber/"+o,content:{sdp:r}})},t.Raptor.Message.subscriberChannels={},t.Raptor.Message.subscriberChannels.update=function(e,n,i,o,r,s){return t.Raptor.serializeMessage({method:"update",uri:"/v2/partner/"+e+"/session/"+n+"/stream/"+i+"/subscriber/"+o+"/channel/"+r,content:s})},t.Raptor.Message.signals={},t.Raptor.Message.signals.create=function(e,n,i,o,r){var s={};return void 0!==o&&(s.type=o),void 0!==r&&(s.data=r),t.Raptor.serializeMessage({method:"signal",uri:"/v2/partner/"+e+"/session/"+n+(void 0!==i?"/connection/"+i:"")+"/signal/"+t.$.uuid(),content:s})},!function(){var e;e={409:"This P2P session already has 2 participants.",410:"The session already has four participants.",1004:"The token passed is invalid."},t.Raptor.Dispatcher=function(){var e=require("events").EventEmitter;"Node"===t.$.env.name?e.call(this):(t.$.eventing(this,!0),this.emit=this.trigger)},"Node"===t.$.env.name&&require("util").inherits(t.Raptor.Dispatcher,require("events").EventEmitter),t.Raptor.Dispatcher.prototype.registerCallback=function(e,t){this.callbacks={},this.callbacks[e]=t},t.Raptor.Dispatcher.prototype.triggerCallback=function(e){if(e){var n=this.callbacks[e];if(n&&t.$.isFunction(n)){var i=Array.prototype.slice.call(arguments);i.shift(),n.apply(null,i)}delete this.callbacks[e]}},t.Raptor.Dispatcher.prototype.onClose=function(e){this.emit("close",e)},t.Raptor.Dispatcher.prototype.dispatch=function(e){if(e.type===t.Rumor.MessageType.STATUS){t.debug("OT.Raptor.dispatch: STATUS"),t.debug(e);var n;return e.isError&&(n=new t.Error(e.status)),void this.triggerCallback(e.transactionId,n,e)}var i=t.Raptor.unboxFromRumorMessage(e);switch(t.debug("OT.Raptor.dispatch "+i.signature),t.debug(e.data),i.resource){case"session":this.dispatchSession(i);break;case"connection":this.dispatchConnection(i);break;case"stream":this.dispatchStream(i);break;case"stream_channel":this.dispatchStreamChannel(i);break;case"subscriber":this.dispatchSubscriber(i);break;case"subscriber_channel":this.dispatchSubscriberChannel(i);break;case"signal":this.dispatchSignal(i);break;case"archive":this.dispatchArchive(i);break;default:t.warn("OT.Raptor.dispatch: Type "+i.resource+" is not currently implemented")}},t.Raptor.Dispatcher.prototype.dispatchSession=function(e){switch(e.method){case"read":this.emit("session#read",e.content,e.transactionId);break;default:t.warn("OT.Raptor.dispatch: "+e.signature+" is not currently implemented")}},t.Raptor.Dispatcher.prototype.dispatchConnection=function(e){switch(e.method){case"created":this.emit("connection#created",e.content);break;case"deleted":this.emit("connection#deleted",e.params.connection,e.reason);break;default:t.warn("OT.Raptor.dispatch: "+e.signature+" is not currently implemented")}},t.Raptor.Dispatcher.prototype.dispatchStream=function(e){switch(e.method){case"created":this.emit("stream#created",e.content,e.transactionId);break;case"deleted":this.emit("stream#deleted",e.params.stream,e.reason);break;case"updated":this.emit("stream#updated",e.params.stream,e.content);break;case"generateoffer":case"answer":case"pranswer":case"offer":case"candidate":this.dispatchJsep(e.method,e);break;default:t.warn("OT.Raptor.dispatch: "+e.signature+" is not currently implemented")}},t.Raptor.Dispatcher.prototype.dispatchStreamChannel=function(e){switch(e.method){case"updated":this.emit("streamChannel#updated",e.params.stream,e.params.channel,e.content);break;default:t.warn("OT.Raptor.dispatch: "+e.signature+" is not currently implemented")}},t.Raptor.Dispatcher.prototype.dispatchJsep=function(e,t){this.emit("jsep#"+e,t.params.stream,t.fromAddress,t)},t.Raptor.Dispatcher.prototype.dispatchSubscriberChannel=function(e){switch(e.method){case"updated":this.emit("subscriberChannel#updated",e.params.stream,e.params.channel,e.content);break;case"update":this.emit("subscriberChannel#update",e.params.subscriber,e.params.stream,e.content);break;default:t.warn("OT.Raptor.dispatch: "+e.signature+" is not currently implemented")}},t.Raptor.Dispatcher.prototype.dispatchSubscriber=function(e){switch(e.method){case"created":this.emit("subscriber#created",e.params.stream,e.fromAddress,e.content.id);break;case"deleted":this.dispatchJsep("unsubscribe",e),this.emit("subscriber#deleted",e.params.stream,e.fromAddress);break;case"generateoffer":case"answer":case"pranswer":case"offer":case"candidate":this.dispatchJsep(e.method,e);break;default:t.warn("OT.Raptor.dispatch: "+e.signature+" is not currently implemented")}},t.Raptor.Dispatcher.prototype.dispatchSignal=function(e){return"signal"!==e.method?void t.warn("OT.Raptor.dispatch: "+e.signature+" is not currently implemented"):void this.emit("signal",e.fromAddress,e.content.type,e.content.data)},t.Raptor.Dispatcher.prototype.dispatchArchive=function(e){switch(e.method){case"created":this.emit("archive#created",e.content);break;case"updated":this.emit("archive#updated",e.params.archive,e.content)}}}(this),function(e){function n(e,n){var i=e.channel.map(function(e){return new t.StreamChannel(e)}),o=e.connectionId?e.connectionId:e.connection.id;return new t.Stream(e.id,e.name,e.creationTime,n.connections.get(o),n,i)}function i(e,t){if(!t.streams.has(e.id)){var i=n(e,t);return t.streams.add(i),i}}function o(e){return new t.Archive(e.id,e.name,e.status)}function r(e,t){if(!t.archives.has(e.id)){var n=o(e);return t.archives.add(n),n}}t.publishers=new t.$.Collection("guid"),t.subscribers=new t.$.Collection("widgetId"),t.sessions=new t.$.Collection;var s=function(e){var t=[];this.enqueue=function(){t.push(Array.prototype.slice.call(arguments))},this.triggerAll=function(){for(var n;n=t.shift();)e.trigger.apply(e,n)}},a=function(e){var n={};this.enqueue=function(){var t=arguments[0],i=Array.prototype.slice.call(arguments,1);n[t]||(n[t]=new s(e)),n[t].enqueue.apply(n[t],i)},this.triggerConnectionCreated=function(e){n["connectionCreated"+e.id]&&n["connectionCreated"+e.id].triggerAll()},this.triggerSessionConnected=function(e){n.sessionConnected&&n.sessionConnected.triggerAll(),t.$.forEach(e,function(e){this.triggerConnectionCreated(e)})}},c={};e.OT.SessionDispatcher=function(e){var n=new t.Raptor.Dispatcher,o=!1,s=new a(n);n.on("close",function(n){var i=e.connection;return i?i.destroyedReason()?void t.debug("OT.Raptor.Socket: Socket was closed but the connection had already been destroyed. Reason: "+i.destroyedReason()):void i.destroy(n):void 0});var u=function(n,o){return n=t.Connection.fromHash(n),(o||e.connection&&n.id!==e.connection.id)&&(e.connections.add(n),s.triggerConnectionCreated(n)),t.$.forEach(t.$.keys(c),function(t){var r=c[t];if(r&&n.id===r.connection.id){i(r,e),delete c[r.id];var s={debug:o?"connection came in session#read":"connection came in connection#created",streamId:r.id,connectionId:n.id};e.logEvent("streamCreated","warning",s)}}),n};n.on("session#read",function(a,c){var d,l={};l.streams=[],l.connections=[],l.archives=[],t.$.forEach(a.connection,function(e){d=u(e,!0),l.connections.push(d)}),t.$.forEach(a.stream,function(t){l.streams.push(i(t,e))}),t.$.forEach(a.archive||a.archives,function(t){l.archives.push(r(t,e))}),e._.subscriberMap={},n.triggerCallback(c,null,l),o=!0,s.triggerSessionConnected(e.connections)}),n.on("connection#created",function(e){u(e)}),n.on("connection#deleted",function(t,n){t=e.connections.get(t),t.destroy(n)}),n.on("stream#created",function(t,o){var r=t.connectionId?t.connectionId:t.connection.id;if(e.connections.has(r))t=i(t,e);else{c[t.id]=t;var s={debug:"eventOrderError -- streamCreated event before connectionCreated",streamId:t.id};e.logEvent("streamCreated","warning",s)}t.publisher&&t.publisher.setStream(t),n.triggerCallback(o,null,t)}),n.on("stream#deleted",function(n,i){var o=e.streams.get(n);return o?void o.destroy(i):void t.error("OT.Raptor.dispatch: A stream does not exist with the id of "+n+", for stream#deleted message!")}),n.on("stream#updated",function(n,i){var o=e.streams.get(n);return o?void o._.update(i):void t.error("OT.Raptor.dispatch: A stream does not exist with the id of "+n+", for stream#updated message!")}),n.on("streamChannel#updated",function(n,i,o){var r;return n&&(r=e.streams.get(n))?void r._.updateChannel(i,o):void t.error("OT.Raptor.dispatch: Unable to determine streamId, or the stream does not exist, for streamChannel message!")});var d=function(e,n,i,o){var r,s;switch(e){case"offer":s=[];var a=t.subscribers.find({streamId:n});a&&s.push(a);break;case"answer":case"pranswer":case"generateoffer":case"unsubscribe":s=t.publishers.where({streamId:n});break;case"candidate":s=t.publishers.where({streamId:n}).concat(t.subscribers.where({streamId:n}));break;default:return void t.warn("OT.Raptor.dispatch: jsep#"+e+" is not currently implemented")}if(0!==s.length){if(r=s[0].session.connections.get(i),!r&&i.match(/^symphony\./))r=t.Connection.fromHash({id:i,creationTime:Math.floor(t.$.now())}),s[0].session.connections.add(r);else if(!r)return void t.warn("OT.Raptor.dispatch: Messsage comes from a connection ("+i+") that we do not know about. The message was ignored.");t.$.forEach(s,function(t){t.processMessage(e,r,o)})}};return n.on("jsep#offer",t.$.bind(d,null,"offer")),n.on("jsep#answer",t.$.bind(d,null,"answer")),n.on("jsep#pranswer",t.$.bind(d,null,"pranswer")),n.on("jsep#generateoffer",t.$.bind(d,null,"generateoffer")),n.on("jsep#unsubscribe",t.$.bind(d,null,"unsubscribe")),n.on("jsep#candidate",t.$.bind(d,null,"candidate")),n.on("subscriberChannel#updated",function(n,i,o){return n&&e.streams.has(n)?void e.streams.get(n)._.updateChannel(i,o):void t.error("OT.Raptor.dispatch: Unable to determine streamId, or the stream does not exist, for subscriberChannel#updated message!")}),n.on("subscriberChannel#update",function(n,i,o){return i&&e.streams.has(i)?t.subscribers.has(n)?void t.subscribers.get(n).disableVideo(o.active):void t.error("OT.Raptor.dispatch: Unable to determine subscriberId, or the subscriber does not exist, for subscriberChannel#update message!"):void t.error("OT.Raptor.dispatch: Unable to determine streamId, or the stream does not exist, for subscriberChannel#update message!")}),n.on("subscriber#created",function(n,i,o){var r=n?e.streams.get(n):null;return r?void(e._.subscriberMap[i+"_"+r.id]=o):void t.error("OT.Raptor.dispatch: Unable to determine streamId, or the stream does not exist, for subscriber#created message!")}),n.on("subscriber#deleted",function(n,i){var o=n?e.streams.get(n):null;return o?void delete e._.subscriberMap[i+"_"+o.id]:void t.error("OT.Raptor.dispatch: Unable to determine streamId, or the stream does not exist, for subscriber#created message!")}),n.on("signal",function(t,n,i){var r=e.connections.get(t);e.connection&&t===e.connection.connectionId?o?e._.dispatchSignal(r,n,i):s.enqueue("sessionConnected","signal",t,n,i):e.connections.get(t)?e._.dispatchSignal(r,n,i):s.enqueue("connectionCreated"+t,"signal",t,n,i)}),n.on("archive#created",function(t){r(t,e)}),n.on("archive#updated",function(n,i){var o=e.archives.get(n);return o?void o._.update(i):void t.error("OT.Raptor.dispatch: An archive does not exist with the id of "+n+", for archive#updated message!")}),n}}(e),t.httpTest=i;var b={getMLineIndex:function(e,n){var i="m="+n;return t.$.findIndex(e,function(e){return-1!==e.indexOf(i)?!0:!1})},getMLinePayloadTypes:function(e,n){var i=new RegExp("^m="+n+" \\d+(/\\d+)? [a-zA-Z0-9/]+(( [a-zA-Z0-9/]+)+)$","i"),o=e.match(i);return!o||o.length<2?[]:t.$.trim(o[2]).split(" ")},removeTypesFromMLine:function(e,n){return t.$.trim(e.replace(new RegExp(" "+n.join(" |"),"ig")," ").replace(/\s+/g," "))},removeMediaEncoding:function(e,n,i){var o,r,s=e.split("\r\n"),a=b.getMLineIndex(s,n),c=a>-1?s[a]:void 0,u=[];if(-1===a)return s.join("\r\n");if(o=b.getMLinePayloadTypes(c,n),0===o.length)return s.join("\r\n");var d=new RegExp("a=rtpmap:("+o.join("|")+") "+i+"\\/\\d+","i");return s=t.$.filter(s,function(e,t){return r=e.match(d),null===r?!0:(u.push(r[1]),a>t&&a--,!1)}),u.length>0&&a>-1&&(s[a]=b.removeTypesFromMLine(c,u)),s.join("\r\n")},removeComfortNoise:function(e){return b.removeMediaEncoding(e,"audio","CN")},removeVideoCodec:function(e,t){return b.removeMediaEncoding(e,"video",t)}},y={};y.isVideoStat=o,y.isAudioStat=r,y.isInboundStat=s,y.parseStatCategory=a,y.normalizeTimestamp=c,t.getStatsHelpers=y,t.getStatsAdpater=u,t.webrtcTest=d,t.Chrome=function(e){var n=!1,i={},o=function(t,n){n.parent=this,n.appendTo(e.parent),i[t]=n,this[t]=n};e.parent&&(t.$.eventing(this),this.destroy=function(){this.off(),this.hideWhileLoading();for(var e in i)i[e].destroy()},this.showAfterLoading=function(){n=!0;for(var e in i)i[e].showAfterLoading()},this.hideWhileLoading=function(){n=!1;for(var e in i)i[e].hideWhileLoading()},this.set=function(e,t){if("string"==typeof e&&t)o.call(this,e,t);else for(var n in e)e.hasOwnProperty(n)&&o.call(this,n,e[n]);return this})},t.Chrome.Behaviour||(t.Chrome.Behaviour={}),t.Chrome.Behaviour.Widget=function(e,n){var i,o,r=n||{},s="auto";e.setDisplayMode=function(e){var n=e||"auto";i!==n&&(t.$.removeClass(this.domElement,"OT_mode-"+i),t.$.addClass(this.domElement,"OT_mode-"+n),"off"===n&&(s=i),i=n)},e.getDisplayMode=function(){return i},e.show=function(){return i!==s&&(this.setDisplayMode(s),r.onShow&&r.onShow()),this},e.showAfterLoading=function(){this.setDisplayMode(o)},e.hide=function(){return"off"!==i&&(this.setDisplayMode("off"),r.onHide&&r.onHide()),this},e.hideWhileLoading=function(){o=i,this.setDisplayMode("off")},e.destroy=function(){return r.onDestroy&&r.onDestroy(this.domElement),this.domElement&&t.$.removeElement(this.domElement),e},e.appendTo=function(n){return this.domElement=t.$.createElement(r.nodeName||"div",r.htmlAttributes,r.htmlContent),r.onCreate&&r.onCreate(this.domElement),e.setDisplayMode(r.mode),"auto"===r.mode&&(t.$.addClass(e.domElement,"OT_mode-on-hold"),setTimeout(function(){t.$.removeClass(e.domElement,"OT_mode-on-hold")},2e3)),n.appendChild(this.domElement),e}},t.Chrome.VideoDisabledIndicator=function(e){var n,i=!1,o=!1;n=t.$.bind(function(e){i?t.$.addClass(e,"OT_video-disabled"):t.$.removeClass(e,"OT_video-disabled"),o?t.$.addClass(e,"OT_video-disabled-warning"):t.$.removeClass(e,"OT_video-disabled-warning"),!i&&!o||"auto"!==this.getDisplayMode()&&"on"!==this.getDisplayMode()?t.$.removeClass(e,"OT_active"):t.$.addClass(e,"OT_active")},this),this.disableVideo=function(e){i=e,e===!0&&(o=!1),n(this.domElement)
},this.setWarning=function(e){o=e,n(this.domElement)},t.Chrome.Behaviour.Widget(this,{mode:e.mode||"auto",nodeName:"div",htmlAttributes:{className:"OT_video-disabled-indicator"}});var r=t.$.bind(this.setDisplayMode,this);this.setDisplayMode=function(e){r(e),n(this.domElement)}},t.Chrome.NamePanel=function(e){var n=e.name;n&&""!==t.$.trim(n).length||(n=null,e.mode="off"),this.setName=t.$.bind(function(e){n||this.setDisplayMode("auto"),n=e,this.domElement.innerHTML=n}),t.Chrome.Behaviour.Widget(this,{mode:e.mode,nodeName:"h1",htmlContent:n,htmlAttributes:{className:"OT_name OT_edge-bar-item"}})},t.Chrome.MuteButton=function(e){var n,i,o,r,s,a=e.muted||!1;i=t.$.bind(function(){a?t.$.addClass(this.domElement,"OT_active"):t.$.removeClass(this.domElement,"OT_active ")},this),o=function(e){n=t.$.bind(s,this),t.$.on(e,"click",n)},r=function(e){n=null,t.$.off(e,"click",n)},s=function(){return a=!a,i(),a?this.parent.trigger("muted",this):this.parent.trigger("unmuted",this),!1},t.$.defineProperties(this,{muted:{get:function(){return a},set:function(e){a=e,i()}}});var c=a?"OT_edge-bar-item OT_mute OT_active":"OT_edge-bar-item OT_mute";t.Chrome.Behaviour.Widget(this,{mode:e.mode,nodeName:"button",htmlContent:"Mute",htmlAttributes:{className:c},onCreate:t.$.bind(o,this),onDestroy:t.$.bind(r,this)})},t.Chrome.BackingBar=function(e){function n(){return"on"===i||"on"===o?"on":"mini"===i||"mini"===o?"mini":"mini-auto"===i||"mini-auto"===o?"mini-auto":"auto"===i||"auto"===o?"auto":"off"}var i=e.nameMode,o=e.muteMode;t.Chrome.Behaviour.Widget(this,{mode:n(),nodeName:"div",htmlContent:"",htmlAttributes:{className:"OT_bar OT_edge-bar-item"}}),this.setNameMode=function(e){i=e,this.setDisplayMode(n())},this.setMuteMode=function(e){o=e,this.setDisplayMode(n())}},t.Chrome.AudioLevelMeter=function(e){function n(){o=t.$.createElement("div",{className:"OT_audio-level-meter__bar"},""),s=t.$.createElement("div",{className:"OT_audio-level-meter__value"},""),r=t.$.createElement("div",{className:"OT_audio-level-meter__audio-only-img"},""),c.domElement.appendChild(o),c.domElement.appendChild(r),c.domElement.appendChild(s)}function i(){var e=100*a/(u-d);s.style.width=s.style.height=2*e+"%",s.style.top=s.style.right=-e+"%"}var o,r,s,a,c=this,u=e.maxValue||1,d=e.minValue||0,l={mode:e?e.mode:"auto",nodeName:"div",htmlAttributes:{className:"OT_audio-level-meter"},onCreate:n};t.Chrome.Behaviour.Widget(this,l);var h=t.$.bind(c.setDisplayMode,c);c.setDisplayMode=function(t){h(t),"off"===t?e.onPassivate&&e.onPassivate():e.onActivate&&e.onActivate()},c.setValue=function(e){a=e,i()}},t.Chrome.Archiving=function(e){var n,i,o,r,s,a,c,u=e.archiving,d=e.archivingStarted||"Archiving on",l=e.archivingEnded||"Archiving off",h=!0;a=function(e){r.nodeValue=e,n.setAttribute("title",e)},c=t.$.bind(function(){s&&(clearTimeout(s),s=null),u?t.$.addClass(i,"OT_active"):t.$.removeClass(i,"OT_active"),t.$.removeClass(this.domElement,"OT_archiving-"+(u?"off":"on")),t.$.addClass(this.domElement,"OT_archiving-"+(u?"on":"off")),e.show&&u?(a(d),t.$.addClass(o,"OT_mode-on"),t.$.removeClass(o,"OT_mode-auto"),this.setDisplayMode("on"),s=setTimeout(function(){t.$.addClass(o,"OT_mode-auto"),t.$.removeClass(o,"OT_mode-on")},5e3)):e.show&&!h?(t.$.addClass(o,"OT_mode-on"),t.$.removeClass(o,"OT_mode-auto"),this.setDisplayMode("on"),a(l),s=setTimeout(t.$.bind(function(){this.setDisplayMode("off")},this),5e3)):this.setDisplayMode("off")},this),t.Chrome.Behaviour.Widget(this,{mode:u&&e.show&&"on"||"off",nodeName:"h1",htmlAttributes:{className:"OT_archiving OT_edge-bar-item OT_edge-bottom"},onCreate:t.$.bind(function(){n=t.$.createElement("div",{className:"OT_archiving-light-box"},""),i=t.$.createElement("div",{className:"OT_archiving-light"},""),n.appendChild(i),o=t.$.createElement("div",{className:"OT_archiving-status OT_mode-on OT_edge-bar-item OT_edge-bottom"},""),r=document.createTextNode(""),o.appendChild(r),this.domElement.appendChild(n),this.domElement.appendChild(o),c()},this)}),this.setShowArchiveStatus=t.$.bind(function(t){e.show=t,this.domElement&&c.call(this)},this),this.setArchiving=t.$.bind(function(e){u=e,h=!1,this.domElement&&c.call(this)},this)},!function(e){if(e&&"undefined"!=typeof navigator){var n=e.webkitRTCPeerConnection||e.mozRTCPeerConnection;navigator.webkitGetUserMedia?(webkitMediaStream.prototype.getVideoTracks||(webkitMediaStream.prototype.getVideoTracks=function(){return this.videoTracks}),webkitMediaStream.prototype.getAudioTracks||(webkitMediaStream.prototype.getAudioTracks=function(){return this.audioTracks}),webkitRTCPeerConnection.prototype.getLocalStreams||(webkitRTCPeerConnection.prototype.getLocalStreams=function(){return this.localStreams}),webkitRTCPeerConnection.prototype.getRemoteStreams||(webkitRTCPeerConnection.prototype.getRemoteStreams=function(){return this.remoteStreams})):navigator.mozGetUserMedia&&(MediaStream.prototype.getVideoTracks||(MediaStream.prototype.getVideoTracks=function(){return[]}),MediaStream.prototype.getAudioTracks||(MediaStream.prototype.getAudioTracks=function(){return[]})),"undefined"!=typeof e.MediaStreamTrack&&(e.MediaStreamTrack.prototype.setEnabled||(e.MediaStreamTrack.prototype.setEnabled=function(e){this.enabled=t.$.castToBoolean(e)})),!e.URL&&e.webkitURL&&(e.URL=e.webkitURL),t.$.createPeerConnection=function(e,t,i,o){if(OTPlugin.isInstalled())OTPlugin.initPeerConnection(e,t,i,o);else{var r;try{r=new n(e,t)}catch(s){return void o(s.message)}o(null,r)}}}t.$.supportedCryptoScheme=function(){return"Chrome"===t.$.env.name&&t.$.env.version<25?"SDES_SRTP":"DTLS_SRTP"}}(e);var E,S=function(e,n,i){var o,r,s;o={mandatory:{},optional:[]},r=function(e,n){return function(o){t.error(e),t.error(o),i&&i(e,o,n)}},s=function(t){t.sdp=b.removeComfortNoise(t.sdp),t.sdp=b.removeVideoCodec(t.sdp,"ulpfec"),t.sdp=b.removeVideoCodec(t.sdp,"red"),e.setLocalDescription(t,function(){n(t)},r("Error while setting LocalDescription","SetLocalDescription"))},navigator.mozGetUserMedia&&(o.mandatory.MozDontOfferDataChannel=!0),e.createOffer(s,r("Error while creating Offer","CreateOffer"),o)},T=function(e,n,i,o){var r,s,a;if(r=function(e,n){return function(i){t.error(e),t.error(i),o&&o(e,i,n)}},s=function(t){t.sdp=b.removeComfortNoise(t.sdp),t.sdp=b.removeVideoCodec(t.sdp,"ulpfec"),t.sdp=b.removeVideoCodec(t.sdp,"red"),e.setLocalDescription(t,function(){i(t)},r("Error while setting LocalDescription","SetLocalDescription"))},a=function(){e.createAnswer(s,r("Error while setting createAnswer","CreateAnswer"),null,!1)},-1===n.sdp.indexOf("a=crypto")){var c="a=crypto:1 AES_CM_128_HMAC_SHA1_80 inline:FakeFakeFakeFakeFakeFakeFakeFakeFakeFake\\r\\n";n.sdp=n.sdp.replace(/^c=IN(.*)$/gim,"c=IN$1\r\n"+c)}if(-1===n.sdp.indexOf("a=rtcp-fb")){var u="a=rtcp-fb:* ccm fir\r\na=rtcp-fb:* nack ";n.sdp=n.sdp.replace(/^m=video(.*)$/gim,"m=video$1\r\n"+u)}e.setRemoteDescription(n,a,r("Error while setting RemoteDescription","SetRemoteDescription"))};E=OTPlugin.isInstalled()?OTPlugin.RTCIceCandidate:e.mozRTCIceCandidate||e.RTCIceCandidate;var w,C=function(){var e=[],t=null;this.setPeerConnection=function(e){t=e},this.process=function(n){var i=new E(n.content);t?t.addIceCandidate(i):e.push(i)},this.processPending=function(){for(;e.length;)t.addIceCandidate(e.shift())}},O=function(e){var n,i,o=t.$.now(),r=[],s=function(){var i=t.$.now(),o=r[r.length-1],s={delta:n?i-n:0};o&&o.iceConnection===e.iceConnectionState||(s.iceConnectionState=e.iceConnectionState),o&&o.signalingState===e.signalingState||(s.signalingState=e.signalingState),o&&o.iceGatheringState===e.iceGatheringState||(s.iceGathering=e.iceGatheringState),t.debug(s),r.push(s),n=i};return e.addEventListener("iceconnectionstatechange",s,!1),e.addEventListener("signalingstatechange",s,!1),e.addEventListener("icegatheringstatechange",s,!1),{stop:function(){e.removeEventListener("iceconnectionstatechange",s,!1),e.removeEventListener("signalingstatechange",s,!1),e.removeEventListener("icegatheringstatechange",s,!1),i=!0;var a={type:"PeerConnectionWorkflow",success:i,startTime:o,finishTime:n,states:r};t.debug(a)}}};w=OTPlugin.isInstalled()?OTPlugin.RTCSessionDescription:e.mozRTCSessionDescription||e.RTCSessionDescription;var R=function(e){return function(n){n.candidate?e(t.Raptor.Actions.CANDIDATE,n.candidate):t.debug("IceCandidateForwarder: No more ICE candidates.")}};t.PeerConnection=function(e){var n,i,o,r,s=[],a=new C,c=t.getStatsAdpater(),u="new",d=[];t.$.eventing(this),e.iceServers||(e.iceServers=[]);var l=t.$.bind(function(e,t,n){d.length&&d[0](e,t,n)},this),h=t.$.bind(function(i,o){if(n)return void i.call(null,null,n);if(s.push(i),!(s.length>1)){var r={optional:[{DtlsSrtpKeyAgreement:!0}]};t.debug('Creating peer connection config "'+JSON.stringify(e)+'".'),e.iceServers&&0!==e.iceServers.length||t.error("No ice servers present"),t.$.createPeerConnection(e,r,o,f)}},this),f=t.$.bind(function(e,o){if(e)return N("Failed to create PeerConnection, exception: "+e.toString(),"NewPeerConnection"),void(s=[]);if(t.debug("OT attachEventsToPeerConnection"),n=o,i=O(n),n.addEventListener("icecandidate",R(l),!1),n.addEventListener("addstream",y,!1),n.addEventListener("removestream",E,!1),n.addEventListener("signalingstatechange",g,!1),void 0!==n.oniceconnectionstatechange){var r;n.addEventListener("iceconnectionstatechange",function(e){"failed"===e.target.iceConnectionState&&(r&&clearTimeout(r),r=setTimeout(function(){"failed"===e.target.iceConnectionState&&N("The stream was unable to connect due to a network error. Make sure your connection isn't blocked by a firewall.","ICEWorkflow")},5e3))},!1)}p(null)},this),p=function(){for(;s.length;)s.shift().call(null)},m=function(){a&&a.setPeerConnection(null),i&&i.stop(),_.stopCollecting(),null!==n&&(n.destroy&&n.destroy(),n=null,this.trigger("close"))},g=t.$.bind(function(){var e=n.signalingState;if(e&&e!==u)switch(u=e,t.debug("PeerConnection.stateChange: "+u),u){case"closed":m.call(this)}},this),v=t.$.bind(function(e){this.trigger("qos",e)},this),b=function(){var e;if(n.getRemoteStreams)e=n.getRemoteStreams();else{if(!n.remoteStreams)throw new Error("Invalid Peer Connection object implements no method for retrieving remote streams");e=n.remoteStreams}return Array.prototype.slice.call(e)},y=t.$.bind(function(e){this.trigger("streamAdded",e.stream)},this),E=t.$.bind(function(e){this.trigger("streamRemoved",e.stream)},this),I=function(e,t,n){l(e,t,n)},A=function(e){var i=new w({type:"offer",sdp:e.content.sdp}),o=function(e){a.setPeerConnection(n),a.processPending(),I(t.Raptor.Actions.ANSWER,e),_.startCollecting(n)},r=function(e,t,n){N("PeerConnection.offerProcessor "+e+": "+t,n)};h(function(){T(n,i,o,r)})},P=function(e){return e.content.sdp?(r=new w({type:"answer",sdp:e.content.sdp}),n.setRemoteDescription(r,function(){t.debug("setRemoteDescription Success")},function(e){N("Error while setting RemoteDescription "+e,"SetRemoteDescription")}),a.setPeerConnection(n),a.processPending(),void _.startCollecting(n)):void t.error("PeerConnection.processMessage: Weird answer message, no SDP.")},D=function(e){if(t.debug("PeerConnection.processSubscribe: Sending offer to subscriber."),!n)throw new Error("PeerConnection broke!");h(function(){S(n,function(n){o=n,I(t.Raptor.Actions.OFFER,o,e.uri)},function(e,t,n){N("PeerConnection.subscribeProcessor "+e+": "+t,n)})})},N=t.$.bind(function(e,n){t.error(e),this.trigger("error",e,n)},this);this.addLocalStream=function(e){h(function(){n.addStream(e)},e)},this.disconnect=function(){a=null,n&&n.signalingState&&"closed"!==n.signalingState.toLowerCase()&&(n.close(),"Firefox"===t.$.env.name&&t.$.callAsync(t.$.bind(m,this))),this.off()},this.processMessage=function(e,n){switch(t.debug("PeerConnection.processMessage: Received "+e+" from "+n.fromAddress),t.debug(n),e){case"generateoffer":D.call(this,n);break;case"offer":A.call(this,n);break;case"answer":case"pranswer":P.call(this,n);break;case"candidate":a.process(n);break;default:t.debug("PeerConnection.processMessage: Received an unexpected message of type "+e+" from "+n.fromAddress+": "+JSON.stringify(n))}return this},this.setIceServers=function(t){t&&(e.iceServers=t)},this.registerMessageDelegate=function(e){return d.push(e)},this.unregisterMessageDelegate=function(e){var n=t.$.arrayIndexOf(d,e);return-1!==n&&d.splice(n,1),d.length},this.remoteStreams=function(){return n?b():[]},this.getStats=function(e){h(function(){c(n,e)})};var _=new t.PeerConnection.QOS(v)},!function(){var e=function(e,t,n,i){var o=function(e){return e.stat("googFrameRateSent")?(n.videoSentBytes=Number(e.stat("bytesSent")),n.videoSentPackets=Number(e.stat("packetsSent")),n.videoSentPacketsLost=Number(e.stat("packetsLost")),n.videoRtt=Number(e.stat("googRtt")),n.videoFrameRate=Number(e.stat("googFrameRateInput")),n.videoWidth=Number(e.stat("googFrameWidthSent")),n.videoHeight=Number(e.stat("googFrameHeightSent")),n.videoCodec=e.stat("googCodecName")):e.stat("googFrameRateReceived")&&(n.videoRecvBytes=Number(e.stat("bytesReceived")),n.videoRecvPackets=Number(e.stat("packetsReceived")),n.videoRecvPacketsLost=Number(e.stat("packetsLost")),n.videoFrameRate=Number(e.stat("googFrameRateOutput")),n.videoWidth=Number(e.stat("googFrameWidthReceived")),n.videoHeight=Number(e.stat("googFrameHeightReceived")),n.videoCodec=e.stat("googCodecName")),null},r=function(e){e.stat("audioInputLevel")?(n.audioSentPackets=Number(e.stat("packetsSent")),n.audioSentPacketsLost=Number(e.stat("packetsLost")),n.audioSentBytes=Number(e.stat("bytesSent")),n.audioCodec=e.stat("googCodecName"),n.audioRtt=Number(e.stat("googRtt"))):e.stat("audioOutputLevel")&&(n.audioRecvPackets=Number(e.stat("packetsReceived")),n.audioRecvPacketsLost=Number(e.stat("packetsLost")),n.audioRecvBytes=Number(e.stat("bytesReceived")),n.audioCodec=e.stat("googCodecName"))},s=function(e){if(e.result)for(var t=e.result(),s=0;s<t.length;s++){var a=t[s];a.stat&&("true"===a.stat("googActiveConnection")&&(n.localCandidateType=a.stat("googLocalCandidateType"),n.remoteCandidateType=a.stat("googRemoteCandidateType"),n.transportType=a.stat("googTransportType")),r(a),o(a))}i(null,n)};e.getStats(s)},n=function(e,t,n,i){var o=function(e){i(e)},r=function(e){var i,o=t.audioBytesTransferred||0;e.audioInputLevel?(n.audioSentBytes=Number(e.bytesSent),n.audioSentPackets=Number(e.packetsSent),n.audioSentPacketsLost=Number(e.packetsLost),n.audioRtt=Number(e.googRtt),n.audioCodec=e.googCodecName):e.audioOutputLevel&&(n.audioBytesTransferred=Number(e.bytesReceived),n.audioCodec=e.googCodecName),n.audioBytesTransferred&&(i=n.audioBytesTransferred-o,n.avgAudioBitrate=Math.round(8*i/n.period))},s=function(e){var i,o=t.videoBytesTransferred||0;e.googFrameHeightSent?(n.videoSentBytes=Number(e.bytesSent),n.videoSentPackets=Number(e.packetsSent),n.videoSentPacketsLost=Number(e.packetsLost),n.videoRtt=Number(e.googRtt),n.videoCodec=e.googCodecName,n.videoWidth=Number(e.googFrameWidthSent),n.videoHeight=Number(e.googFrameHeightSent)):e.googFrameHeightReceived&&(n.videoRecvBytes=Number(e.bytesReceived),n.videoRecvPackets=Number(e.packetsReceived),n.videoRecvPacketsLost=Number(e.packetsLost),n.videoRtt=Number(e.googRtt),n.videoCodec=e.googCodecName,n.videoWidth=Number(e.googFrameWidthReceived),n.videoHeight=Number(e.googFrameHeightReceived)),n.videoBytesTransferred&&(i=n.videoBytesTransferred-o,n.avgVideoBitrate=Math.round(8*i/n.period)),e.googFrameRateSent?n.videoFrameRate=Number(e.googFrameRateSent):e.googFrameRateReceived&&(n.videoFrameRate=Number(e.googFrameRateReceived))},a=function(e){return void 0!==e.googFrameHeightSent||void 0!==e.googFrameHeightReceived||void 0!==n.videoBytesTransferred||void 0!==e.googFrameRateSent},c=function(e){return"true"===e.googActiveConnection};e.getStats(null,function(e){e.forEach(function(e){c(e)?(n.localCandidateType=e.googLocalCandidateType,n.remoteCandidateType=e.googRemoteCandidateType,n.transportType=e.googTransportType):a(e)?s(e):r(e)}),i(null,n)},o)},i=function(e,t,n,i){var o=function(e){i(e)},r=function(e){"outboundrtp"===e.type?(n.audioSentPackets=e.packetsSent,n.audioSentPacketsLost=e.packetsLost,n.audioSentBytes=e.bytesSent):"inboundrtp"===e.type&&(n.audioRecvPackets=e.packetsReceived,n.audioRecvPacketsLost=e.packetsLost,n.audioRecvBytes=e.bytesReceived)},s=function(e){"outboundrtp"===e.type?(n.videoSentPackets=e.packetsSent,n.videoSentPacketsLost=e.packetsLost,n.videoSentBytes=e.bytesSent):"inboundrtp"===e.type&&(n.videoRecvPackets=e.packetsReceived,n.videoRecvPacketsLost=e.packetsLost,n.videoRecvBytes=e.bytesReceived)};e.getStats(null,function(e){for(var t in e)if(e.hasOwnProperty(t)&&("outboundrtp"===e[t].type||"inboundrtp"===e[t].type)){var o=e[t];-1!==o.id.indexOf("audio")?r(o):-1!==o.id.indexOf("video")&&s(o)}i(null,n)},o)},o=function(r,s,a,c){return OTPlugin.isInstalled()?(o=n,n(r,s,a,c)):"Firefox"===t.$.env.name&&t.$.env.version>=27?(o=i,i(r,s,a,c)):(o=e,e(r,s,a,c))};t.PeerConnection.QOS=function(e){var n,i=t.$.now(),r=t.$.bind(function s(r){if(n){var a=t.$.now(),c={timeStamp:a,duration:Math.round(a-i),period:(a-r.timeStamp)/1e3},u=function(n,i){return n?void t.error("Failed to Parse QOS Stats: "+JSON.stringify(n)):(e(i,r),void setTimeout(t.$.bind(s,null,i),t.PeerConnection.QOS.INTERVAL))};o(n,r,c,u)}},this);this.startCollecting=function(e){e&&e.getStats&&(n=e,r({timeStamp:t.$.now()}))},this.stopCollecting=function(){n=null}},t.PeerConnection.QOS.INTERVAL=3e4}(),t.PeerConnections=function(){var e={};return{add:function(n,i,o){var r=n.id+"_"+i,s=e[r];return s||(s=e[r]={count:0,pc:new t.PeerConnection(o)}),s.count+=1,s.pc},remove:function(t,n){var i=t.id+"_"+n,o=e[i];o&&(o.count-=1,0===o.count&&(o.pc.disconnect(),delete e[i]))}}}(),t.SubscriberPeerConnection=function(e,n,i,o,r){var s,a,c,u,d,l,h,f,p=!1,m=!1;a=function(){this.destroy(),this.trigger("disconnected",this)},c=function(e){this.trigger("remoteStreamAdded",e,this)},u=function(e){this.trigger("remoteStreamRemoved",e,this)},d=function(e,t){this.trigger("error",null,e,this,t)},l=t.$.bind(function(e,r){if(!m){var s=e===t.Raptor.Actions.CANDIDATE||e===t.Raptor.Actions.OFFER||e===t.Raptor.Actions.ANSWER||e===t.Raptor.Actions.PRANSWER;if(s){var a=e===t.Raptor.Actions.CANDIDATE?r.candidate:r.sdp;m=-1!==a.indexOf("typ relay")}}switch(e){case t.Raptor.Actions.ANSWER:case t.Raptor.Actions.PRANSWER:this.trigger("connected"),n._.jsepAnswerP2p(i.id,o.widgetId,r.sdp);break;case t.Raptor.Actions.OFFER:n._.jsepOfferP2p(i.id,o.widgetId,r.sdp);break;case t.Raptor.Actions.CANDIDATE:n._.jsepCandidateP2p(i.id,o.widgetId,r)}},this),h=function(e){var t="get"+(e?"Video":"Audio")+"Tracks";return function(e){var n,i,o=s.remoteStreams();if(0!==o.length&&o[0][t])for(var r=0,a=o.length;a>r;++r){i=o[r],n=i[t]();for(var c=0,u=n.length;u>c;++c)n[c].enabled!==e&&(n[c].enabled=e)}}},f=t.$.bind(function(e,t){this.trigger("qos",e,t)},this),t.$.eventing(this),this.destroy=function(){if(!p){if(p=!0,s){var r=s.unregisterMessageDelegate(l);0===r&&(n&&n.isConnected()&&i&&!i.destroyed&&n._.subscriberDestroy(i,o),this.subscribeToAudio(!1)),t.PeerConnections.remove(e,i.id)}s=null,this.off()}},this.processMessage=function(e,t){s.processMessage(e,t)},this.getStats=function(e){s.getStats(e)},this.subscribeToAudio=h(!1),this.subscribeToVideo=h(!0),this.hasRelayCandidates=function(){return m},this.init=function(){s=t.PeerConnections.add(e,i.streamId,{}),s.on({close:a,streamAdded:c,streamRemoved:u,error:d,qos:f},this);var h=s.registerMessageDelegate(l);if(s.remoteStreams().length>0)t.$.forEach(s.remoteStreams(),c,this);else if(1===h){var p;if(r.subscribeToVideo||r.subscribeToAudio){var m=i.getChannelsOfType("audio"),g=i.getChannelsOfType("video");p=t.$.map(m,function(e){return{id:e.id,type:e.type,active:r.subscribeToAudio}}).concat(t.$.map(g,function(e){return{id:e.id,type:e.type,active:r.subscribeToVideo,restrictFrameRate:void 0!==r.restrictFrameRate?r.restrictFrameRate:!1}}))}n._.subscriberCreate(i,o,p,t.$.bind(function(e,n){e&&this.trigger("error",e.message,this,"Subscribe"),s&&s.setIceServers(t.Raptor.parseIceServers(n))},this))}}},t.PublisherPeerConnection=function(e,n,i,o){var r,s,a,c,u,d=!1,l=n._.subscriberMap[e.id+"_"+i];s=function(){this.destroy(),this.trigger("disconnected",this)},a=function(e,t){this.trigger("error",null,e,this,t),this.destroy()},c=t.$.bind(function(e,o,r){if(!d){var s=e===t.Raptor.Actions.CANDIDATE||e===t.Raptor.Actions.OFFER||e===t.Raptor.Actions.ANSWER||e===t.Raptor.Actions.PRANSWER;if(s){var a=e===t.Raptor.Actions.CANDIDATE?o.candidate:o.sdp;d=-1!==a.indexOf("typ relay")}}switch(e){case t.Raptor.Actions.ANSWER:case t.Raptor.Actions.PRANSWER:n.sessionInfo.p2pEnabled?n._.jsepAnswerP2p(i,l,o.sdp):n._.jsepAnswer(i,o.sdp);break;case t.Raptor.Actions.OFFER:this.trigger("connected"),n._.jsepOffer(r,o.sdp);break;case t.Raptor.Actions.CANDIDATE:n.sessionInfo.p2pEnabled?n._.jsepCandidateP2p(i,l,o):n._.jsepCandidate(i,o)}},this),u=t.$.bind(function(t,n){this.trigger("qos",e,t,n)},this),t.$.eventing(this),this.destroy=function(){r&&(r.off(),t.PeerConnections.remove(e,i)),r=null},this.processMessage=function(e,t){r.processMessage(e,t)},this.init=function(n){r=t.PeerConnections.add(e,i,{iceServers:n}),r.on({close:s,error:a,qos:u},this),r.registerMessageDelegate(c),r.addLocalStream(o),this.remoteConnection=function(){return e},this.hasRelayCandidates=function(){return d}}};var I=function(t,n){function i(){a||((r!==n.videoWidth||s!==n.videoHeight)&&(t.trigger("videoDimensionsChanged",{width:r,height:s},{width:n.videoWidth,height:n.videoHeight}),r=n.videoWidth,s=n.videoHeight),o())}function o(){t.whenTimeIncrements(function(){e.requestAnimationFrame(i)})}var r=n.videoWidth,s=n.videoHeight,a=!0;t.startObservingSize=function(){a=!1,o()},t.stopObservingSize=function(){a=!0}};if(function(e){function n(e,t){var n=document.createElement("video");if(n.setAttribute("autoplay",""),n.innerHTML=e,t){t.muted===!0&&(delete t.muted,n.muted="true");for(var i in t)t.hasOwnProperty(i)&&n.setAttribute(i,t[i])}return n}function i(e){return h[parseInt(e,10)]||"An unknown error occurred."}function o(n,o,s){var a,c="Chrome"===t.$.env.name?1:0,u=o.getVideoTracks().length>c?"timeupdate":"loadedmetadata",d=function(){clearTimeout(a),n.removeEventListener(u,l,!1),n.removeEventListener("error",h,!1),o.onended=null},l=function(){d(),s(null)},h=function(e){d(),r(n),s("There was an unexpected problem with the Video Stream: "+i(e.target.error.code))},f=function(){d(),r(n),s("Stream ended while trying to bind it to a video element.")};n.addEventListener(u,l,!1),n.addEventListener("error",h,!1),o.onended=f,void 0!==n.srcObject?n.srcObject=o:void 0!==n.mozSrcObject?n.mozSrcObject=o:n.src=e.URL.createObjectURL(o)}function r(t){void 0!==t.srcObject?t.srcObject=null:void 0!==t.mozSrcObject?t.mozSrcObject=null:e.URL.revokeObjectURL(t.src)}var s={0:"rotate(0deg)",270:"rotate(90deg)",90:"rotate(-90deg)",180:"rotate(180deg)"};t.VideoOrientation={ROTATED_NORMAL:0,ROTATED_LEFT:270,ROTATED_RIGHT:90,ROTATED_UPSIDE_DOWN:180};var a=50,c=2*Math.PI/360;t.VideoElement=function(e){var n,i,o=t.$.defaults(e&&!t.$.isFunction(e)?e:{},{fallbackText:"Sorry, Web RTC is not available in your browser"}),r=t.$.isFunction(arguments[arguments.length-1])?arguments[arguments.length-1]:void 0,s=t.$.bind(function(e){this.trigger("orientationChanged",e)},this),a=OTPlugin.isInstalled()?new u(o,r,s):new d(o,r,s),c=!1;t.$.eventing(this),a.on("videoDimensionsChanged",t.$.bind(function(e,t){this.trigger("videoDimensionsChanged",e,t)},this)),a.on("mediaStopped",t.$.bind(function(){this.trigger("mediaStopped")},this)),t.$.defineProperties(this,{domElement:{get:function(){return a.domElement()}},videoWidth:{get:function(){return a["video"+(this.isRotated()?"Height":"Width")]()}},videoHeight:{get:function(){return a["video"+(this.isRotated()?"Width":"Height")]()}},aspectRatio:{get:function(){return(this.videoWidth()+0)/this.videoHeight()}},isRotated:{get:function(){return a.isRotated()}},orientation:{get:function(){return a.orientation()},set:function(e){a.orientation(e)}},audioChannelType:{get:function(){return a.audioChannelType()},set:function(e){a.audioChannelType(e)}}}),this.imgData=function(){return a.imgData()},this.appendTo=function(e){return a.appendTo(e),this},this.bindToStream=function(e,o){return c=!1,n=e,a.bindToStream(e,t.$.bind(function(e){return e?void o(e):(c=!0,i&&(this.setAudioVolume(i),i=null),a.on("aspectRatioAvailable",t.$.bind(this.trigger,this,"aspectRatioAvailable")),void o(null))},this)),this},this.unbindStream=function(){return n?(n=null,a.unbindStream(),this):this},this.setAudioVolume=function(e){return c?a.setAudioVolume(t.$.roundFloat(e/100,2)):i=e,this},this.getAudioVolume=function(){return c?parseInt(100*a.getAudioVolume(),10):i||50},this.whenTimeIncrements=function(e,t){return a.whenTimeIncrements(e,t),this},this.onRatioAvailable=function(e){return a.onRatioAvailable(e),this},this.destroy=function(){return this.off(),void a.destroy()}};var u=function(e,n,i){var o,r,s=!1,c=[];t.$.eventing(this),l(this,function(){return o.domElement},i),this.domElement=function(){return o?o.domElement:void 0},this.videoWidth=function(){return o?o.getVideoWidth():void 0},this.videoHeight=function(){return o?o.getVideoHeight():void 0},this.imgData=function(){return o?o.getImgData():null},this.appendTo=function(e){return r=e,this},this.bindToStream=function(e,t){return r?(o=e._.render(),o.appendTo(r),o.show(function(e){if(!e){s=!0;for(var n;n=c.shift();)n()}t(e)}),this):void t("The VideoElement must attached to a DOM node before a stream can be bound")},this.unbindStream=function(){return o&&(o.destroy(),r=null,o=null),this},this.setAudioVolume=function(e){o&&o.setVolume(e)},this.getAudioVolume=function(){return o?o.getVolume():a},this.audioChannelType=function(){return"unknown"},this.whenTimeIncrements=function(e,n){t.$.callAsync(t.$.bind(e,n))},this.onRatioAvailable=function(e){s?e():c.push(e)},this.destroy=function(){return void this.unbindStream()}},d=function(e,s,c){var u,d=!1;t.$.eventing(this);var h=t.$.bind(function(e){var t="There was an unexpected problem with the Video Stream: "+i(e.target.error.code);s(t,this,"VideoElement")},this),f=function(){d||(t.warn("Video element paused, auto-resuming. If you intended to do this, use publishVideo(false) or subscribeToVideo(false) instead."),d=!0),u.play()};u=n(e.fallbackText,e.attributes);var p=!1,m=[];u.addEventListener("timeupdate",function g(){var e=u.videoWidth/u.videoHeight;if(!isNaN(e)){u.removeEventListener("timeupdate",g),p=!0;for(var t;t=m.shift();)t()}}),u.addEventListener("pause",f),I(this,u),l(this,function(){return u},c),this.domElement=function(){return u},this.videoWidth=function(){return u.videoWidth},this.videoHeight=function(){return u.videoHeight},this.imgData=function(){var e=t.$.createElement("canvas",{width:u.videoWidth,height:u.videoHeight,style:{display:"none"}});document.body.appendChild(e);try{e.getContext("2d").drawImage(u,0,0,e.width,e.height)}catch(n){return t.warn("Cannot get image data yet"),null}var i=e.toDataURL("image/png");return t.$.removeElement(e),t.$.trim(i.replace("data:image/png;base64,",""))},this.appendTo=function(e){return e.appendChild(u),this},this.bindToStream=function(e,t){var n=this;return o(u,e,function(i){return i?void t(i):(n.startObservingSize(),e.onended=function(){n.trigger("mediaStopped",this)},u.addEventListener("error",h,!1),void t(null))}),this},this.unbindStream=function(){return u&&r(u),this.stopObservingSize(),this},this.setAudioVolume=function(e){u&&(u.volume=e)},this.getAudioVolume=function(){return u?u.volume:a},this.audioChannelType=function(e){return void 0!==e&&(u.mozAudioChannelType=e),"mozAudioChannelType"in u?u.mozAudioChannelType:"unknown"},this.whenTimeIncrements=function(e,n){if(u){var i,o;o=t.$.bind(function(){u&&(!i||i>=u.currentTime?i=u.currentTime:(u.removeEventListener("timeupdate",o,!1),e.call(n,this)))},this),u.addEventListener("timeupdate",o,!1)}},this.destroy=function(){return this.unbindStream(),void(u&&(u.removeEventListener("pause",f),t.$.removeElement(u),u=null))},this.onRatioAvailable=function(e){p?e():m.push(e)}},l=function(e,n,i,o){var r=o;t.$.defineProperties(e,{isRotated:{get:function(){return this.orientation()&&(270===this.orientation().videoOrientation||90===this.orientation().videoOrientation)}},orientation:{get:function(){return r},set:function(e){r=e;var o=s[e.videoOrientation]||s.ROTATED_NORMAL;switch(t.$.env.name){case"Chrome":case"Safari":n().style.webkitTransform=o;break;case"IE":if(t.$.env.version>=9)n().style.msTransform=o;else{var a=e.videoOrientation*c,u=n(),d=Math.cos(a),l=Math.sin(a);u.style.filter="progid:DXImageTransform.Microsoft.Matrix(M11="+d+",M12="+-l+",M21="+l+",M22="+d+",SizingMethod='auto expand')"}break;default:n().style.transform=o}i(r)}},audioChannelType:{get:function(){return"mozAudioChannelType"in this.domElement?this.domElement.mozAudioChannelType:"unknown"},set:function(e){"mozAudioChannelType"in this.domElement&&(this.domElement.mozAudioChannelType=e)}}})},h={};e.MediaError&&(h[e.MediaError.MEDIA_ERR_ABORTED]="The fetching process for the media resource was aborted by the user agent at the user's request.",h[e.MediaError.MEDIA_ERR_NETWORK]="A network error of some description caused the user agent to stop fetching the media resource, after the resource was established to be usable.",h[e.MediaError.MEDIA_ERR_DECODE]="An error of some description occurred while decoding the media resource, after the resource was established to be  usable.",h[e.MediaError.MEDIA_ERR_SRC_NOT_SUPPORTED]="The media resource indicated by the src attribute was not suitable.")}(e),!function(){function e(e,n,i,r,s){var a=t.$(".OT_video-element",e);if(a.length>0){var c={left:"",top:""};if(OTPlugin.isInstalled())c.width="100%",c.height="100%";else{r=r||o,r=s?1/r:r;var u,d,l=n/i;s?(d=n,u=d*r,c.width=u+"px",c.height=d+"px",c.top=(u+i)/2+"px"):l>r?(u=n,d=u/r,c.width=u+"px",c.height=d+"px",c.top=(-d+i)/2+"px"):(d=i,u=d*r,c.width=u+"px",c.height=d+"px",c.left=(-u+n)/2+"px")}a.css(c)}}function n(e,n,i,r,s){var a=t.$(".OT_video-element",e);if(a.length>0){var c={left:"",top:""};if(OTPlugin.isInstalled()){r=r||o;var u,d,l=n/i;l>r?(d=i,u=i*r,c.width=u+"px",c.height=d+"px",c.left=(n-u)/2+"px"):(u=n,d=u/r,c.width=u+"px",c.height=d+"px",c.top=(i-d)/2+"px")}else s?(c.width=i+"px",c.height=n+"px",c.top=i+"px"):(c.width="100%",c.height="100%");a.css(c)}}function i(e,n,i){var o=parseInt(n,10),u=parseInt(i,10);a>o||c>u?t.$.addClass(e,"OT_micro"):t.$.removeClass(e,"OT_micro"),r>o||s>u?t.$.addClass(e,"OT_mini"):t.$.removeClass(e,"OT_mini")}var o=4/3,r=128,s=128,a=64,c=64,u=function(e,n){var i,o;if(e&&e.nodeName?(i=e,i.getAttribute("id")&&0!==i.getAttribute("id").length||i.setAttribute("id","OT_"+t.$.uuid()),o=i.getAttribute("id")):(i=t.$("#"+e).get(0),o=e||"OT_"+t.$.uuid()),i)if(null!=n&&"replace"!==n){var r=document.createElement("div");r.id="OT_"+t.$.uuid(),"append"===n?(i.appendChild(r),i=r):"before"===n?(i.parentNode.insertBefore(r,i),i=r):"after"===n&&(i.parentNode.insertBefore(r,i.nextSibling),i=r)}else t.$.emptyElement(i);else i=t.$.createElement("div",{id:o}),i.style.backgroundColor="#000000",document.body.appendChild(i);return i};t.WidgetView=function(o,r){var s,a,c,d,l,h,f,p={},m=u(o,r&&r.insertMode),g=document.createElement("div"),v={},b=!0,y=!1,E="cover",S=e;return t.$.eventing(p),r&&(h=r.width,f=r.height,h&&"number"==typeof h&&(h+="px"),f&&"number"==typeof f&&(f+="px"),m.style.width=h?h:"264px",m.style.height=f?f:"198px",m.style.overflow="hidden",i(m,h||"264px",f||"198px"),(void 0===r.mirror||r.mirror)&&t.$.addClass(m,"OT_mirrored"),"contain"===r.fitMode?(E="contain",S=n):"cover"!==r.fitMode&&t.warn('Invalid fit value "'+r.fitMode+'" passed. Only "contain" and "cover" can be used.')),r.classNames&&t.$.addClass(m,r.classNames),t.$(m).addClass("OT_loading OT_fit-mode-"+E),t.$.addClass(g,"OT_widget-container"),g.style.width="100%",g.style.height="100%",m.appendChild(g),l=document.createElement("div"),t.$.addClass(l,"OT_video-loading"),g.appendChild(l),d=document.createElement("div"),t.$.addClass(d,"OT_video-poster"),g.appendChild(d),v.width=m.offsetWidth,v.height=m.offsetHeight,OTPlugin.isInstalled()||(s=t.$(m).observeSize(function(e){var t=e.width,n=e.height;
i(m,t,n),a&&S(g,t,n,a.aspectRatio(),a.isRotated())})[0],c=t.$.observeNodeOrChildNodeRemoval(m,function(e){if(a){var n=t.$.some(e,function(e){return e===g||"VIDEO"===e.nodeName});n&&(a.destroy(),a=null),g&&(t.$.removeElement(g),g=null),s&&(s.disconnect(),s=null),c&&(c.disconnect(),c=null)}})),p.destroy=function(){s&&(s.disconnect(),s=null),c&&(c.disconnect(),c=null),a&&(a.destroy(),a=null),m&&(t.$.removeElement(m),m=null)},p.setBackgroundImageURI=function(e){"http:"!==e.substr(0,5)&&"https:"!==e.substr(0,6)&&"data:image/png;base64,"!==e.substr(0,22)&&(e="data:image/png;base64,"+e),t.$.css(d,"backgroundImage","url("+e+")"),t.$.css(d,"backgroundSize","contain"),t.$.css(d,"opacity","1.0")},r&&r.style&&r.style.backgroundImageURI&&p.setBackgroundImageURI(r.style.backgroundImageURI),p.bindVideo=function(e,n,i){a&&(a.destroy(),a=null);var o=n&&n.error?n.error:void 0;delete n.error;var r=new t.VideoElement({attributes:n},o);return n.audioVolume&&r.setAudioVolume(n.audioVolume),r.audioChannelType("telephony"),r.appendTo(g).bindToStream(e,function(e){if(e)return r.destroy(),void i(e);a=r,t.$.css(r.domElement(),"height","");var n=function(){S(g,m.offsetWidth,m.offsetHeight,r.aspectRatio(),r.isRotated())};r.on({orientationChanged:n,videoDimensionsChanged:function(e,t){n(),p.trigger("videoDimensionsChanged",e,t)},mediaStopped:function(){p.trigger("mediaStopped")}}),r.onRatioAvailable(n),i(null,r)}),t.$.addClass(r.domElement(),"OT_video-element"),t.$.css(r.domElement(),"height","1px"),r},t.$.defineProperties(p,{video:{get:function(){return a}},showPoster:{get:function(){return!t.$.isDisplayNone(d)},set:function(e){e?t.$.show(d):t.$.hide(d)}},poster:{get:function(){return t.$.css(d,"backgroundImage")},set:function(e){t.$.css(d,"backgroundImage","url("+e+")")}},loading:{get:function(){return b},set:function(e){b=e,b?t.$.addClass(m,"OT_loading"):t.$.removeClass(m,"OT_loading")}},audioOnly:{get:function(){return y},set:function(e){y=e,y?t.$.addClass(m,"OT_audio-only"):t.$.removeClass(m,"OT_audio-only")}},domId:{get:function(){return m.getAttribute("id")}}}),p.domElement=m,p.addError=function(e,n,i){m.innerHTML="<p>"+e+(n?' <span class="ot-help-message">'+n+"</span>":"")+"</p>",t.$.addClass(m,i||"OT_subscriber_error"),m.querySelector("p").offsetHeight>m.offsetHeight&&(m.querySelector("span").style.display="none")},p}}(e),!t.properties)throw new Error("OT.properties does not exist, please ensure that you include a valid properties file.");t.useSSL=function(){return t.properties.supportSSL&&(e.location.protocol.indexOf("https")>=0||e.location.protocol.indexOf("chrome-extension")>=0)},t.properties=function(n){var i=t.$.clone(n);i.debug="true"===n.debug||n.debug===!0,i.supportSSL="true"===n.supportSSL||n.supportSSL===!0,e.OTProperties&&(e.OTProperties.cdnURL&&(i.cdnURL=e.OTProperties.cdnURL),e.OTProperties.cdnURLSSL&&(i.cdnURLSSL=e.OTProperties.cdnURLSSL),e.OTProperties.configURL&&(i.configURL=e.OTProperties.configURL),e.OTProperties.assetURL&&(i.assetURL=e.OTProperties.assetURL),e.OTProperties.cssURL&&(i.cssURL=e.OTProperties.cssURL)),i.assetURL||(i.assetURL=t.useSSL()?i.cdnURLSSL+"/webrtc/"+i.version:i.cdnURL+"/webrtc/"+i.version);var o="IE"===t.$.env.name&&t.$.env.version<=9;return o&&e.location.protocol.indexOf("https")<0||(i.apiURL=i.apiURLSSL,i.loggingURL=i.loggingURLSSL),i.configURL||(i.configURL=i.assetURL+"/js/dynamic_config.min.js"),i.cssURL||(i.cssURL=i.assetURL+"/css/TB.min.css"),i}(t.properties),!function(){var e,n,i=function(e){return!(t.$.isFunction(e.get)&&t.$.isFunction(e.set))},o=function(t){return n?void t(null,n):void e.get(t)};t.overrideGuidStorage=function(o){if(i(o))throw new Error("The storageInterface argument does not seem to be valid, it must implement get and set methods");e!==o&&(e=o,n&&e.set(n,function(e){e&&t.error("Failed to send initial Guid value ("+n+") to the newly assigned Guid Storage. The error was: "+e)}))},t._||(t._={}),t._.getClientGuid=function(i){o(function(o,r){return o?void i(o):(r?n||(n=r):(r=t.$.uuid(),e.set(r,function(e){return e?void i(e):void(n=r)})),void i(null,n))})},t.overrideGuidStorage({get:function(e){e(null,t.$.getCookie("opentok_client_id"))},set:function(e,n){t.$.setCookie("opentok_client_id",e),n(null)}})}(e),!function(){var e,n,i,o,r,s;e=function(){return navigator.getUserMedia?t.$.bind(navigator.getUserMedia,navigator):navigator.mozGetUserMedia?t.$.bind(navigator.mozGetUserMedia,navigator):navigator.webkitGetUserMedia?t.$.bind(navigator.webkitGetUserMedia,navigator):OTPlugin.isInstalled()?t.$.bind(OTPlugin.getUserMedia,OTPlugin):void 0}(),n={PERMISSION_DENIED:"PermissionDeniedError",NOT_SUPPORTED_ERROR:"NotSupportedError",MANDATORY_UNSATISFIED_ERROR:" ConstraintNotSatisfiedError",NO_DEVICES_FOUND:"NoDevicesFoundError",HARDWARE_UNAVAILABLE:"HardwareUnavailableError",TrackStartError:"HardwareUnavailableError"},i={PermissionDeniedError:"End-user denied permission to hardware devices",PermissionDismissedError:"End-user dismissed permission to hardware devices",NotSupportedError:"A constraint specified is not supported by the browser.",ConstraintNotSatisfiedError:"It's not possible to satisfy one or more constraints passed into the getUserMedia function",OverconstrainedError:"Due to changes in the environment, one or more mandatory constraints can no longer be satisfied.",NoDevicesFoundError:"No voice or video input devices are available on this machine.",HardwareUnavailableError:"The selected voice or video devices are unavailable. Verify that the chosen devices are not in use by another application."},o=function(e,t){var n,o;return n=t.hasOwnProperty(e)?t[e]:e,o=i.hasOwnProperty(n)?i[n]:"Unknown Error while getting user media",{name:n,message:o}},r=function(e){var i;return t.$.isObject(e)&&e.name?(i=o(e.name,n),i.constraintName=e.constraintName):i="string"==typeof e?o(e,n):{message:"Unknown Error type while getting media"},i},s=function(e){if(!e||!t.$.isObject(e))return!0;for(var n in e)if(e.hasOwnProperty(n)&&e[n])return!1;return!0},t.$.getUserMedia=function(n,i,o,a,c,u,d){var l=e;if(t.$.isFunction(d)&&(l=d),s(n))return t.error("Couldn't get UserMedia: All constraints were false"),void o.call(null,{name:"NO_VALID_CONSTRAINTS",message:"Video and Audio was disabled, you need to enabled at least one"});var h=null,f=!1,p=function(){h&&clearTimeout(h),f&&c&&c()},m=function(){h=null,f=!0,a&&a()},g=function(e){p(),i.call(null,e)},v=function(e){p();var t=r(e);"PermissionDeniedError"===t.name||"PermissionDismissedError"===t.name?u.call(null,t):o.call(null,t)};try{l(n,g,v)}catch(b){return t.error("Couldn't get UserMedia: "+b.toString()),void v()}h=-1===location.protocol.indexOf("https")?setTimeout(m,100):setTimeout(m,500)}}(),!function(){var e=function(e){return function(t,n){n.querySelector("html").style.height=n.body.style.height="100%",e(t,n)}},n=function(e,n,i){var o=e.head||e.getElementsByTagName("head")[0],r=t.$.createElement("link",{type:"text/css",media:"screen",rel:"stylesheet",href:n});o.appendChild(r),t.$.on(r,"error",function(e){t.error("Could not load CSS for dialog",n,e&&e.message||e)}),t.$.on(r,"load",i)},i=function(e,i,o){var r=["//fonts.googleapis.com/css?family=Didact+Gothic",t.properties.cssURL].concat(i),s=r.length;t.$.forEach(r,function(t){n(e,t,function(){--s<=0&&o()})})},o=function(e,n,i){var o=t.$.createElement(i||"div",{"class":e},n,this);return o.on=t.$.bind(t.$.on,t.$,o),o.off=t.$.bind(t.$.off,t.$,o),o},r=function(e,n,i){var r=o.call(this,"",null,"input");return r=t.$(r).on("change",i),"IE"===t.$.env.name&&t.$.env.version<=8&&r.on("click",function(){r.first.blur(),r.first.focus()}),r.attr({name:n,id:n,type:"checkbox"}),r.first},s=function(e,t,n){var i=o.call(this,n||"",e,"a");return i.setAttribute("href",t),i};t.Dialogs={},t.Dialogs.Plugin={},t.Dialogs.Plugin.promptToInstall=function(){var n=new t.$.Modal(e(function(e,a){function c(){n.trigger("download"),setTimeout(function(){g.querySelector(".OT_dialog-messages-main").innerHTML="Plugin installation successful";var e=g.querySelectorAll(".OT_dialog-section");t.$.addClass(e[0],"OT_dialog-hidden"),t.$.removeClass(e[1],"OT_dialog-hidden")},3e3)}function u(){n.trigger("refresh")}function d(){p.checked?l():h()}function l(){y.enable(),y.on("click",c),S.enable(),S.on("click",u)}function h(){y.disable(),y.off("click",c),S.disable(),S.off("click",u)}var f,p,m,g,v=t.$.bind(o,a),b=function(e,n){var i="OT_dialog-button "+(n?"OT_dialog-button-"+n:"OT_dialog-button-large"),o=v(i,e);return o.enable=function(){return t.$.removeClass(this,"OT_dialog-button-disabled"),this},o.disable=function(){return t.$.addClass(this,"OT_dialog-button-disabled"),this},o},y=b("Download plugin"),E=b("cancel","small"),S=b("Refresh browser");t.$.addClass(E,"OT_dialog-no-natural-margin OT_dialog-button-block"),t.$.addClass(S,"OT_dialog-no-natural-margin"),y.disable(),S.disable(),E.on("click",function(){n.trigger("cancelButtonClicked"),n.close()}),m=v("OT_closeButton","&times;").on("click",function(){n.trigger("closeButtonClicked"),n.close()}).first;var T=e.location.protocol.indexOf("https")>=0?"https":"http";f=s.call(a,"end-user license agreement",T+"://tokbox.com/support/ie-eula"),p=r.call(a,null,"acceptEULA",d),g=v("OT_dialog-centering",[v("OT_dialog-centering-child",[v("OT_root OT_dialog OT_dialog-plugin-prompt",[m,v("OT_dialog-messages",[v("OT_dialog-messages-main","This app requires real-time communication")]),v("OT_dialog-section",[v("OT_dialog-single-button-with-title",[v("OT_dialog-button-title",[p,function(){var e=v("","accept","label");return e.setAttribute("for",p.id),e.style.margin="0 5px",e}(),f]),v("OT_dialog-actions-card",[y,E])])]),v("OT_dialog-section OT_dialog-hidden",[v("OT_dialog-button-title",["You can now enjoy webRTC enabled video via Internet Explorer."]),S])])])]),i(a,[],function(){a.body.appendChild(g)})}));return n},t.Dialogs.Plugin.promptToReinstall=function(){var n=new t.$.Modal(e(function(e,r){var s,a,c,u=t.$.bind(o,r);s=u("OT_closeButton","&times;").on("click",function(){n.trigger("closeButtonClicked"),n.close()}).first,a=u("OT_dialog-button OT_dialog-button-large OT_dialog-no-natural-margin","Okay").on("click",function(){n.trigger("okay")}).first,c=u("OT_dialog-centering",[u("OT_dialog-centering-child",[u("OT_ROOT OT_dialog OT_dialog-plugin-reinstall",[s,u("OT_dialog-messages",[u("OT_dialog-messages-main","Reinstall Opentok Plugin"),u("OT_dialog-messages-minor","Uh oh! Try reinstalling the OpenTok plugin again to enable real-time video communication for Internet Explorer.")]),u("OT_dialog-section",[u("OT_dialog-single-button",a)])])])]),i(r,[],function(){r.body.appendChild(c)})}));return n},t.Dialogs.Plugin.updateInProgress=function(){var n,r,s=0,a=new t.$.Modal(e(function(e,c){var u,d=t.$.bind(o,c);r=d("OT_dialog-plugin-upgrade-percentage","0%","strong"),n=d("OT_dialog-progress-bar-fill"),u=d("OT_dialog-centering",[d("OT_dialog-centering-child",[d("OT_ROOT OT_dialog OT_dialog-plugin-upgrading",[d("OT_dialog-messages",[d("OT_dialog-messages-main",["One moment please... ",r]),d("OT_dialog-progress-bar",n),d("OT_dialog-messages-minor OT_dialog-no-natural-margin","Please wait while the OpenTok plugin is updated")])])])]),i(c,[],function(){c.body.appendChild(u),null!=s&&a.setUpdateProgress(s)})}));return a.setUpdateProgress=function(e){n&&r?e>99?(t.$.css(n,"width",""),r.innerHTML="100%"):1>e?(t.$.css(n,"width","0%"),r.innerHTML="0%"):(t.$.css(n,"width",e+"%"),r.innerHTML=e+"%"):s=e},a},t.Dialogs.Plugin.updateComplete=function(n){var r=new t.$.Modal(e(function(e,s){var a,c,u=t.$.bind(o,s);a=u("OT_dialog-button OT_dialog-button-large OT_dialog-no-natural-margin","Reload").on("click",function(){r.trigger("reload")}).first;var d;d=n?["Update Failed.",n+""||"NO ERROR"]:["Update Complete.","The OpenTok plugin has been succesfully updated. Please reload your browser."],c=u("OT_dialog-centering",[u("OT_dialog-centering-child",[u("OT_root OT_dialog OT_dialog-plugin-upgraded",[u("OT_dialog-messages",[u("OT_dialog-messages-main",d[0]),u("OT_dialog-messages-minor",d[1])]),u("OT_dialog-single-button",a)])])]),i(s,[],function(){s.body.appendChild(c)})}));return r}}(),!function(e){var n={audio:"audioInput",video:"videoInput"};t.$.shouldAskForDevices=function(n){var i=e.MediaStreamTrack;null!=i&&t.$.isFunction(i.getSources)?e.MediaStreamTrack.getSources(function(e){var t=e.some(function(e){return"audio"===e.kind}),i=e.some(function(e){return"video"===e.kind});n.call(null,{video:i,audio:t})}):(t.$.shouldAskForDevices=function(e){setTimeout(t.$.bind(e,null,{video:!0,audio:!0}))},t.$.shouldAskForDevices(n))},t.$.getMediaDevices=function(i){t.$.hasCapabilities("getMediaDevices")?e.MediaStreamTrack.getSources(function(e){var o=t.$.filter(e,function(e){return null!=n[e.kind]});i(void 0,t.$.map(o,function(e){return{deviceId:e.id,label:e.label,kind:n[e.kind]}}))}):i(new Error("This browser does not support getMediaDevices APIs"))}}(e);var A=function(e){var t=document.createElement("link");t.type="text/css",t.media="screen",t.rel="stylesheet",t.href=e;var n=document.head||document.getElementsByTagName("head")[0];n.appendChild(t)};t.Config=function(){var e,n,i,o=!1,r={},s={},a=document.head||document.getElementsByTagName("head")[0],c=function(){n&&(clearTimeout(n),n=null)},u=function(){c(),e&&(e.onload=e.onreadystatechange=null,a&&e.parentNode&&a.removeChild(e),e=void 0)},d=function(){(!e.readyState||/loaded|complete/.test(e.readyState))&&(c(),o||i._onLoadTimeout())},l=function(){u(),t.warn("TB DynamicConfig failed to load due to an error"),this.trigger("dynamicConfigLoadFailed")},h=function(e,t){return t&&s[t]&&s[t][e]?s[t][e]:r[e]};return i={loadTimeout:4e3,_onLoadTimeout:function(){u(),t.warn("TB DynamicConfig failed to load in "+i.loadTimeout+" ms"),this.trigger("dynamicConfigLoadFailed")},load:function(r){if(!r)throw new Error("You must pass a valid configUrl to Config.load");o=!1,setTimeout(function(){e=document.createElement("script"),e.async="async",e.src=r,e.onload=e.onreadystatechange=t.$.bind(d,i),e.onerror=t.$.bind(l,i),a.appendChild(e)},1),n=setTimeout(function(){i._onLoadTimeout()},this.loadTimeout)},isLoaded:function(){return o},reset:function(){this.off(),u(),o=!1,r={},s={}},replaceWith:function(e){u(),e||(e={}),r=e.global||{},s=e.partners||{},o||(o=!0),this.trigger("dynamicConfigChanged")},get:function(e,t,n){var i=h(e,n);return i?i[t]:null}},t.$.eventing(i),i}(),t.$.registerCapability("getUserMedia",function(){return"Node"===t.$.env?!1:!!(navigator.webkitGetUserMedia||navigator.mozGetUserMedia||OTPlugin.isInstalled())}),t.$.registerCapability("PeerConnection",function(){return"Node"===t.$.env?!1:"function"==typeof e.webkitRTCPeerConnection&&e.webkitRTCPeerConnection.prototype.addStream?!0:"function"==typeof e.mozRTCPeerConnection&&t.$.env.version>20?!0:OTPlugin.isInstalled()}),t.$.registerCapability("webrtc",function(){if(t.properties){var e=t.properties.minimumVersion||{},n=e[t.$.env.name.toLowerCase()];if(n&&t.$.env.versionGreaterThan(n))return t.debug("Support for",t.$.env.name,"is disabled because we require",n,"but this is",t.$.env.version),!1}return"Node"===t.$.env?!0:t.$.hasCapabilities("getUserMedia","PeerConnection")}),t.$.registerCapability("bundle",function(){return t.$.hasCapabilities("webrtc")&&("Chrome"===t.$.env.name||"Node"===t.$.env.name||OTPlugin.isInstalled())}),t.$.registerCapability("RTCPMux",function(){return t.$.hasCapabilities("webrtc")&&("Chrome"===t.$.env.name||"Node"===t.$.env.name||OTPlugin.isInstalled())}),t.$.registerCapability("getMediaDevices",function(){return t.$.isFunction(e.MediaStreamTrack)&&t.$.isFunction(e.MediaStreamTrack.getSources)}),t.$.registerCapability("audioOutputLevelStat",function(){return"Chrome"===t.$.env.name||"IE"===t.$.env.name}),t.$.registerCapability("webAudioCapableRemoteStream",function(){return"Firefox"===t.$.env.name}),t.$.registerCapability("webAudio",function(){return"AudioContext"in e}),t.Analytics=function(n){var i="1",o=new t.$.Analytics(n,t.debug,t._.getClientGuid);this.logError=function(n,r,s,a,c){c||(c={});var u=c.partnerId;t.Config.get("exceptionLogging","enabled",u)===!0&&t._.getClientGuid(function(d,l){if(!d){var h=t.$.extend({clientVersion:"js-"+t.properties.version.replace("v",""),guid:l,partnerId:u,source:e.location.href,logVersion:i,clientSystemTime:(new Date).getTime()},c);o.logError(n,r,s,a,h)}})},this.logEvent=function(n,r){var s=n.partnerId;n||(n={}),t._.getClientGuid(function(a,c){if(!a){var u=t.$.extend({clientVersion:"js-"+t.properties.version.replace("v",""),guid:c,partnerId:s,source:e.location.href,logVersion:i,clientSystemTime:(new Date).getTime()},n);o.logEvent(u,!1,r)}})},this.logQOS=function(n){var r=n.partnerId;n||(n={}),t._.getClientGuid(function(s,a){if(!s){var c=t.$.extend({clientVersion:"js-"+t.properties.version.replace("v",""),guid:a,partnerId:r,source:e.location.href,logVersion:i,clientSystemTime:(new Date).getTime(),duration:0},n);o.logQOS(c)}})}},t.ConnectivityAttemptPinger=function(e){var n,i,o,r="Initial",s=["Initial","Attempt","Success","Failure"],a=5e3,c=6,u=function(i){r=i;var o=!1;switch(r){case"Attempt":"Initial"!==n&&(o=!0),l();break;case"Success":"Attempt"!==n&&(o=!0),h();break;case"Failure":"Attempt"!==n&&(o=!0),h()}if(o){var s=e?t.$.clone(e):{};s.action="Internal Error",s.variation="Non-fatal",s.payload={debug:"Invalid sequence: "+e.action+" "+n+" -> "+r},t.analytics.logEvent(s)}},d=t.$.statable(this,s,"Failure",u),l=function(){o=0,i=setInterval(function(){if(c>o){var n=t.$.extend(e,{variation:"Attempting"});t.analytics.logEvent(n)}else h();o++},a)},h=function(){clearInterval(i)};this.setVariation=function(e){n=r,d(e)},this.stop=function(){h()}},t.StylableComponent=function(e,n,i,o){if(!e.trigger)throw new Error("OT.StylableComponent is dependent on the mixin OT.$.eventing. Ensure that this is included in the object before StylableComponent.");var r=!1,s=function(t,n,i){i?e.trigger("styleValueChanged",t,n,i):e.trigger("styleValueChanged",t,n)};i===!1&&(n={buttonDisplayMode:"off",nameDisplayMode:"off",audioLevelDisplayMode:"off"},r=!0,o({showControls:!1}));var a=new P(n,s);e.getStyle=function(e){return a.get(e)},e.setStyle=r?function(){return t.warn("Calling setStyle() has no effect because theshowControls option was set to false"),this}:function(e,t,n){var i={};return"string"!=typeof e?(a.setAll(e,n),i=e):(a.set(e,t),i[e]=t),o&&o(i),this}};var P=function(e,n){var i,o,r,s,a={};i=["showMicButton","showSpeakerButton","nameDisplayMode","buttonDisplayMode","backgroundImageURI","audioLevelDisplayMode"],o={buttonDisplayMode:["auto","mini","mini-auto","off","on"],nameDisplayMode:["auto","off","on"],audioLevelDisplayMode:["auto","off","on"],showSettingsButton:[!0,!1],showMicButton:[!0,!1],backgroundImageURI:null,showControlBar:[!0,!1],showArchiveStatus:[!0,!1],videoDisabledDisplayMode:["auto","off","on"]},r=function(e,n){return"backgroundImageURI"===e||o.hasOwnProperty(e)&&-1!==t.$.arrayIndexOf(o[e],n)},s=function(e){switch(e){case"true":return!0;case"false":return!1;default:return e}},this.getAll=function(){var e=t.$.clone(a);for(var n in e)e.hasOwnProperty(n)&&t.$.arrayIndexOf(i,n)<0&&delete e[n];return e},this.get=function(e){return e?a[e]:this.getAll()},this.setAll=function(e,i){var o,c;for(var u in e)e.hasOwnProperty(u)&&(c=s(e[u]),r(u,c)?(o=a[u],c!==o&&(a[u]=c,i||n(u,c,o))):t.warn("Style.setAll::Invalid style property passed "+u+" : "+c));return this},this.set=function(e,i){t.debug("setStyle: "+e.toString());var o,c=s(i);return r(e,c)?(o=a[e],c!==o&&(a[e]=c,n(e,i,o)),this):(t.warn("Style.set::Invalid style property passed "+e+" : "+c),this)},e&&this.setAll(e,!0)};t.generateSimpleStateMachine=function(e,n,i){var o=n.slice(),r=t.$.clone(i),s=function(e){return-1!==t.$.arrayIndexOf(o,e)},a=function(e,n){return r[e]&&-1!==t.$.arrayIndexOf(r[e],n)};return function(t){function n(e,n){t({message:e,newState:n,currentState:o,previousState:r})}function i(e){return s(e)?a(o,e)?!0:(n("'"+o+"' cannot transition to '"+e+"'",e),!1):(n("'"+e+"' is not a valid state",e),!1)}var o=e,r=null;this.current=o,this.set=function(e){i(e)&&(r=o,this.current=o=e)}}},!function(){var e,n,i="NotSubscribing";e=["NotSubscribing","Init","ConnectingToPeer","BindingRemoteStream","Subscribing","Failed","Destroyed"],n={NotSubscribing:["NotSubscribing","Init","Destroyed"],Init:["NotSubscribing","ConnectingToPeer","BindingRemoteStream","Destroyed"],ConnectingToPeer:["NotSubscribing","BindingRemoteStream","Failed","Destroyed"],BindingRemoteStream:["NotSubscribing","Subscribing","Failed","Destroyed"],Subscribing:["NotSubscribing","Failed","Destroyed"],Failed:["Destroyed"],Destroyed:[]},t.SubscribingState=t.generateSimpleStateMachine(i,e,n),t.SubscribingState.prototype.isDestroyed=function(){return"Destroyed"===this.current},t.SubscribingState.prototype.isFailed=function(){return"Failed"===this.current},t.SubscribingState.prototype.isSubscribing=function(){return"Subscribing"===this.current},t.SubscribingState.prototype.isAttemptingToSubscribe=function(){return-1!==t.$.arrayIndexOf(["Init","ConnectingToPeer","BindingRemoteStream"],this.current)}}(e),!function(){var e=["NotPublishing","GetUserMedia","BindingMedia","MediaBound","PublishingToSession","Publishing","Failed","Destroyed"],n={NotPublishing:["NotPublishing","GetUserMedia","Destroyed"],GetUserMedia:["BindingMedia","Failed","NotPublishing","Destroyed"],BindingMedia:["MediaBound","Failed","NotPublishing","Destroyed"],MediaBound:["NotPublishing","PublishingToSession","Failed","Destroyed"],PublishingToSession:["NotPublishing","Publishing","Failed","Destroyed"],Publishing:["NotPublishing","MediaBound","Failed","Destroyed"],Failed:["Destroyed"],Destroyed:[]},i="NotPublishing";t.PublishingState=t.generateSimpleStateMachine(i,e,n),t.PublishingState.prototype.isDestroyed=function(){return"Destroyed"===this.current},t.PublishingState.prototype.isAttemptingToPublish=function(){return-1!==t.$.arrayIndexOf(["GetUserMedia","BindingMedia","MediaBound","PublishingToSession"],this.current)},t.PublishingState.prototype.isPublishing=function(){return"Publishing"===this.current}}(e),!function(){t.Microphone=function(e,n){var i;t.$.defineProperties(this,{muted:{get:function(){return i},set:function(t){if(i!==t){i=t;for(var n=e.getAudioTracks(),o=0,r=n.length;r>o;++o)n[o].setEnabled(!i)}}}}),this.muted(void 0!==n?n===!0:e.getAudioTracks().length?!e.getAudioTracks()[0].enabled:!1)}}(e),t.IntervalRunner=function(t,n){var i=t,o=n,r=null;this.start=function(){r=e.setInterval(i,1e3/o)},this.stop=function(){e.clearInterval(r),r=null}},!function(){t.Event=t.$.eventing.Event(),t.Event.names={ACTIVE:"active",INACTIVE:"inactive",UNKNOWN:"unknown",PER_SESSION:"perSession",PER_STREAM:"perStream",EXCEPTION:"exception",ISSUE_REPORTED:"issueReported",SESSION_CONNECTED:"sessionConnected",SESSION_DISCONNECTED:"sessionDisconnected",STREAM_CREATED:"streamCreated",STREAM_DESTROYED:"streamDestroyed",CONNECTION_CREATED:"connectionCreated",CONNECTION_DESTROYED:"connectionDestroyed",SIGNAL:"signal",STREAM_PROPERTY_CHANGED:"streamPropertyChanged",MICROPHONE_LEVEL_CHANGED:"microphoneLevelChanged",RESIZE:"resize",SETTINGS_BUTTON_CLICK:"settingsButtonClick",DEVICE_INACTIVE:"deviceInactive",INVALID_DEVICE_NAME:"invalidDeviceName",ACCESS_ALLOWED:"accessAllowed",ACCESS_DENIED:"accessDenied",ACCESS_DIALOG_OPENED:"accessDialogOpened",ACCESS_DIALOG_CLOSED:"accessDialogClosed",ECHO_CANCELLATION_MODE_CHANGED:"echoCancellationModeChanged",MEDIA_STOPPED:"mediaStopped",PUBLISHER_DESTROYED:"destroyed",SUBSCRIBER_DESTROYED:"destroyed",DEVICES_DETECTED:"devicesDetected",DEVICES_SELECTED:"devicesSelected",CLOSE_BUTTON_CLICK:"closeButtonClick",MICLEVEL:"microphoneActivityLevel",MICGAINCHANGED:"microphoneGainChanged",ENV_LOADED:"envLoaded",ENV_UNLOADED:"envUnloaded",AUDIO_LEVEL_UPDATED:"audioLevelUpdated"},t.ExceptionCodes={JS_EXCEPTION:2e3,AUTHENTICATION_ERROR:1004,INVALID_SESSION_ID:1005,CONNECT_FAILED:1006,CONNECT_REJECTED:1007,CONNECTION_TIMEOUT:1008,NOT_CONNECTED:1010,P2P_CONNECTION_FAILED:1013,API_RESPONSE_FAILURE:1014,TERMS_OF_SERVICE_FAILURE:1026,UNABLE_TO_PUBLISH:1500,UNABLE_TO_SUBSCRIBE:1501,UNABLE_TO_FORCE_DISCONNECT:1520,UNABLE_TO_FORCE_UNPUBLISH:1530},t.ExceptionEvent=function(e,n,i,o,r,s){t.Event.call(this,e),this.message=n,this.title=i,this.code=o,this.component=r,this.target=s},t.IssueReportedEvent=function(e,n){t.Event.call(this,e),this.issueId=n},t.EnvLoadedEvent=function(e){t.Event.call(this,e)};var e=!1;t.ConnectionEvent=function(n,i,o){t.Event.call(this,n,!1),t.$.canDefineProperty?Object.defineProperty(this,"connections",{get:function(){return e||(t.warn("OT.ConnectionEvent connections property is deprecated, use connection instead."),e=!0),[i]}}):this.connections=[i],this.connection=i,this.reason=o};var n=!1;t.StreamEvent=function(e,i,o,r){t.Event.call(this,e,r),t.$.canDefineProperty?Object.defineProperty(this,"streams",{get:function(){return n||(t.warn("OT.StreamEvent streams property is deprecated, use stream instead."),n=!0),[i]}}):this.streams=[i],this.stream=i,this.reason=o};var i=!1,o=!1,r=!1;t.SessionConnectEvent=function(e){t.Event.call(this,e,!1),t.$.canDefineProperty?Object.defineProperties(this,{connections:{get:function(){return i||(t.warn("OT.SessionConnectedEvent no longer includes connections. Listen for connectionCreated events instead."),i=!0),[]}},streams:{get:function(){return o||(t.warn("OT.SessionConnectedEvent no longer includes streams. Listen for streamCreated events instead."),i=!0),[]}},archives:{get:function(){return r||(t.warn("OT.SessionConnectedEvent no longer includes archives. Listen for archiveStarted events instead."),r=!0),[]}}}):(this.connections=[],this.streams=[],this.archives=[])},t.SessionDisconnectEvent=function(e,n,i){t.Event.call(this,e,i),this.reason=n},t.StreamPropertyChangedEvent=function(e,n,i,o,r){t.Event.call(this,e,!1),this.type=e,this.stream=n,this.changedProperty=i,this.oldValue=o,this.newValue=r},t.VideoDimensionsChangedEvent=function(e,n,i){t.Event.call(this,"videoDimensionsChanged",!1),this.type="videoDimensionsChanged",this.target=e,this.oldValue=n,this.newValue=i},t.ArchiveEvent=function(e,n){t.Event.call(this,e,!1),this.type=e,this.id=n.id,this.name=n.name,this.status=n.status,this.archive=n},t.ArchiveUpdatedEvent=function(e,n,i,o){t.Event.call(this,"updated",!1),this.target=e,this.changedProperty=n,this.oldValue=i,this.newValue=o},t.SignalEvent=function(e,n,i){t.Event.call(this,e?"signal:"+e:t.Event.names.SIGNAL,!1),this.data=n,this.from=i},t.StreamUpdatedEvent=function(e,n,i,o){t.Event.call(this,"updated",!1),this.target=e,this.changedProperty=n,this.oldValue=i,this.newValue=o},t.DestroyedEvent=function(e,n,i){t.Event.call(this,e,!1),this.target=n,this.reason=i},t.VideoEnabledChangedEvent=function(e,n){t.Event.call(this,e,!1),this.reason=n.reason},t.VideoDisableWarningEvent=function(e){t.Event.call(this,e,!1)},t.AudioLevelUpdatedEvent=function(e){t.Event.call(this,t.Event.names.AUDIO_LEVEL_UPDATED,!1),this.audioLevel=e},t.MediaStoppedEvent=function(e){t.Event.call(this,t.Event.names.MEDIA_STOPPED,!0),this.target=e}}(e);var D={},N={};t.registerScreenSharingExtensionHelper=function(e,n){N[e]=n,n.autoRegisters&&n.isSupportedInThisBrowser&&t.registerScreenSharingExtension(e)},t.registerScreenSharingExtension=function(e){var t=Array.prototype.slice.call(arguments,1);if(null==N[e])throw new Error("Unsupported kind passed to OT.registerScreenSharingExtension");var n=N[e].register.apply(N[e],t);D[e]=n};var _=function(){var e=t.$.find(t.$.keys(N),function(e){return N[e].isSupportedInThisBrowser});return void 0===e?{}:{name:e,proto:N[e],instance:D[e]}};t.pickScreenSharingHelper=function(){return _()},t.checkScreenSharingCapability=function(e){var t={supported:!1,extensionRequired:void 0,extensionRegistered:void 0,extensionInstalled:void 0,supportedSources:{}},n=_();return void 0===n.name?void setTimeout(e.bind(null,t)):(t.supported=!0,t.extensionRequired=n.proto.extensionRequired?n.name:void 0,t.supportedSources={screen:n.proto.sources.screen,application:n.proto.sources.application,window:n.proto.sources.window},n.instance?(t.extensionRegistered=t.extensionRequired?!0:void 0,void n.instance.isInstalled(function(n){t.extensionInstalled=t.extensionRequired?n:void 0,e(t)})):(t.extensionRegistered=!1,t.extensionRequired&&(t.extensionInstalled=!1),void setTimeout(e.bind(null,t))))},t.registerScreenSharingExtensionHelper("firefox",{isSupportedInThisBrowser:"Firefox"===t.$.env.name,autoRegisters:!0,extensionRequired:!1,getConstraintsShowsPermissionUI:!1,sources:{screen:!0,application:"Firefox"===t.$.env.name&&t.$.env.version>=34,window:"Firefox"===t.$.env.name&&t.$.env.version>=34},register:function(){return{isInstalled:function(e){e(!0)},getConstraints:function(e,t,n){t.video={mediaSource:e},n(void 0,t)}}}}),t.registerScreenSharingExtensionHelper("chrome",{isSupportedInThisBrowser:!!navigator.webkitGetUserMedia&&"undefined"!=typeof chrome,autoRegisters:!1,extensionRequired:!0,getConstraintsShowsPermissionUI:!0,sources:{screen:!0,application:!1,window:!1},register:function(n){if(!n)throw new Error("initChromeScreenSharingExtensionHelper: extensionID is required.");var i=!!navigator.webkitGetUserMedia&&"undefined"!=typeof chrome,o={},r=void 0,s="com.tokbox.screenSharing."+n,a=function(e,t){var n={payload:t,from:"jsapi"};return n[s]=e,n},c=function(e,n){var i,r=t.$.uuid();return o[r]=function(){clearTimeout(i),i=null,e.apply(null,arguments)},n&&(i=setTimeout(function(){delete o[r],e(new Error("Timeout waiting for response to request."))},n)),r},u=function(t){if(!t)throw new Error("isAvailable: callback is required.");if(i||setTimeout(t.bind(null,!1)),void 0!==r)setTimeout(t.bind(null,r));else{var n=c(function(e,n){r!==!0&&(r="extensionLoaded"===n),t(r)},2e3),o=a("isExtensionInstalled",{requestId:n});e.postMessage(o,"*")}},d=function(t,n,i){if(!i)throw new Error("getSourceId: callback is required");u(function(o){if(o){var r=c(function(e,t,o){"permissionDenied"===t?i(new Error("PermissionDeniedError")):(n.video||(n.video={}),n.video.mandatory||(n.video.mandatory={}),n.video.mandatory.chromeMediaSource="desktop",n.video.mandatory.chromeMediaSourceId=o.sourceId,i(void 0,n))});e.postMessage(a("getSourceId",{requestId:r,source:t}),"*")}else i(new Error("Extension is not installed"))})};return e.addEventListener("message",function(t){if(t.origin===e.location.origin&&null!=t.data&&"object"==typeof t.data&&"extension"===t.data.from){var n=t.data[s],i=t.data.payload;if(i&&i.requestId){var a=o[i.requestId];delete o[i.requestId],a&&a(null,n,i)}"extensionLoaded"===n&&(r=!0)}}),{isInstalled:u,getConstraints:d}}}),t.StreamChannel=function(e){this.id=e.id,this.type=e.type,this.active=t.$.castToBoolean(e.active),this.orientation=e.orientation||t.VideoOrientation.ROTATED_NORMAL,e.frameRate&&(this.frameRate=parseFloat(e.frameRate,10)),this.width=parseInt(e.width,10),this.height=parseInt(e.height,10),this.source=e.source||"camera",this.fitMode=e.fitMode||"cover",t.$.eventing(this,!0),this.update=function(e){var n={},i={};for(var o in e)if(e.hasOwnProperty(o)){var r=this[o];switch(o){case"active":this.active=t.$.castToBoolean(e[o]);break;case"disableWarning":this.disableWarning=t.$.castToBoolean(e[o]);break;case"frameRate":this.frameRate=parseFloat(e[o],10);break;case"width":case"height":this[o]=parseInt(e[o],10),n[o]=this[o],i[o]=r;break;case"orientation":this[o]=e[o],n[o]=this[o],i[o]=r;break;case"fitMode":this[o]=e[o];break;case"source":this[o]=e[o];break;default:return void t.warn("Tried to update unknown key "+o+" on "+this.type+" channel "+this.id)}this.trigger("update",this,o,r,this[o])}return t.$.keys(n).length&&this.trigger("update",this,"videoDimensions",i,n),!0}},!function(){var e=["name","archiving"];t.Stream=function(n,i,o,r,s,a){var c;this.id=this.streamId=n,this.name=i,this.creationTime=Number(o),this.connection=r,this.channel=a,this.publisher=t.publishers.find({streamId:this.id}),t.$.eventing(this);var u=t.$.bind(function(e,n,i,o){var r=n;switch(r){case"active":r="audio"===e.type?"hasAudio":"hasVideo",this[r]=o;break;case"disableWarning":if(r="audio"===e.type?"audioDisableWarning":"videoDisableWarning",this[r]=o,!this["audio"===e.type?"hasAudio":"hasVideo"])return;
break;case"fitMode":r="defaultFitMode",this[r]=o;break;case"source":r="audio"===e.type?"audioType":"videoType",this[r]=o;break;case"orientation":case"width":case"height":return void(this.videoDimensions={width:e.width,height:e.height,orientation:e.orientation})}this.dispatchEvent(new t.StreamUpdatedEvent(this,r,i,o))},this),d=t.$.bind(function(){return this.publisher?this.publisher:t.subscribers.find(function(e){return e.stream.id===this.id&&e.session.id===s.id})},this);this.getChannelsOfType=function(e){return t.$.filter(this.channel,function(t){return t.type===e})},this.getChannel=function(e){for(var t=0;t<this.channel.length;++t)if(this.channel[t].id===e)return this.channel[t];return null};var l=this.getChannelsOfType("audio")[0],h=this.getChannelsOfType("video")[0];this.hasAudio=null!=l&&l.active,this.hasVideo=null!=h&&h.active,this.videoType=h&&h.source,this.defaultFitMode=h&&h.fitMode,this.videoDimensions={},h&&(this.videoDimensions.width=h.width,this.videoDimensions.height=h.height,this.videoDimensions.orientation=h.orientation,h.on("update",u),this.frameRate=h.frameRate),l&&l.on("update",u),this.setChannelActiveState=function(e,t,n){var i={active:t};n&&(i.activeReason=n),f(e,i)},this.setVideoDimensions=function(e,t){f("video",{width:e,height:t,orientation:0})},this.setRestrictFrameRate=function(e){f("video",{restrictFrameRate:e})};var f=t.$.bind(function(e,n){var i;if(this.publisher)i=function(e){s._.streamChannelUpdate(this,e,n)};else{var o=t.subscribers.find(function(e){return e.stream&&e.stream.id===this.id&&e.session.id===s.id},this);i=function(e){s._.subscriberChannelUpdate(this,o,e,n)}}t.$.forEach(this.getChannelsOfType(e),t.$.bind(i,this))},this);this.destroyed=!1,this.destroyedReason=void 0,this.destroy=function(e,n){c=e||"clientDisconnected",this.destroyed=!0,this.destroyedReason=c,n!==!0&&this.dispatchEvent(new t.DestroyedEvent("destroyed",this,c))},this._={},this._.updateProperty=t.$.bind(function(n,i){if(-1===t.$.arrayIndexOf(e,n))return void t.warn('Unknown stream property "'+n+'" was modified to "'+i+'".');var o=this[n],r=i;switch(n){case"name":this[n]=r;break;case"archiving":var s=d();s&&s._.archivingStatus(r),this[n]=r}var a=new t.StreamUpdatedEvent(this,n,o,r);this.dispatchEvent(a)},this),this._.update=t.$.bind(function(e){for(var t in e)e.hasOwnProperty(t)&&this._.updateProperty(t,e[t])},this),this._.updateChannel=t.$.bind(function(e,t){this.getChannel(e).update(t)},this)}}(e),!function(){var e,n,i;t.SessionInfo=function(e){var n=e[0];t.log("SessionInfo Response:"),t.log(e),this.sessionId=n.session_id,this.partnerId=n.partner_id,this.sessionStatus=n.session_status,this.messagingServer=n.messaging_server_url,this.messagingURL=n.messaging_url,this.symphonyAddress=n.symphony_address,this.p2pEnabled=!!(n.properties&&n.properties.p2p&&n.properties.p2p.preference&&"enabled"===n.properties.p2p.preference.value)},t.SessionInfo.get=function(o,r,s){var a,c=t.properties.apiURL+"/session/"+o.id+"?extended=true",u=t.$.now(),d=function(a){o.logEvent("Instrumentation",null,"gsi",t.$.now()-u);var c=e(a);c===!1?n(o,r,a):i(o,s,c,JSON.stringify(a))};"IE"===t.$.env.name&&t.$.env.version<10?(c=c+"&format=json&token="+encodeURIComponent(o.token)+"&version=1&cache="+t.$.uuid(),a={xdomainrequest:!0}):a={headers:{"X-TB-TOKEN-AUTH":o.token,"X-TB-VERSION":1}},o.logEvent("SessionInfo","Attempt"),t.$.getJSON(c,a,function(e,n){if(e){var r=n;i(o,s,new t.Error(e.target&&e.target.status||e.code,e.message||"Could not connect to the OpenTok API Server."),r)}else d(n)})};var o={};o[404]=t.ExceptionCodes.INVALID_SESSION_ID,o[409]=t.ExceptionCodes.TERMS_OF_SERVICE_FAILURE,o[400]=t.ExceptionCodes.INVALID_SESSION_ID,o[403]=t.ExceptionCodes.AUTHENTICATION_ERROR,e=function(e){if(t.$.isArray(e)){var n=t.$.filter(e,function(e){return null!=e.error}),i=n.length;if(0===i)return!1;var r=n[0].error.code;return o[r.toString()]&&(r=o[r]),{code:r,message:n[0].error.errorMessage&&n[0].error.errorMessage.message}}return{code:null,message:"Unknown error: getSessionInfo JSON response was badly formed"}},n=function(e,n,i){e.logEvent("SessionInfo","Success",{messagingServer:i[0].messaging_server_url}),n(new t.SessionInfo(i))},i=function(e,t,n,i){var o={reason:"GetSessionInfo",code:n.code||"No code",message:n.message+":"+(i||"Empty responseText from API server")};e.logConnectivityEvent("Failure",o),t(n,e)}}(e),!function(){function e(e,i,o,r){var s=n[o],a=r?t.$.clone(r):{};t.error("OT.exception :: title: "+s+" ("+o+") msg: "+i),a.partnerId||(a.partnerId=t.APIKEY);try{t.analytics.logError(o,"tb.exception",s,{details:i},a),t.dispatchEvent(new t.ExceptionEvent(t.Event.names.EXCEPTION,i,s,o,e,e))}catch(c){t.error("OT.exception :: Failed to dispatch exception - "+c.toString())}}t.Error=function(e,t){this.code=e,this.message=t};var n={1004:"Authentication error",1005:"Invalid Session ID",1006:"Connect Failed",1007:"Connect Rejected",1008:"Connect Time-out",1009:"Security Error",1010:"Not Connected",1011:"Invalid Parameter",1012:"Peer-to-peer Stream Play Failed",1013:"Connection Failed",1014:"API Response Failure",1015:"Session connected, cannot test network",1021:"Request Timeout",1026:"Terms of Service Violation: Export Compliance",1500:"Unable to Publish",1503:"No TURN server found",1520:"Unable to Force Disconnect",1530:"Unable to Force Unpublish",1553:"ICEWorkflow failed",1600:"createOffer, createAnswer, setLocalDescription, setRemoteDescription",2e3:"Internal Error",2001:"Unexpected HTTP error codes (f.e. 500)",4e3:"WebSocket Connection Failed",4001:"WebSocket Network Disconnected"};t.handleJsException=function(t,n,i){i=i||{};var o,r=i.session;r?(o={sessionId:r.sessionId},r.isConnected()&&(o.connectionId=r.connection.connectionId),i.target||(i.target=r)):i.sessionId&&(o={sessionId:i.sessionId},i.target||(i.target=null)),e(i.target,t,n,o)},t.dispatchError=function(e,n,i,o){t.error(e,n),i&&t.$.isFunction(i)&&i.call(null,new t.Error(e,n)),t.handleJsException(n,e,{session:o})}}(e),!function(){function e(){var e=!1,n=OTPlugin.isSupported(),i=n?OTPlugin.isReady():!0,o=function(){return!t.$.isDOMUnloaded()&&t.$.isReady()&&e&&i},r=function(){o()&&t.dispatchEvent(new t.EnvLoadedEvent(t.Event.names.ENV_LOADED))},s=function(){t.$.onDOMUnload(a),t.Config.load(t.properties.configURL),r()},a=function(){t.dispatchEvent(new t.EnvLoadedEvent(t.Event.names.ENV_UNLOADED))},c=function(e){i=!0,e&&t.debug("TB Plugin failed to load or was not installed"),r()},u=function(){e=!0,t.Config.off("dynamicConfigChanged",u),t.Config.off("dynamicConfigLoadFailed",d),r()},d=function(){u()};t.Config.on("dynamicConfigChanged",u),t.Config.on("dynamicConfigLoadFailed",d),t.$.onDOMLoad(s),n&&OTPlugin.ready(c),this.onLoad=function(e,n){return o()?void e.call(n):void t.on(t.Event.names.ENV_LOADED,e,n)},this.onUnload=function(e,n){return this.isUnloaded()?void e.call(n):void t.on(t.Event.names.ENV_UNLOADED,e,n)},this.isUnloaded=function(){return t.$.isDOMUnloaded()}}var n=new e;t.onLoad=function(e,t){n.onLoad(e,t)},t.onUnload=function(e,t){n.onUnload(e,t)},t.isUnloaded=function(){return n.isUnloaded()}}();var $,M=document.location.hash;t.HAS_REQUIREMENTS=1,t.NOT_HAS_REQUIREMENTS=0,t.checkSystemRequirements=function(){t.debug("OT.checkSystemRequirements()");var e=t.$.hasCapabilities("websockets","webrtc")||OTPlugin.isInstalled();return e=e?this.HAS_REQUIREMENTS:this.NOT_HAS_REQUIREMENTS,t.checkSystemRequirements=function(){return t.debug("OT.checkSystemRequirements()"),e},e===this.NOT_HAS_REQUIREMENTS&&t.analytics.logEvent({action:"checkSystemRequirements",variation:"notHasRequirements",partnerId:t.APIKEY,payload:{userAgent:t.$.env.userAgent}}),e},t.upgradeSystemRequirements=function(){t.onLoad(function(){if(OTPlugin.isSupported())return void t.Dialogs.Plugin.promptToInstall().on({download:function(){e.location=OTPlugin.pathToInstaller()},refresh:function(){location.reload()},closed:function(){}});var n="_upgradeFlash";document.body.appendChild(function(){var e=document.createElement("iframe");e.id=n,e.style.position="absolute",e.style.position="fixed",e.style.height="100%",e.style.width="100%",e.style.top="0px",e.style.left="0px",e.style.right="0px",e.style.bottom="0px",e.style.zIndex=1e3;try{e.style.backgroundColor="rgba(0,0,0,0.2)"}catch(i){e.style.backgroundColor="transparent",e.setAttribute("allowTransparency","true")}e.setAttribute("frameBorder","0"),e.frameBorder="0",e.scrolling="no",e.setAttribute("scrolling","no");var o=t.properties.minimumVersion[t.$.env.name.toLowerCase()],r=o>t.$.env.version;return e.src=t.properties.assetURL+"/html/upgrade.html#"+encodeURIComponent(r?"true":"false")+","+encodeURIComponent(JSON.stringify(t.properties.minimumVersion))+"|"+encodeURIComponent(document.location.href),e}()),$&&clearInterval($),$=setInterval(function(){var e=document.location.hash,t=/^#?\d+&/;e!==M&&t.test(e)&&(M=e,"close_window"===e.replace(t,"")&&(document.body.removeChild(document.getElementById(n)),document.location.hash=""))},100)})},t.ConnectionCapabilities=function(e){var n=function(e){return e.supportsWebRTC=t.$.castToBoolean(e.supportsWebRTC),e},i=n(e);this.supportsWebRTC=i.supportsWebRTC},t.Capabilities=function(e){this.publish=-1!==t.$.arrayIndexOf(e,"publish")?1:0,this.subscribe=-1!==t.$.arrayIndexOf(e,"subscribe")?1:0,this.forceUnpublish=-1!==t.$.arrayIndexOf(e,"forceunpublish")?1:0,this.forceDisconnect=-1!==t.$.arrayIndexOf(e,"forcedisconnect")?1:0,this.supportsWebRTC=t.$.hasCapabilities("webrtc")?1:0,this.permittedTo=function(e){return this.hasOwnProperty(e)&&1===this[e]}},t.Connection=function(e,n,i,o,r){var s;this.id=this.connectionId=e,this.creationTime=n?Number(n):null,this.data=i,this.capabilities=new t.ConnectionCapabilities(o),this.permissions=new t.Capabilities(r),this.quality=null,t.$.eventing(this),this.destroy=t.$.bind(function(e,n){s=e||"clientDisconnected",n!==!0&&this.dispatchEvent(new t.DestroyedEvent("destroyed",this,s))},this),this.destroyed=function(){return void 0!==s},this.destroyedReason=function(){return s}},t.Connection.fromHash=function(e){return new t.Connection(e.id,e.creationTime,e.data,t.$.extend(e.capablities||{},{supportsWebRTC:!0}),e.permissions||[])},!function(){var e=8192,n=128;t.Signal=function(i,o,r){var s=function(e){return!/^[a-zA-Z0-9\-\._~]+$/.exec(e)},a=function(e){return e?e instanceof t.Connection||e instanceof t.Session?null:{code:400,reason:"The To field was invalid"}:{code:400,reason:"The signal to field was invalid. Either set it to a OT.Connection, OT.Session, or omit it entirely"}},c=function(e){var t=null;return null===e||void 0===e?t={code:400,reason:"The signal type was null or undefined. Either set it to a String value or omit it"}:e.length>n?t={code:413,reason:"The signal type was too long, the maximum length of it is "+n+" characters"}:s(e)&&(t={code:400,reason:"The signal type was invalid, it can only contain letters, numbers, '-', '_', and '~'."}),t},u=function(t){var n=null;if(null===t||void 0===t)n={code:400,reason:"The signal data was null or undefined. Either set it to a String value or omit it"};else try{JSON.stringify(t).length>e&&(n={code:413,reason:"The data field was too long, the maximum size of it is "+e+" characters"})}catch(i){n={code:400,reason:"The data field was not valid JSON"}}return n};this.toRaptorMessage=function(){var e=this.to;return e&&"string"!=typeof e&&(e=e.id),t.Raptor.Message.signals.create(t.APIKEY,i,e,this.type,this.data)},this.toHash=function(){return r},this.error=null,r&&(r.hasOwnProperty("data")&&(this.data=t.$.clone(r.data),this.error=u(this.data)),r.hasOwnProperty("to")&&(this.to=r.to,this.error||(this.error=a(this.to))),r.hasOwnProperty("type")&&(this.error||(this.error=c(r.type)),this.type=r.type)),this.valid=null===this.error}}(this),t.Raptor.Socket=function(e,n,i,o,r){var s,a,c,u,d,h=["disconnected","connecting","connected","error","disconnecting"],f=t.$.statable(this,h,"disconnected"),p=function(e){f(e?"error":"connected"),d.apply(null,arguments)},m=t.$.bind(function(e){var t=this.is("disconnecting")?"clientDisconnected":"networkDisconnected";e&&4001===e.code&&(t="networkTimedout"),f("disconnected"),u.onClose(t)},this),g=function(){};this.connect=function(n,r,l){if(!this.is("disconnected","error"))return void t.warn("Cannot connect the Raptor Socket as it is currently connected. You should disconnect first.");f("connecting"),s=r.sessionId,a=n,d=l;var h="/v2/partner/"+t.APIKEY+"/session/"+s;c=new t.Rumor.Socket(i,o),c.onClose(m),c.onMessage(t.$.bind(u.dispatch,u)),c.connect(e,t.$.bind(function(n){if(n)return void p({reason:"WebSocketConnection",code:n.code,message:n.message});c.onError(g),t.debug("Raptor Socket connected. Subscribing to "+h+" on "+i),c.subscribe([h]);var o=t.Raptor.Message.connections.create(t.APIKEY,s,c.id());this.publish(o,{"X-TB-TOKEN-AUTH":a},t.$.bind(function(n){if(n){n.message="ConnectToSession:"+n.code+":Received error response to connection create message.";var i={reason:"ConnectToSession",code:n.code,message:"Received error response to connection create message."},o={action:"Connect",variation:"Failure",payload:i,sessionId:s,partnerId:t.APIKEY,connectionId:e};return t.analytics.logEvent(o),void p(i)}this.publish(t.Raptor.Message.sessions.get(t.APIKEY,s),function(n){if(n){var i={reason:"GetSessionState",code:n.code,message:"Received error response to session read"},o={action:"Connect",variation:"Failure",payload:i,sessionId:s,partnerId:t.APIKEY,connectionId:e};t.analytics.logEvent(o),p(i)}else p.apply(null,arguments)})},this))},this))},this.disconnect=function(e){this.is("disconnected")||(f("disconnecting"),c.disconnect(e))},this.publish=function(e,n,i){if(c.isNot("connected"))return void t.error("OT.Raptor.Socket: cannot publish until the socket is connected."+e);var r,s=t.$.uuid(),a={};return n&&(t.$.isFunction(n)?(a={},r=n):a=n),!r&&i&&t.$.isFunction(i)&&(r=i),r&&u.registerCallback(s,r),t.debug("OT.Raptor.Socket Publish (ID:"+s+") "),t.debug(e),c.publish([o],e,t.$.extend(a,{"Content-Type":"application/x-raptor+v2","TRANSACTION-ID":s,"X-TB-FROM-ADDRESS":c.id()})),s},this.streamCreate=function(e,n,i,o,r,a,c){var u=t.Raptor.Message.streams.create(t.APIKEY,s,n,e,i,o,r,a);this.publish(u,function(e,t){c(e,n,t)})},this.streamDestroy=function(e){this.publish(t.Raptor.Message.streams.destroy(t.APIKEY,s,e))},this.streamChannelUpdate=function(e,n,i){this.publish(t.Raptor.Message.streamChannels.update(t.APIKEY,s,e,n,i))},this.subscriberCreate=function(e,n,i,o){this.publish(t.Raptor.Message.subscribers.create(t.APIKEY,s,e,n,c.id(),i),o)},this.subscriberDestroy=function(e,n){this.publish(t.Raptor.Message.subscribers.destroy(t.APIKEY,s,e,n))},this.subscriberUpdate=function(e,n,i){this.publish(t.Raptor.Message.subscribers.update(t.APIKEY,s,e,n,i))},this.subscriberChannelUpdate=function(e,n,i,o){this.publish(t.Raptor.Message.subscriberChannels.update(t.APIKEY,s,e,n,i,o))},this.forceDisconnect=function(e,n){this.publish(t.Raptor.Message.connections.destroy(t.APIKEY,s,e),n)},this.forceUnpublish=function(e,n){this.publish(t.Raptor.Message.streams.destroy(t.APIKEY,s,e),n)},this.jsepCandidate=function(e,n){this.publish(t.Raptor.Message.streams.candidate(t.APIKEY,s,e,n))},this.jsepCandidateP2p=function(e,n,i){this.publish(t.Raptor.Message.subscribers.candidate(t.APIKEY,s,e,n,i))},this.jsepOffer=function(e,n){this.publish(t.Raptor.Message.offer(e,n))},this.jsepAnswer=function(e,n){this.publish(t.Raptor.Message.streams.answer(t.APIKEY,s,e,n))},this.jsepAnswerP2p=function(e,n,i){this.publish(t.Raptor.Message.subscribers.answer(t.APIKEY,s,e,n,i))},this.signal=function(e,n,i){var o=new t.Signal(s,c.id(),e||{});return o.valid?void this.publish(o.toRaptorMessage(),function(e){var r;if(e)r=new l(e.code,e.message);else{var s=o.data?typeof o.data:null;i("signal","send",{type:s})}n&&t.$.isFunction(n)&&n(r,o.toHash())}):void(n&&t.$.isFunction(n)&&n(new l(o.error.code,o.error.reason),o.toHash()))},this.id=function(){return c&&c.id()},null==r&&(r=new t.Raptor.Dispatcher),u=r},t.GetStatsAudioLevelSampler=function(e){if(!t.$.hasCapabilities("audioOutputLevelStat"))throw new Error("The current platform does not provide the required capabilities");var n=e,i="audioOutputLevel";this.sample=function(e){n.getStats(function(t,n){if(!t)for(var o=0;o<n.length;o++){var r=n[o],s=parseFloat(r[i]);if(!isNaN(s))return void e(s/32768)}e(null)})}},t.AnalyserAudioLevelSampler=function(e){var t=this,n=null,i=null,o=function(t){var n=e.createMediaStreamSource(t),i=e.createAnalyser();return n.connect(i),i};this.webRTCStream=null,this.sample=function(e){if(!n&&t.webRTCStream&&(n=o(t.webRTCStream),i=new Uint8Array(n.frequencyBinCount)),n){n.getByteTimeDomainData(i);for(var r=0,s=0;s<i.length;s++)r=Math.max(r,Math.abs(i[s]-128));e(r/128)}else e(null)}},t.AudioLevelTransformer=function(){var e=null;this.transform=function(t){e=null===e||t>=e?t:.3*t+.7*e;var n=Math.log(e)/Math.LN10/1.5+1;return Math.min(Math.max(n,0),1)}},t.audioContext=function(){var n=new e.AudioContext;return t.audioContext=function(){return n},n},t.Archive=function(e,n,i){this.id=e,this.name=n,this.status=i,this._={},t.$.eventing(this),this._.update=t.$.bind(function(e){for(var n in e)if(e.hasOwnProperty(n)){var i=this[n];this[n]=e[n];var o=new t.ArchiveUpdatedEvent(this,n,i,this[n]);this.dispatchEvent(o)}},this),this.destroy=function(){}},t.analytics=new t.Analytics(t.properties.loggingURL),t.Subscriber=function(e,n,i){var o,r,s,a,c,u,d,l,h,f,p,m,g,v,b,y=t.$.uuid(),E=e||y,S=n.session,T=n.stream,w=100,C=t.$.hasCapabilities("audioOutputLevelStat")||t.$.hasCapabilities("webAudioCapableRemoteStream"),O=!1,R=this;if(h=t.$.defaults({},n,{showControls:!0,fitMode:T.defaultFitMode||"cover"}),this.id=E,this.widgetId=y,this.session=S,this.stream=T=h.stream,this.streamId=T.id,p={timeStamp:t.$.now()},!S)return void t.handleJsException("Subscriber must be passed a session option",2e3,{session:S,target:this});t.$.eventing(this,!1),"function"==typeof i&&this.once("subscribeComplete",i),C&&this.on({"audioLevelUpdated:added":function(e){1===e&&v&&v.start()},"audioLevelUpdated:removed":function(e){0===e&&v&&v.stop()}});var I=function(e,n,i,o){var r=[{action:e,variation:n,payload:i,streamId:T?T.id:null,sessionId:S?S.sessionId:null,connectionId:S&&S.isConnected()?S.connection.connectionId:null,partnerId:S&&S.isConnected()?S.sessionInfo.partnerId:null,subscriberId:y}];o&&r.push(o),t.analytics.logEvent.apply(t.analytics,r)},A=function(e,n){"Attempt"!==e&&b||(b=new t.ConnectivityAttemptPinger({action:"Subscribe",sessionId:S?S.sessionId:null,connectionId:S&&S.isConnected()?S.connection.connectionId:null,partnerId:S.isConnected()?S.sessionInfo.partnerId:null,streamId:T?T.id:null})),b.setVariation(e),I("Subscribe",e,n)},P=t.$.bind(function(e){var n={streamType:"WebRTC",width:o?Number(t.$.width(o.domElement).replace("px","")):null,height:o?Number(t.$.height(o.domElement).replace("px","")):null,sessionId:S?S.sessionId:null,connectionId:S?S.connection.connectionId:null,mediaServerName:S?S.sessionInfo.messagingServer:null,p2pFlag:S?S.sessionInfo.p2pEnabled:!1,partnerId:S?S.apiKey:null,streamId:T.id,subscriberId:y,version:t.properties.version,duration:parseInt(t.$.now()-d,10),remoteConnectionId:T.connection.connectionId};t.analytics.logQOS(t.$.extend(n,e)),this.trigger("qos",e)},this),D=function(e){t.error("Subscriber State Change Failed: ",e.message),t.debug(e)},N=function(){if(!f.isSubscribing()&&r){t.debug("OT.Subscriber.onLoaded"),f.set("Subscribing"),d=t.$.now();var e={pcc:parseInt(d-l,10),hasRelayCandidates:u&&u.hasRelayCandidates()};I("createPeerConnection","Success",e),o.loading(!1),s.showAfterLoading(),O&&T.setRestrictFrameRate(!0),a&&"auto"===R.getStyle("audioLevelDisplayMode")&&a[o.audioOnly()?"show":"hide"](),this.trigger("subscribeComplete",null,this),this.trigger("loaded",this),A("Success",{streamId:T.id})}},_=function(){t.debug("OT.Subscriber has been disconnected from the Publisher's PeerConnection"),f.isAttemptingToSubscribe()?(f.set("Failed"),this.trigger("subscribeComplete",new t.Error(null,"ClientDisconnected"))):f.isSubscribing()&&f.set("Failed"),this.disconnect()},$=t.$.bind(function(e,n,i,o){var r;f.isAttemptingToSubscribe()?(r={reason:o?o:"PeerConnectionError",message:"Subscriber PeerConnection Error: "+n,hasRelayCandidates:u&&u.hasRelayCandidates()},I("createPeerConnection","Failure",r),f.set("Failed"),this.trigger("subscribeComplete",new t.Error(null,n))):f.isSubscribing()&&(f.set("Failed"),this.trigger("error",n)),this.disconnect(),r={reason:o?o:"PeerConnectionError",message:"Subscriber PeerConnection Error: "+n,code:t.ExceptionCodes.P2P_CONNECTION_FAILED},A("Failure",r),t.handleJsException("Subscriber PeerConnection Error: "+n,t.ExceptionCodes.P2P_CONNECTION_FAILED,{session:S,target:this}),B.call(this,n)},this),M=function(e){t.debug("OT.Subscriber.onRemoteStreamAdded"),f.set("BindingRemoteStream"),this.subscribeToAudio(h.subscribeToAudio),m="loading",this.subscribeToVideo(h.subscribeToVideo,"loading");var n,i={error:$,audioVolume:w},s=!1;!T.hasVideo&&"Chrome"===t.$.env.name&&t.$.env.version>=35&&(n=e.getVideoTracks(),n.length>0&&(n[0].enabled=!1,s=n[0])),r=o.bindVideo(e,i,t.$.bind(function(e){return e?void $(null,e.message||e,u,"VideoElement"):(null!=s&&h.subscribeToVideo&&(s.enabled=!0),r.orientation({width:T.videoDimensions.width,height:T.videoDimensions.height,videoOrientation:T.videoDimensions.orientation}),void N.call(this,null))},this)),t.$.hasCapabilities("webAudioCapableRemoteStream")&&g&&e.getAudioTracks().length>0&&(g.webRTCStream=e),I("createPeerConnection","StreamAdded"),this.trigger("streamAdded",this)},k=function(e){t.debug("OT.Subscriber.onStreamRemoved"),r.stream===e&&(r.destroy(),r=null),this.trigger("streamRemoved",this)},L=function(){this.disconnect()},x=function(e){switch(e.changedProperty){case"videoDimensions":if(!r)break;r.orientation({width:e.newValue.width,height:e.newValue.height,videoOrientation:e.newValue.orientation}),this.dispatchEvent(new t.VideoDimensionsChangedEvent(this,e.oldValue,e.newValue));break;case"videoDisableWarning":s.videoDisabledIndicator.setWarning(e.newValue),this.dispatchEvent(new t.VideoDisableWarningEvent(e.newValue?"videoDisableWarning":"videoDisableWarningLifted"));break;case"hasVideo":H(!(T.hasVideo&&h.subscribeToVideo)),this.dispatchEvent(new t.VideoEnabledChangedEvent(T.hasVideo?"videoEnabled":"videoDisabled",{reason:"publishVideo"}));break;case"hasAudio":}},U=function(e){if(e===!1)return"off";var t=this.getStyle("buttonDisplayMode");return t===!1?"on":t},F=function(e,t){if(s)switch(e){case"nameDisplayMode":s.name.setDisplayMode(t),s.backingBar.setNameMode(t);break;case"videoDisabledDisplayMode":s.videoDisabledIndicator.setDisplayMode(t);break;case"showArchiveStatus":s.archive.setShowArchiveStatus(t);break;case"buttonDisplayMode":s.muteButton.setDisplayMode(t),s.backingBar.setMuteMode(t);break;case"audioLevelDisplayMode":s.audioLevel.setDisplayMode(t);break;case"bugDisplayMode":case"backgroundImageURI":o.setBackgroundImageURI(t)}},V=function(){var e={backingBar:new t.Chrome.BackingBar({nameMode:h.name?this.getStyle("nameDisplayMode"):"off",muteMode:U.call(this,this.getStyle("showMuteButton"))}),name:new t.Chrome.NamePanel({name:h.name,mode:this.getStyle("nameDisplayMode")}),muteButton:new t.Chrome.MuteButton({muted:h.muted,mode:U.call(this,this.getStyle("showMuteButton"))}),archive:new t.Chrome.Archiving({show:this.getStyle("showArchiveStatus"),archiving:!1})};if(C){var n=new t.AudioLevelTransformer,i=function(e){a.setValue(n.transform(e.audioLevel))};a=new t.Chrome.AudioLevelMeter({mode:this.getStyle("audioLevelDisplayMode"),onActivate:function(){R.on("audioLevelUpdated",i)},onPassivate:function(){R.off("audioLevelUpdated",i)}}),e.audioLevel=a}e.videoDisabledIndicator=new t.Chrome.VideoDisabledIndicator({mode:this.getStyle("videoDisabledDisplayMode")}),s=new t.Chrome({parent:o.domElement}).set(e).on({muted:function(){W.call(this,!0)},unmuted:function(){W.call(this,!1)}},this),s.hideWhileLoading()},B=function(){o&&o.addError("The stream was unable to connect due to a network error.","Make sure your connection isn't blocked by a firewall.")};t.StylableComponent(this,{nameDisplayMode:"auto",buttonDisplayMode:"auto",audioLevelDisplayMode:"auto",videoDisabledDisplayMode:"auto",backgroundImageURI:null,showArchiveStatus:!0,showMicButton:!0},h.showControls,function(e){I("SetStyle","Subscriber",e,.1)});var H=function(e){o&&(o.audioOnly(e),o.showPoster(e)),a&&"auto"===R.getStyle("audioLevelDisplayMode")&&a[e?"show":"hide"]()},j=function(){var e=0;return function(){e%100===0&&I("getStats","Called"),e++}}();this.destroy=function(e,n){return f.isDestroyed()?void 0:("streamDestroyed"===e&&f.isAttemptingToSubscribe()&&this.trigger("subscribeComplete",new t.Error(null,"InvalidStreamID")),f.set("Destroyed"),v&&v.stop(),this.disconnect(),s&&(s.destroy(),s=null),o&&(o.destroy(),o=null,this.element=null),T&&!T.destroyed&&I("unsubscribe",null,{streamId:T.id}),this.id=E=null,this.stream=T=null,this.streamId=null,this.session=S=null,h=null,n!==!0&&this.dispatchEvent(new t.DestroyedEvent(t.Event.names.SUBSCRIBER_DESTROYED,this,e),t.$.bind(this.off,this)),this)},this.disconnect=function(){f.isDestroyed()||f.isFailed()||f.set("NotSubscribing"),r&&(r.destroy(),r=null),u&&(u.destroy(),u=null,I("disconnect","PeerConnection",{streamId:T.id}))},this.processMessage=function(e,n,i){t.debug("OT.Subscriber.processMessage: Received "+e+" message from "+n.id),t.debug(i),c!==n.id&&(c=n.id),u&&u.processMessage(e,i)},this.disableVideo=function(e){if(e){if("auto"!==m)return void t.info("Video was not re-enabled because it was manually disabled");t.info("Video has been re-enabled"),s.videoDisabledIndicator.disableVideo(!1)}else t.warn("Due to high packet loss and low bandwidth, video has been disabled");this.subscribeToVideo(e,"auto"),e||s.videoDisabledIndicator.disableVideo(!0);var n=e?{videoEnabled:!0}:{videoDisabled:!0};I("updateQuality","video",n)},this.getImgData=function(){return this.isSubscribing()?r.imgData():(t.error("OT.Subscriber.getImgData: Cannot getImgData before the Subscriber is subscribing."),null)},this.getStats=function(e){return u?(j(),void u.getStats(function(n,i){if(n)return void e(n);var o={timestamp:0};t.$.forEach(i,function(e){if(t.getStatsHelpers.isInboundStat(e)){var n=t.getStatsHelpers.isVideoStat(e),i=t.getStatsHelpers.isAudioStat(e);(i||n)&&(o.timestamp=t.getStatsHelpers.normalizeTimestamp(e.timestamp)),n?o.video=t.getStatsHelpers.parseStatCategory(e):i&&(o.audio=t.getStatsHelpers.parseStatCategory(e))}}),e(null,o)})):void e(new t.$.Error("Subscriber is not connected cannot getStats",1015))},this.setAudioVolume=function(e){return e=parseInt(e,10),isNaN(e)?(t.error("OT.Subscriber.setAudioVolume: value should be an integer between 0 and 100"),this):(w=Math.max(0,Math.min(100,e)),w!==e&&t.warn("OT.Subscriber.setAudioVolume: value should be an integer between 0 and 100"),h.muted&&w>0&&(h.premuteVolume=e,W.call(this,!1)),r&&r.setAudioVolume(w),this)},this.getAudioVolume=function(){return h.muted?0:r?r.getAudioVolume():w},this.subscribeToAudio=function(e){var n=t.$.castToBoolean(e,!0);return u&&(u.subscribeToAudio(n&&!h.subscribeMute),S&&T&&n!==h.subscribeToAudio&&T.setChannelActiveState("audio",n&&!h.subscribeMute)),h.subscribeToAudio=n,this};var W=function(e){s.muteButton.muted(e),e!==h.mute&&("Chrome"===t.$.env.name||OTPlugin.isInstalled()?(h.subscribeMute=h.muted=e,this.subscribeToAudio(h.subscribeToAudio)):e?(h.premuteVolume=this.getAudioVolume(),h.muted=!0,this.setAudioVolume(0)):(h.premuteVolume||h.audioVolume)&&(h.muted=!1,this.setAudioVolume(h.premuteVolume||h.audioVolume)),h.mute=h.mute)},q={auto:"quality",publishVideo:"publishVideo",subscribeToVideo:"subscribeToVideo"};if(this.subscribeToVideo=function(e,n){var i=t.$.castToBoolean(e,!0);return H(!(i&&T.hasVideo)),i&&o&&o.video()&&(o.loading(i),o.video().whenTimeIncrements(function(){o.loading(!1)},this)),s&&s.videoDisabledIndicator&&s.videoDisabledIndicator.disableVideo(!1),u&&(u.subscribeToVideo(i),S&&T&&(i!==h.subscribeToVideo||n!==m)&&T.setChannelActiveState("video",i,n)),h.subscribeToVideo=i,m=n,"loading"!==n&&this.dispatchEvent(new t.VideoEnabledChangedEvent(i?"videoEnabled":"videoDisabled",{reason:q[n]||"subscribeToVideo"})),this},this.isSubscribing=function(){return f.isSubscribing()},this.isWebRTC=!0,this.isLoading=function(){return o&&o.loading()},this.videoElement=function(){return r.domElement()},this.videoWidth=function(){return r.videoWidth()},this.videoHeight=function(){return r.videoHeight()},this.restrictFrameRate=function(e){return t.debug("OT.Subscriber.restrictFrameRate("+e+")"),I("restrictFrameRate",e.toString(),{streamId:T.id}),S.sessionInfo.p2pEnabled&&t.warn("OT.Subscriber.restrictFrameRate: Cannot restrictFrameRate on a P2P session"),"boolean"!=typeof e?t.error("OT.Subscriber.restrictFrameRate: expected a boolean value got a "+typeof e):(O=e,T.setRestrictFrameRate(e)),this},this.on("styleValueChanged",F,this),this._={archivingStatus:function(e){s&&s.archive.setArchiving(e)}},f=new t.SubscribingState(D),t.debug("OT.Subscriber: subscribe to "+T.id),f.set("Init"),!T)return t.error("OT.Subscriber: No stream parameter."),!1;if(T.on({updated:x,destroyed:L},this),c=T.connection.id,h.name=h.name||T.name,h.classNames="OT_root OT_subscriber",h.style&&this.setStyle(h.style,null,!0),h.audioVolume&&this.setAudioVolume(h.audioVolume),h.subscribeToAudio=t.$.castToBoolean(h.subscribeToAudio,!0),h.subscribeToVideo=t.$.castToBoolean(h.subscribeToVideo,!0),o=new t.WidgetView(e,h),this.id=E=o.domId(),this.element=o.domElement,V.call(this),l=t.$.now(),T.connection.id!==S.connection.id){if(I("createPeerConnection","Attempt",""),f.set("ConnectingToPeer"),u=new t.SubscriberPeerConnection(T.connection,S,T,this,h),u.on({disconnected:_,error:$,remoteStreamAdded:M,remoteStreamRemoved:k,qos:P},this),u.init(),t.$.hasCapabilities("audioOutputLevelStat")?g=new t.GetStatsAudioLevelSampler(u,"out"):t.$.hasCapabilities("webAudioCapableRemoteStream")&&(g=new t.AnalyserAudioLevelSampler(t.audioContext())),g){var G=this;v=new t.IntervalRunner(function(){g.sample(function(e){null!==e&&t.$.requestAnimationFrame(function(){G.dispatchEvent(new t.AudioLevelUpdatedEvent(e))})})},60)}}else{I("createPeerConnection","Attempt","");var z=S.getPublisherForStream(T);if(!z||!z._.webRtcStream())return this.trigger("subscribeComplete",new t.Error(null,"InvalidStreamID")),this;M.call(this,z._.webRtcStream())}A("Attempt",{streamId:T.id})},t.Session=function(e,n){function i(e){return new Promise(function(n,i){t.$.getJSON([t.properties.apiURL,"/v2/partner/",A,"/session/",D,"/connection/",_,"/testNetworkConfig"].join(""),{headers:{"X-TB-TOKEN-AUTH":e}},function(e,o){if(e){var r=JSON.parse(e.target.responseText);i(-1===r.code?new t.$.Error("Unexpected HTTP error codes "+e.target.status,"2001"):10001===r.code||10002===r.code?new t.$.Error(r.message,"1004"):new t.$.Error(r.message,r.code))}else n(o)})})}if(t.$.eventing(this),!t.checkSystemRequirements())return void t.upgradeSystemRequirements();null==n&&(n=e,e=null),this.id=this.sessionId=n;var o,r,s,a,c,u,d,l,h,f,p,m,g,v,b,y,E,S,T,w,C,O,R,I=!0,A=e,P=this,D=n,N=t.$.uuid(),_=t.$.uuid(),$=t.$.statable(this,["disconnected","connecting","connected","disconnecting"],"disconnected");this.connection=null,this.connections=new t.$.Collection,this.streams=new t.$.Collection,this.archives=new t.$.Collection,s=function(e,n){$("disconnected"),t.error(e),this.trigger("sessionConnectFailed",new t.Error(n||t.ExceptionCodes.CONNECT_FAILED,e)),t.handleJsException(e,n||t.ExceptionCodes.CONNECT_FAILED,{session:this})},a=function(e){var n=e.reason;"networkTimedout"===n?(n="networkDisconnected",this.logEvent("Connect","TimeOutDisconnect",{reason:e.reason})):this.logEvent("Connect","Disconnected",{reason:e.reason});var i=new t.SessionDisconnectEvent("sessionDisconnected",n);v(),b.call(this,n);var o=t.$.bind(function(){y.call(this,i.reason),i.isDefaultPrevented()||E.call(this,i.reason)},this);this.dispatchEvent(i,o)},c=function(e){e.id.match(/^symphony\./)||this.dispatchEvent(new t.ConnectionEvent(t.Event.names.CONNECTION_CREATED,e))
},u=function(e,n){e.id.match(/^symphony\./)||e.id!==r.id()&&this.dispatchEvent(new t.ConnectionEvent(t.Event.names.CONNECTION_DESTROYED,e,n))},d=function(e){e.connection.id!==this.connection.id&&this.dispatchEvent(new t.StreamEvent(t.Event.names.STREAM_CREATED,e,null,!1))},l=function(e){var n=e.target,i=e.changedProperty,o=e.newValue;"videoDisableWarning"!==i&&"audioDisableWarning"!==i&&("orientation"===i&&(i="videoDimensions",o={width:o.width,height:o.height}),this.dispatchEvent(new t.StreamPropertyChangedEvent(t.Event.names.STREAM_PROPERTY_CHANGED,n,i,e.oldValue,o)))},h=function(e,n){if(e.connection.id===this.connection.id)return void t.$.forEach(t.publishers.where({streamId:e.id}),t.$.bind(function(e){e._.unpublishFromSession(this,n)},this));var i=new t.StreamEvent("streamDestroyed",e,n,!0),o=t.$.bind(function(){i.isDefaultPrevented()||t.$.forEach(t.subscribers.where({streamId:e.id}),function(e){e.session.id===this.id&&e.stream&&e.destroy("streamDestroyed")},this)},this);this.dispatchEvent(i,o)},f=function(e){this.dispatchEvent(new t.ArchiveEvent("archiveStarted",e))},p=function(e){this.dispatchEvent(new t.ArchiveEvent("archiveDestroyed",e))},m=function(e){var n=e.target,i=e.changedProperty,o=e.newValue;this.dispatchEvent("status"===i&&"stopped"===o?new t.ArchiveEvent("archiveStopped",n):new t.ArchiveEvent("archiveUpdated",n))},g=function(){P.token=o=null,$("disconnected"),P.connection=null,P.capabilities=new t.Capabilities([]),P.connections.destroy(),P.streams.destroy(),P.archives.destroy()},v=function(){_=t.$.uuid(),g()},b=function(e){t.$.forEach(t.publishers.where({session:this}),function(t){t.disconnect(e)}),t.$.forEach(t.subscribers.where({session:this}),function(e){e.disconnect()})},y=function(e){t.$.forEach(t.publishers.where({session:this}),function(t){t._.streamDestroyed(e)})},E=function(e){t.$.forEach(t.subscribers.where({session:this}),function(t){t.destroy(e)})},S=function(){t.debug("OT.Session: connecting to Raptor");var e=this.sessionInfo.messagingURL,n=t.properties.symphonyAddresss||this.sessionInfo.symphonyAddress;r=new t.Raptor.Socket(_,N,e,n,t.SessionDispatcher(this)),r.connect(o,this.sessionInfo,t.$.bind(function(e,n){return e?(r=void 0,this.logConnectivityEvent("Failure",e),void s.call(this,e.message,e.code)):(t.debug("OT.Session: Received session state from Raptor",n),this.connection=this.connections.get(r.id()),this.connection&&(this.capabilities=this.connection.permissions),$("connected"),this.logConnectivityEvent("Success",null,{connectionId:this.connection.id}),this.connection.on("destroyed",a,this),this.connections.on({add:c,remove:u},this),this.streams.on({add:d,remove:h,update:l},this),this.archives.on({add:f,remove:p,update:m},this),void this.dispatchEvent(new t.SessionConnectEvent(t.Event.names.SESSION_CONNECTED),t.$.bind(function(){this.connections._triggerAddEvents(),this.streams._triggerAddEvents(),this.archives._triggerAddEvents()},this)))},this))},T=function(){this.is("connecting")&&t.SessionInfo.get(this,t.$.bind(w,this),t.$.bind(function(e){s.call(this,e.message+(e.code?" ("+e.code+")":""),e.code)},this))},w=function(e){if(this.is("connecting")){var n=t.properties.sessionInfoOverrides;if(this.sessionInfo=e,null!=n&&"object"==typeof n&&(this.sessionInfo=t.$.defaults(n,this.sessionInfo)),this.sessionInfo.partnerId&&this.sessionInfo.partnerId!==A){this.apiKey=A=this.sessionInfo.partnerId;var i="Authentication Error: The API key does not match the token or session.",o={code:t.ExceptionCodes.AUTHENTICATION_ERROR,message:i};this.logEvent("Failure","SessionInfo",o),s.call(this,i,t.ExceptionCodes.AUTHENTICATION_ERROR)}else S.call(this)}},C=t.$.bind(function(e){return this.capabilities.permittedTo(e)},this),R=t.$.bind(function(e,n,i){t.dispatchError(e,n,i,this)},this),this.logEvent=function(e,n,i,o){var r={action:e,variation:n,payload:i,sessionId:D,partnerId:A};r.connectionId=_,o&&(r=t.$.extend(o,r)),t.analytics.logEvent(r)},this.testNetwork=function(e,n,o){var r=o;if(o=function(e,t){e?P.logEvent("TestNetwork","Failure",{failureCode:e.name||e.message||"unknown"}):P.logEvent("TestNetwork","Success",t),r(e,t)},P.logEvent("TestNetwork","Attempt",{}),this.isConnected())return void o(new t.$.Error("Session connected, cannot test network",1015));var s,a,c=new Promise(function(e,t){var i=n._.webRtcStream();if(i)e(i);else{var o=function(){s(),e(n._.webRtcStream())},r=function(e){e&&(s(),t(e))},s=function(){n.off("publishComplete",r),n.off("accessAllowed",o)};n.on("publishComplete",r),n.on("accessAllowed",o)}});Promise.all([i(e),c]).then(function(e){var n=e[1];return s=e[0],t.webrtcTest({mediaConfig:s.media,localStream:n})}).then(function(e){return t.debug("Received stats from webrtcTest: ",e),e.bandwidth<s.media.thresholdBitsPerSecond?Promise.reject(new t.$.Error("The detect bandwidth form the WebRTC stage of the test was not sufficient to run the HTTP stage of the test",1553)):void(a=e)}).then(function(){return t.httpTest({httpConfig:s.http})}).then(function(e){var t={uploadBitsPerSecond:e.uploadBandwidth,downloadBitsPerSecond:e.downloadBandwidth,packetLossRatio:a.packetLostRatio,roundTripTimeMilliseconds:a.roundTripTime};o(null,t)})["catch"](function(e){o(e)})},this.logConnectivityEvent=function(e,n,i){if("Attempt"===e||!O){var o={action:"Connect",sessionId:D,partnerId:A};this.connection&&this.connection.id?o=event.connectionId=this.connection.id:_&&(o.connectionId=_),O=new t.ConnectivityAttemptPinger(o)}O.setVariation(e),this.logEvent("Connect",e,n,i)},this.connect=function(n){null==e&&arguments.length>1&&("string"==typeof arguments[0]||"number"==typeof arguments[0])&&"string"==typeof arguments[1]&&(A=n.toString(),n=arguments[1]);var i=arguments[arguments.length-1];return this.is("connecting","connected")?(t.warn("OT.Session: Cannot connect, the session is already "+this.state),this):(g(),$("connecting"),this.token=o=!t.$.isFunction(n)&&n,I?I=!1:N=t.$.uuid(),i&&t.$.isFunction(i)&&(this.once("sessionConnected",t.$.bind(i,null,null)),this.once("sessionConnectFailed",i)),null==A||t.$.isFunction(A)?(setTimeout(t.$.bind(s,this,"API Key is undefined. You must pass an API Key to initSession.",t.ExceptionCodes.AUTHENTICATION_ERROR)),this):D?(this.apiKey=A=A.toString(),0===t.APIKEY.length&&(t.APIKEY=A),this.logConnectivityEvent("Attempt"),T.call(this),this):(setTimeout(t.$.bind(s,this,"SessionID is undefined. You must pass a sessionID to initSession.",t.ExceptionCodes.INVALID_SESSION_ID)),this))};var M=t.$.bind(function(e){r&&r.isNot("disconnected")?r.isNot("disconnecting")&&($("disconnecting"),r.disconnect(e)):v()},this);this.disconnect=function(e){M(void 0!==e?e:!0)},this.destroy=function(e){this.streams.destroy(),this.connections.destroy(),this.archives.destroy(),M("unloaded"!==e)},this.publish=function(e,n,i){if("function"==typeof e&&(i=e,e=void 0),"function"==typeof n&&(i=n,n=void 0),this.isNot("connected"))return t.analytics.logError(1010,"OT.exception","We need to be connected before you can publish",null,{action:"Publish",variation:"Failure",payload:{reason:"unconnected",code:t.ExceptionCodes.NOT_CONNECTED,message:"We need to be connected before you can publish"},sessionId:D,streamId:e&&e.stream?e.stream.id:null,partnerId:A}),i&&t.$.isFunction(i)&&R(t.ExceptionCodes.NOT_CONNECTED,"We need to be connected before you can publish",i),null;if(!C("publish")){var o="This token does not allow publishing. The role must be at least `publisher` to enable this functionality",r={reason:"permission",code:t.ExceptionCodes.UNABLE_TO_PUBLISH,message:o};return this.logEvent("publish","Failure",r),R(t.ExceptionCodes.UNABLE_TO_PUBLISH,o,i),null}if(!e||"string"==typeof e||t.$.isElementNode(e))e=t.initPublisher(e,n);else{if(!(e instanceof t.Publisher))return void R(t.ExceptionCodes.UNABLE_TO_PUBLISH,"Session.publish :: First parameter passed in is neither a string nor an instance of the Publisher",i);"session"in e&&e.session&&"sessionId"in e.session&&t.warn(e.session.sessionId===this.sessionId?"Cannot publish "+e.guid()+" again to "+this.sessionId+". Please call session.unpublish(publisher) first.":"Cannot publish "+e.guid()+" publisher already attached to "+e.session.sessionId+". Please call session.unpublish(publisher) first.")}return e.once("publishComplete",function(e){return e?void R(t.ExceptionCodes.UNABLE_TO_PUBLISH,"Session.publish :: "+e.message,i):void(i&&t.$.isFunction(i)&&i.apply(null,arguments))}),e._.publishToSession(this),e},this.unpublish=function(e){return e?void e._.unpublishFromSession(this,"unpublished"):void t.error("OT.Session.unpublish: publisher parameter missing.")},this.subscribe=function(e,n,i,o){if(!this.connection||!this.connection.connectionId)return void R(t.ExceptionCodes.UNABLE_TO_SUBSCRIBE,"Session.subscribe :: Connection required to subscribe",o);if(!e)return void R(t.ExceptionCodes.UNABLE_TO_SUBSCRIBE,"Session.subscribe :: stream cannot be null",o);if(!e.hasOwnProperty("streamId"))return void R(t.ExceptionCodes.UNABLE_TO_SUBSCRIBE,"Session.subscribe :: invalid stream object",o);"function"==typeof n&&(o=n,n=void 0,i=void 0),"function"==typeof i&&(o=i,i=void 0);var r=new t.Subscriber(n,t.$.extend(i||{},{stream:e,session:this}),function(e){e?R(t.ExceptionCodes.UNABLE_TO_SUBSCRIBE,"Session.subscribe :: "+e.message,o):o&&t.$.isFunction(o)&&o.apply(null,arguments)});return t.subscribers.add(r),r},this.unsubscribe=function(e){if(!e){var n="OT.Session.unsubscribe: subscriber cannot be null";throw t.error(n),new Error(n)}return e.stream?(t.debug("OT.Session.unsubscribe: subscriber "+e.id),e.destroy(),!0):(t.warn("OT.Session.unsubscribe:: tried to unsubscribe a subscriber that had no stream"),!1)},this.getSubscribersForStream=function(e){return t.subscribers.where({streamId:e.id})},this.getPublisherForStream=function(e){var n,i;if("string"==typeof e)n=e;else{if("object"!=typeof e||!e||!e.hasOwnProperty("id"))throw i="Session.getPublisherForStream :: Invalid stream type",t.error(i),new Error(i);n=e.id}return t.publishers.where({streamId:n})[0]},this._={jsepCandidateP2p:function(e,t,n){return r.jsepCandidateP2p(e,t,n)},jsepCandidate:function(e,t){return r.jsepCandidate(e,t)},jsepOffer:function(e,t){return r.jsepOffer(e,t)},jsepOfferP2p:function(e,t,n){return r.jsepOfferP2p(e,t,n)},jsepAnswer:function(e,t){return r.jsepAnswer(e,t)},jsepAnswerP2p:function(e,t,n){return r.jsepAnswerP2p(e,t,n)},dispatchSignal:t.$.bind(function(e,n,i){var o=new t.SignalEvent(n,i,e);o.target=this,this.trigger(t.Event.names.SIGNAL,o),n&&this.dispatchEvent(o)},this),subscriberCreate:function(e,t,n,i){return r.subscriberCreate(e.id,t.widgetId,n,i)},subscriberDestroy:function(e,t){return r.subscriberDestroy(e.id,t.widgetId)},subscriberUpdate:function(e,t,n){return r.subscriberUpdate(e.id,t.widgetId,n)},subscriberChannelUpdate:function(e,t,n,i){return r.subscriberChannelUpdate(e.id,t.widgetId,n.id,i)},streamCreate:function(e,n,i,o,s){r.streamCreate(e,n,i,o,t.Config.get("bitrates","min",t.APIKEY),t.Config.get("bitrates","max",t.APIKEY),s)},streamDestroy:function(e){r.streamDestroy(e)},streamChannelUpdate:function(e,t,n){r.streamChannelUpdate(e.id,t.id,n)}},this.signal=function(e,n){var i=e,o=n;if(t.$.isFunction(i)&&(o=i,i=null),this.isNot("connected")){var s="Unable to send signal - you are not connected to the session.";return void R(500,s,o)}r.signal(i,o,this.logEvent),e&&e.data&&"string"!=typeof e.data&&t.warn("Signaling of anything other than Strings is deprecated. Please update the data property to be a string.")},this.forceDisconnect=function(e,n){if(this.isNot("connected")){var i="Cannot call forceDisconnect(). You are not connected to the session.";return void R(t.ExceptionCodes.NOT_CONNECTED,i,n)}var o="This token does not allow forceDisconnect. The role must be at least `moderator` to enable this functionality";if(C("forceDisconnect")){var s="string"==typeof e?e:e.id;r.forceDisconnect(s,function(e){e?R(t.ExceptionCodes.UNABLE_TO_FORCE_DISCONNECT,o,n):n&&t.$.isFunction(n)&&n.apply(null,arguments)})}else R(t.ExceptionCodes.UNABLE_TO_FORCE_DISCONNECT,o,n)},this.forceUnpublish=function(e,n){if(this.isNot("connected")){var i="Cannot call forceUnpublish(). You are not connected to the session.";return void R(t.ExceptionCodes.NOT_CONNECTED,i,n)}var o="This token does not allow forceUnpublish. The role must be at least `moderator` to enable this functionality";if(C("forceUnpublish")){var s="string"==typeof e?this.streams.get(e):e;r.forceUnpublish(s.id,function(e){e?R(t.ExceptionCodes.UNABLE_TO_FORCE_UNPUBLISH,o,n):n&&t.$.isFunction(n)&&n.apply(null,arguments)})}else R(t.ExceptionCodes.UNABLE_TO_FORCE_UNPUBLISH,o,n)},this.getStateManager=function(){t.warn("Fixme: Have not implemented session.getStateManager")},this.isConnected=function(){return this.is("connected")},this.capabilities=new t.Capabilities([])};var k={audio:!0,video:!0};t.Publisher=function(n){if(!t.checkSystemRequirements())return void t.upgradeSystemRequirements();var i,o,r,s,a,c,u,d,l,h,f,p,m,g,v,b,y,E,S=t.Publisher.nextId(),T={},w=!1,C=[1,7,15,30],O=t.$.hasCapabilities("webAudio"),R=n&&("screen"===n.videoSource||"window"===n.videoSource||"tab"===n.videoSource||"application"===n.videoSource),I=this;if(p=t.$.defaults(n||{},{publishAudio:R?!1:!0,publishVideo:!0,mirror:R?!1:!0,showControls:!0,fitMode:R?"contain":"cover",audioFallbackEnabled:R?!1:!0,maxResolution:R?{width:1920,height:1920}:void 0}),m={"320x240":{width:320,height:240},"640x480":{width:640,height:480},"1280x720":{width:1280,height:720}},R&&"https:"!==e.location.protocol&&t.warn("Screen Sharing typically requires pages to be loadever over HTTPS - unless this browser is configured locally to allow non-SSL pages, permission will be denied without user input."),g={timeStamp:t.$.now()},t.$.eventing(this),!R&&O){y=new t.AnalyserAudioLevelSampler(t.audioContext());var A=new t.IntervalRunner(function(){y.sample(function(e){t.$.requestAnimationFrame(function(){I.dispatchEvent(new t.AudioLevelUpdatedEvent(e))})})},60);this.on({"audioLevelUpdated:added":function(e){1===e&&A.start()},"audioLevelUpdated:removed":function(e){0===e&&A.stop()}})}var P=function(e,n,i,o){t.analytics.logEvent({action:e,variation:n,payload:i,sessionId:u?u.sessionId:null,connectionId:u&&u.isConnected()?u.connection.connectionId:null,partnerId:u?u.apiKey:t.APIKEY,streamId:a},o)},D=function(e,n){"Attempt"!==e&&E||(E=new t.ConnectivityAttemptPinger({action:"Publish",sessionId:u?u.sessionId:null,connectionId:u&&u.isConnected()?u.connection.connectionId:null,partnerId:u?u.apiKey:t.APIKEY,streamId:a})),"Failure"===e&&"Non-fatal"!==n.reason&&E.setVariation(e),P("Publish",e,n)},N=t.$.bind(function(e,n){var i={streamType:"WebRTC",sessionId:u?u.sessionId:null,connectionId:u&&u.isConnected()?u.connection.connectionId:null,partnerId:u?u.apiKey:t.APIKEY,streamId:a,width:o?Number(t.$.width(o.domElement).replace("px","")):void 0,height:o?Number(t.$.height(o.domElement).replace("px","")):void 0,version:t.properties.version,mediaServerName:u?u.sessionInfo.messagingServer:null,p2pFlag:u?u.sessionInfo.p2pEnabled:!1,duration:d?(new Date).getTime()-d.getTime():0,remoteConnectionId:e.id};t.analytics.logQOS(t.$.extend(i,n)),this.trigger("qos",n)},this),_=function(e){t.error("Publisher State Change Failed: ",e.message),t.debug(e)},$=t.$.bind(function(){v.isDestroyed()||(t.debug("OT.Publisher.onLoaded"),v.set("MediaBound"),o.loading(this.session?!s:!1),w=!0,J.call(this),this.trigger("initSuccess"),this.trigger("loaded",this))},this),M=t.$.bind(function(e){var n=t.ExceptionCodes.P2P_CONNECTION_FAILED,i={reason:"Publisher PeerConnection Error: ",code:n,message:e};D("Failure",i),v.set("Failed"),this.trigger("publishComplete",new t.Error(n,"Publisher PeerConnection Error: "+e)),t.handleJsException("Publisher PeerConnection Error: "+e,t.ExceptionCodes.P2P_CONNECTION_FAILED,{session:u,target:this})},this),L=t.$.bind(function(e){t.debug("OT.Publisher.onStreamAvailable"),v.set("BindingMedia"),G(),c=e,l=new t.Microphone(c,!p.publishAudio),this.publishVideo(p.publishVideo&&c.getVideoTracks().length>0),this.accessAllowed=!0,this.dispatchEvent(new t.Event(t.Event.names.ACCESS_ALLOWED,!1));var n={muted:!0,error:H};r=o.bindVideo(c,n,function(e){return e?void M(e):void $()}),y&&c.getAudioTracks().length>0&&(y.webRTCStream=c)},this),x=t.$.bind(function(e){t.error("OT.Publisher.onStreamAvailableError "+e.name+": "+e.message),v.set("Failed"),this.trigger("publishComplete",new t.Error(t.ExceptionCodes.UNABLE_TO_PUBLISH,e.message)),o&&o.destroy();var n={reason:"GetUserMedia",code:t.ExceptionCodes.UNABLE_TO_PUBLISH,message:"Publisher failed to access camera/mic: "+e.message};D("Failure",n),t.handleJsException(n.reason,n.code,{session:u,target:this})},this),U=t.$.bind(function(e){t.error("OT.Publisher.onScreenSharingError "+e.message),v.set("Failed"),this.trigger("publishComplete",new t.Error(t.ExceptionCodes.UNABLE_TO_PUBLISH,"Screensharing: "+e.message));var n={reason:"ScreenSharing",message:e.message};D("Failure",n)},this),F=t.$.bind(function(e){t.error("OT.Publisher.onStreamAvailableError Permission Denied"),v.set("Failed");var n="Publisher Access Denied: Permission Denied"+(e.message?": "+e.message:""),i=t.ExceptionCodes.UNABLE_TO_PUBLISH;this.trigger("publishComplete",new t.Error(i,n));var o={reason:"GetUserMedia",code:i,message:n};D("Failure",o),this.dispatchEvent(new t.Event(t.Event.names.ACCESS_DENIED))},this),V=t.$.bind(function(){P("accessDialog","Opened"),this.dispatchEvent(new t.Event(t.Event.names.ACCESS_DIALOG_OPENED,!0))},this),B=t.$.bind(function(){P("accessDialog","Closed"),this.dispatchEvent(new t.Event(t.Event.names.ACCESS_DIALOG_CLOSED,!1))},this),H=t.$.bind(function(e,n){t.error("OT.Publisher.onVideoError");var i=n+(e?" ("+e+")":"");P("stream",null,{reason:"Publisher while playing stream: "+i}),v.set("Failed"),v.isAttemptingToPublish()?this.trigger("publishComplete",new t.Error(t.ExceptionCodes.UNABLE_TO_PUBLISH,i)):this.trigger("error",i),t.handleJsException("Publisher error playing stream: "+i,t.ExceptionCodes.UNABLE_TO_PUBLISH,{session:u,target:this})},this),j=t.$.bind(function(e){t.debug("OT.Subscriber has been disconnected from the Publisher's PeerConnection"),this.cleanupSubscriber(e.remoteConnection().id)},this),W=t.$.bind(function(e,n,i,o){var r={reason:o?o:"PeerConnectionError",code:t.ExceptionCodes.UNABLE_TO_PUBLISH,message:(o?o:"")+":Publisher PeerConnection with connection "+(i&&i.remoteConnection&&i.remoteConnection().id)+" failed: "+n,hasRelayCandidates:i.hasRelayCandidates()};v.isPublishing()&&(r.reason="Non-fatal"),D("Failure",r),t.handleJsException("Publisher PeerConnection Error: "+n,t.ExceptionCodes.UNABLE_TO_PUBLISH,{session:u,target:this}),delete T[i.remoteConnection().id]},this),q=t.$.bind(function(e){this.stream=s=e,s.on("destroyed",this.disconnect,this),v.set("Publishing"),o.loading(!w),d=new Date,this.trigger("publishComplete",null,this),this.dispatchEvent(new t.StreamEvent("streamCreated",e,null,!1));var n={streamType:"WebRTC"};D("Success",n)},this),G=function(){c&&(c.stop(),c=null)},z=t.$.bind(function(e){var n=T[e.id];if(!n){var i=t.$.now();P("createPeerConnection","Attempt"),e.on("destroyed",t.$.bind(this.cleanupSubscriber,this,e.id)),n=T[e.id]=new t.PublisherPeerConnection(e,u,a,c),n.on({connected:function(){var e={pcc:parseInt(t.$.now()-i,10),hasRelayCandidates:n.hasRelayCandidates()};P("createPeerConnection","Success",e)},disconnected:j,error:W,qos:N},this),n.init(b)}return n},this),Y=function(e){if(e===!1)return"off";var t=this.getStyle("buttonDisplayMode");return t===!1?"on":t},K=function(e,t){if(h)switch(e){case"nameDisplayMode":h.name.setDisplayMode(t),h.backingBar.setNameMode(t);break;case"showArchiveStatus":P("showArchiveStatus","styleChange",{mode:t?"on":"off"}),h.archive.setShowArchiveStatus(t);break;case"buttonDisplayMode":h.muteButton.setDisplayMode(t),h.backingBar.setMuteMode(t);break;case"audioLevelDisplayMode":h.audioLevel.setDisplayMode(t);break;case"backgroundImageURI":o.setBackgroundImageURI(t)}},J=function(){this.getStyle("showArchiveStatus")||P("showArchiveStatus","createChrome",{mode:"off"});var e={backingBar:new t.Chrome.BackingBar({nameMode:p.name?this.getStyle("nameDisplayMode"):"off",muteMode:Y.call(this,this.getStyle("buttonDisplayMode"))}),name:new t.Chrome.NamePanel({name:p.name,mode:this.getStyle("nameDisplayMode")}),muteButton:new t.Chrome.MuteButton({muted:p.publishAudio===!1,mode:Y.call(this,this.getStyle("buttonDisplayMode"))}),archive:new t.Chrome.Archiving({show:this.getStyle("showArchiveStatus"),archiving:!1})};if(O){var n=new t.AudioLevelTransformer,i=function(e){f.setValue(n.transform(e.audioLevel))};f=new t.Chrome.AudioLevelMeter({mode:this.getStyle("audioLevelDisplayMode"),onActivate:function(){I.on("audioLevelUpdated",i)},onPassivate:function(){I.off("audioLevelUpdated",i)}}),e.audioLevel=f}h=new t.Chrome({parent:o.domElement}).set(e).on({muted:t.$.bind(this.publishAudio,this,!1),unmuted:t.$.bind(this.publishAudio,this,!0)}),f&&"auto"===this.getStyle("audioLevelDisplayMode")&&f[o.audioOnly()?"show":"hide"]()},Q=t.$.bind(function(){h&&(h.destroy(),h=null),this.disconnect(),l=null,r&&(r.destroy(),r=null),G(),o&&(o.destroy(),o=null),u&&this._.unpublishFromSession(u,"reset"),this.id=i=null,this.stream=s=null,w=!1,this.session=u=null,v.isDestroyed()||v.set("NotPublishing")},this);t.StylableComponent(this,{showArchiveStatus:!0,nameDisplayMode:"auto",buttonDisplayMode:"auto",audioLevelDisplayMode:R?"off":"auto",backgroundImageURI:null},p.showControls,function(e){P("SetStyle","Publisher",e,.1)});var X=function(e){o&&(o.audioOnly(e),o.showPoster(e)),f&&"auto"===I.getStyle("audioLevelDisplayMode")&&f[e?"show":"hide"]()};this.publish=function(e){if(t.debug("OT.Publisher: publish"),(v.isAttemptingToPublish()||v.isPublishing())&&Q(),v.set("GetUserMedia"),p.constraints)t.warn("You have passed your own constraints not using ours");else if(p.constraints=t.$.clone(k),R&&(null!=p.audioSource&&t.warn("Invalid audioSource passed to Publisher - when using screen sharing no audioSource may be used"),p.audioSource=null),null===p.audioSource||p.audioSource===!1?(p.constraints.audio=!1,p.publishAudio=!1):("object"==typeof p.audioSource&&(null!=p.audioSource.deviceId?p.audioSource=p.audioSource.deviceId:t.warn("Invalid audioSource passed to Publisher. Expected either a device ID")),p.audioSource&&("object"!=typeof p.constraints.audio&&(p.constraints.audio={}),p.constraints.audio.mandatory||(p.constraints.audio.mandatory={}),p.constraints.audio.optional||(p.constraints.audio.optional=[]),p.constraints.audio.mandatory.sourceId=p.audioSource)),null===p.videoSource||p.videoSource===!1)p.constraints.video=!1,p.publishVideo=!1;else{"object"==typeof p.videoSource&&null==p.videoSource.deviceId&&(t.warn("Invalid videoSource passed to Publisher. Expected either a device ID or device."),p.videoSource=null);var r=function(){"object"!=typeof p.constraints.video&&(p.constraints.video={}),p.constraints.video.mandatory||(p.constraints.video.mandatory={}),p.constraints.video.optional||(p.constraints.video.optional=[])};if(p.videoSource){r();var a=p.constraints.video.mandatory;R||(a.sourceId=null!=p.videoSource.deviceId?p.videoSource.deviceId:p.videoSource)}p.resolution&&(m.hasOwnProperty(p.resolution)?(p.videoDimensions=m[p.resolution],r(),"Chrome"===t.$.env.name&&(p.constraints.video.optional=p.constraints.video.optional.concat([{minWidth:p.videoDimensions.width},{maxWidth:p.videoDimensions.width},{minHeight:p.videoDimensions.height},{maxHeight:p.videoDimensions.height}]))):t.warn("Invalid resolution passed to the Publisher. Got: "+p.resolution+' expecting one of "'+t.$.keys(m).join('","')+'"')),p.maxResolution&&(r(),p.maxResolution.width>1920&&(t.warn("Invalid maxResolution passed to the Publisher. maxResolution.width must be less than or equal to 1920"),p.maxResolution.width=1920),p.maxResolution.height>1920&&(t.warn("Invalid maxResolution passed to the Publisher. maxResolution.height must be less than or equal to 1920"),p.maxResolution.height=1920),p.videoDimensions=p.maxResolution,"Chrome"===t.$.env.name&&(r(),p.constraints.video.mandatory.maxWidth=p.videoDimensions.width,p.constraints.video.mandatory.maxHeight=p.videoDimensions.height)),void 0!==p.frameRate&&-1===t.$.arrayIndexOf(C,p.frameRate)?(t.warn("Invalid frameRate passed to the publisher got: "+p.frameRate+" expecting one of "+C.join(",")),delete p.frameRate):p.frameRate&&(r(),p.constraints.video.optional=p.constraints.video.optional.concat([{minFrameRate:p.frameRate},{maxFrameRate:p.frameRate}]))}return p.style&&this.setStyle(p.style,null,!0),p.name&&(p.name=p.name.toString()),p.classNames="OT_root OT_publisher",t.onLoad(function(){o=new t.WidgetView(e,p),I.id=i=o.domId(),I.element=o.domElement,o.on("videoDimensionsChanged",function(e,n){s&&s.setVideoDimensions(n.width,n.height),I.dispatchEvent(new t.VideoDimensionsChangedEvent(I,e,n))}),o.on("mediaStopped",function(){var e=new t.MediaStoppedEvent(I);I.dispatchEvent(e,function(){e.isDefaultPrevented()||(u?I._.unpublishFromSession(u,"mediaStopped"):I.destroy("mediaStopped"))})}),t.$.waterfall([function(e){R?t.checkScreenSharingCapability(function(i){if(i.supported)if(i.extensionRegistered===!1)U(new Error("Screen Sharing suppor in this browser requires an extension, but one has not been registered."));else if(i.extensionInstalled===!1)U(new Error("Screen Sharing suppor in this browser requires an extension, but the extension is not installed."));else{var o=t.pickScreenSharingHelper();o.proto.getConstraintsShowsPermissionUI&&V(),o.instance.getConstraints(n.videoSource,p.constraints,function(t,n){o.proto.getConstraintsShowsPermissionUI&&B(),t?"PermissionDeniedError"===t.message?F(t):U(t):(p.constraints=n,e())})}else U(new Error("Screen Sharing is not supported in this browser"))}):t.$.shouldAskForDevices(function(n){n.video||(t.warn("Setting video constraint to false, there are no video sources"),p.constraints.video=!1),n.audio||(t.warn("Setting audio constraint to false, there are no audio sources"),p.constraints.audio=!1),e()})},function(){v.isDestroyed()||t.$.getUserMedia(p.constraints,L,x,V,B,F)}])},this),this},this.publishAudio=function(e){return p.publishAudio=e,l&&l.muted(!e),h&&h.muteButton.muted(!e),u&&s&&s.setChannelActiveState("audio",e),this},this.publishVideo=function(e){var t=p.publishVideo;if(p.publishVideo=e,u&&s&&p.publishVideo!==t&&s.setChannelActiveState("video",e),c)for(var n=c.getVideoTracks(),i=0,o=n.length;o>i;++i)n[i].setEnabled(e);return X(!e),this},this.destroy=function(e,n){return v.isDestroyed()?void 0:(v.set("Destroyed"),Q(),n!==!0&&this.dispatchEvent(new t.DestroyedEvent(t.Event.names.PUBLISHER_DESTROYED,this,e),t.$.bind(this.off,this)),this)},this.disconnect=function(){for(var e in T)this.cleanupSubscriber(e)},this.cleanupSubscriber=function(e){var t=T[e];t&&(t.destroy(),delete T[e],P("disconnect","PeerConnection",{subscriberConnection:e}))},this.processMessage=function(e,n,i){switch(t.debug("OT.Publisher.processMessage: Received "+e+" from "+n.id),t.debug(i),e){case"unsubscribe":this.cleanupSubscriber(i.content.connection.id);break;default:var o=z(n);o.processMessage(e,i)}},this.getImgData=function(){return w?r.imgData():(t.error("OT.Publisher.getImgData: Cannot getImgData before the Publisher is publishing."),null)},this._={publishToSession:t.$.bind(function(e){this.session=u=e,a=t.$.uuid();var n=function(){var n,i;if(u){v.set("PublishingToSession");var o=t.$.bind(function(e,n,i){if(e){var o=t.ExceptionCodes.UNABLE_TO_PUBLISH,r={reason:"Publish",code:o,message:e.message};return D("Failure",r),void(v.isAttemptingToPublish()&&this.trigger("publishComplete",new t.Error(o,e.message)))}this.streamId=a=n,b=t.Raptor.parseIceServers(i)},this);p.videoDimensions?(n=Math.min(p.videoDimensions.width,r.videoWidth()||640),i=Math.min(p.videoDimensions.height,r.videoHeight()||480)):(n=r.videoWidth()||640,i=r.videoHeight()||480);var s=[];null!==p.videoSource&&p.videoSource!==!1&&s.push(new t.StreamChannel({id:"video1",type:"video",active:p.publishVideo,orientation:t.VideoOrientation.ROTATED_NORMAL,frameRate:p.frameRate,width:n,height:i,source:R?"screen":"camera",fitMode:p.fitMode})),null!==p.audioSource&&p.audioSource!==!1&&s.push(new t.StreamChannel({id:"audio1",type:"audio",active:p.publishAudio})),e._.streamCreate(p.name||"",a,p.audioFallbackEnabled,s,o)}};return w?n.call(this):this.on("initSuccess",n,this),D("Attempt",{streamType:"WebRTC"}),this},this),unpublishFromSession:t.$.bind(function(e,n){return u&&e.id===u.id?(e.isConnected()&&this.stream&&e._.streamDestroy(this.stream.id),this.disconnect(),this.session=u=null,v.isDestroyed()||v.set("MediaBound"),E&&E.stop(),P("unpublish","Success",{sessionId:e.id}),this._.streamDestroyed(n),this):(t.warn("The publisher "+S+" is trying to unpublish from a session "+e.id+" it is not attached to (it is attached to "+(u&&u.id||"no session")+")"),this)},this),streamDestroyed:t.$.bind(function(e){if(t.$.arrayIndexOf(["reset"],e)<0){var n=new t.StreamEvent("streamDestroyed",s,e,!0),i=t.$.bind(function(){n.isDefaultPrevented()||this.destroy()},this);this.dispatchEvent(n,i)}},this),archivingStatus:t.$.bind(function(e){return h&&h.archive.setArchiving(e),e},this),webRtcStream:function(){return c}},this.detectDevices=function(){t.warn("Fixme: Haven't implemented detectDevices")},this.detectMicActivity=function(){t.warn("Fixme: Haven't implemented detectMicActivity")},this.getEchoCancellationMode=function(){return t.warn("Fixme: Haven't implemented getEchoCancellationMode"),"fullDuplex"},this.setMicrophoneGain=function(){t.warn("Fixme: Haven't implemented setMicrophoneGain")},this.getMicrophoneGain=function(){return t.warn("Fixme: Haven't implemented getMicrophoneGain"),.5},this.setCamera=function(){t.warn("Fixme: Haven't implemented setCamera")},this.setMicrophone=function(){t.warn("Fixme: Haven't implemented setMicrophone")},this.guid=function(){return S},this.videoElement=function(){return r.domElement()},this.setStream=q,this.isWebRTC=!0,this.isLoading=function(){return o&&o.loading()},this.videoWidth=function(){return r.videoWidth()},this.videoHeight=function(){return r.videoHeight()},this.on("styleValueChanged",K,this),v=new t.PublishingState(_),this.accessAllowed=!1},t.Publisher.nextId=t.$.uuid,t.initSession=function(e,n){null==n&&(n=e,e=null);var i=t.sessions.get(n);return i||(i=new t.Session(e,n),t.sessions.add(i)),i},t.initPublisher=function(e,n,i){t.debug("OT.initPublisher("+e+")"),null==e||t.$.isElementNode(e)||"string"==typeof e&&document.getElementById(e)||"function"==typeof e||(e=n,n=i,i=arguments[3]),"function"==typeof e&&(i=e,n=void 0,e=void 0),"function"==typeof n&&(i=n,n=void 0);var o=new t.Publisher(n);t.publishers.add(o);var r=function(e){e?t.dispatchError(e.code,e.message,i,o.session):i&&t.$.isFunction(i)&&i.apply(null,arguments)},s=function(e){o.off("publishComplete",a),r(e)},a=function(e){o.off("initSuccess",s),e&&r(e)};return o.once("initSuccess",s),o.once("publishComplete",a),o.publish(e),o},t.getDevices=function(e){t.$.getMediaDevices(e)},t.reportIssue=function(){t.warn("ToDo: haven't yet implemented OT.reportIssue")},t.components={},t.onUnload(function(){t.publishers.destroy(),t.subscribers.destroy(),t.sessions.destroy("unloaded")}),A(t.properties.cssURL),"function"==typeof define&&define.amd&&define("TB",[],function(){return TB})}(e,e.OT)}(window||exports);
